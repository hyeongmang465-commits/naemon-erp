<!DOCTYPE html>
<html lang="ko" id="html-root">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>(ì£¼)ë‚´ëª¸ì• ë§ê²Œ ERP</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Supabase ì„¤ì •
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SUPA_URL = 'https://xmybeykosuizaeozlqqn.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhteWJleWtvc3VpemFlb3pscXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDUyNjgsImV4cCI6MjA4NzcyMTI2OH0.VqmteK_k0mUZsa_o9ilRnm3SX00gyGGQgFLN-t_rEEM';
const supa = supabase.createClient(SUPA_URL, SUPA_KEY);

/* â”€â”€ DB í—¬í¼: ì—ëŸ¬ ë¡œê¹… â”€â”€ */
function dbErr(label, error){
  console.error('[DBì˜¤ë¥˜] ' + label + ':', error?.message || error);
  toast('âŒ ì €ì¥ ì˜¤ë¥˜: ' + (error?.message || 'ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”'));
}

/* â”€â”€ ì „í™”ë²ˆí˜¸ ìë™ í¬ë§· â”€â”€ */
function fmtPhone(el){
  let v = el.value.replace(/[^0-9]/g,'');
  if(v.length <= 3) el.value = v;
  else if(v.length <= 7) el.value = v.slice(0,3)+'-'+v.slice(3);
  else el.value = v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7,11);
}

</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700;800&family=Noto+Sans+KR:wght@400;500;600;700&display=swap');

:root {
  --pd:#1E0642; --pm:#3A0D72; --p2:#5A1FA0; --p3:#7B3FC0; --p4:#A070D8; --p5:#EDE0FF;
  --gd:#A07810; --gm:#D4A820; --gb:#FFD700;
  --bg:#F4F0FB; --card:#FFFFFF;
  --text:#1A0535; --text2:#5A3A80; --text3:#9A7ABB;
  --border:rgba(90,31,160,0.13);
  --red:#E53935; --orange:#F57C00; --green:#2E7D32;
  --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{ margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{ width:100%; background:var(--bg); font-family:'Noto Sans KR',sans-serif; color:var(--text); min-height:100vh; overflow-x:hidden; }

/* â•â•â•â• ë¡œê·¸ì¸ í™”ë©´ â•â•â•â• */
.login-screen{
  position:fixed; inset:0; z-index:500;
  background:linear-gradient(160deg,var(--pd) 0%,var(--pm) 50%,var(--p2) 100%);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:40px 28px;
  max-width:430px; margin:0 auto; left:50%; transform:translateX(-50%);
}
.login-screen::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 70% 40% at 20% 90%,rgba(212,168,32,0.12) 0%,transparent 60%),
             radial-gradient(ellipse 50% 50% at 85% 10%,rgba(155,89,208,0.2) 0%,transparent 60%);
}
.login-inner{ position:relative; z-index:2; width:100%; max-width:340px; }
.login-logo{ text-align:center; margin-bottom:36px; }
.login-logo .icon{
  width:72px; height:72px; margin:0 auto 14px;
  background:linear-gradient(135deg,var(--gd),var(--gb));
  border-radius:20px; display:flex; align-items:center; justify-content:center;
  font-size:36px; box-shadow:0 0 30px rgba(212,168,32,0.45);
}
.login-logo .co-name{ font-family:'Nanum Myeongjo',serif; font-size:1.3rem; font-weight:800; color:var(--gb); }
.login-logo .co-sub{ font-size:.72rem; color:rgba(255,255,255,0.5); margin-top:3px; letter-spacing:.1em; }

.login-card{
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:20px; padding:28px 24px;
  backdrop-filter:blur(12px);
}
.login-card h2{ font-family:'Nanum Myeongjo',serif; font-size:1.1rem; color:white; margin-bottom:6px; }
.login-card p{ font-size:.75rem; color:rgba(255,255,255,0.55); margin-bottom:22px; }

.login-input{
  width:100%; padding:12px 16px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:12px; color:white; font-size:.9rem;
  font-family:'Noto Sans KR',sans-serif; outline:none;
  margin-bottom:12px; transition:border-color .2s;
}
.login-input::placeholder{ color:rgba(255,255,255,0.4); }
.login-input:focus{ border-color:var(--gb); background:rgba(255,255,255,0.15); }

.login-btn{
  width:100%; padding:13px;
  background:linear-gradient(135deg,var(--gd),var(--gm));
  color:var(--pd); border:none; border-radius:12px;
  font-size:.95rem; font-weight:800; cursor:pointer;
  font-family:'Noto Sans KR',sans-serif; margin-top:4px;
  transition:opacity .2s; letter-spacing:.03em;
}
.login-btn:active{ opacity:.85; }
.login-error{
  display:none; background:rgba(229,57,53,0.2); border:1px solid rgba(229,57,53,0.4);
  border-radius:10px; padding:10px 14px; font-size:.8rem; color:#FFAAAA;
  margin-top:12px; text-align:center;
}

/* ë¹ ë¥¸ ë¡œê·¸ì¸ ë²„íŠ¼ */
.quick-login{ margin-top:20px; }
.quick-login p{ font-size:.72rem; color:rgba(255,255,255,0.4); text-align:center; margin-bottom:10px; }
.quick-logins{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.ql-btn{
  background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.18);
  border-radius:20px; padding:6px 14px; font-size:.72rem; color:rgba(255,255,255,0.7);
  cursor:pointer; font-family:'Noto Sans KR',sans-serif; transition:all .2s;
}
.ql-btn:active{ background:rgba(212,168,32,0.2); color:var(--gb); }
.ql-btn.admin-btn{ border-color:rgba(212,168,32,0.4); color:var(--gb); background:rgba(212,168,32,0.1); }

/* â•â•â•â• ì•± ë©”ì¸ â•â•â•â• */
.app{ display:none; }
.app.show{ display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í—¤ë” â€” 2ë‹¨ êµ¬ì¡°
   1í–‰: ë¡œê³  + ìœ ì €ì¹© + ì•Œë¦¼
   2í–‰: ë·°ëª¨ë“œíƒ­ + ì–¸ì–´íƒ­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  width:100%; max-width:430px; z-index:100;
  background:linear-gradient(135deg,var(--pd),var(--pm));
  padding:10px 14px 0; box-shadow:0 2px 16px rgba(0,0,0,0.25);
}

/* â”€â”€ 1í–‰: ë¡œê³  + ìš°ì¸¡ ì•¡ì…˜ â”€â”€ */
.header-row{
  display:flex; align-items:center;
  justify-content:space-between; gap:8px;
  padding-bottom:8px;
}
.header-logo{ display:flex; align-items:center; gap:8px; flex-shrink:0; }
.logo-icon{
  width:30px; height:30px;
  background:linear-gradient(135deg,var(--gd),var(--gb));
  border-radius:8px; display:flex; align-items:center;
  justify-content:center; font-size:15px;
  box-shadow:0 0 10px rgba(212,168,32,0.4); flex-shrink:0;
}
.logo-name{
  font-family:'Nanum Myeongjo',serif;
  font-size:.88rem; font-weight:800; color:var(--gb);
  white-space:nowrap;
}
.logo-sub{ font-size:.52rem; color:rgba(255,255,255,0.4); letter-spacing:.08em; }

.header-right{
  display:flex; align-items:center; gap:6px; flex-shrink:0;
}
.hbtn{
  width:30px; height:30px;
  background:rgba(255,255,255,0.1); border-radius:9px;
  border:1px solid rgba(255,255,255,0.15);
  display:flex; align-items:center; justify-content:center;
  font-size:.85rem; cursor:pointer; position:relative; flex-shrink:0;
}
.hbtn .dot{
  position:absolute; top:4px; right:4px;
  width:7px; height:7px; background:var(--red);
  border-radius:50%; border:1.5px solid var(--pm);
}

/* â”€â”€ ìœ ì € ì¹© â”€â”€ */
.user-chip{
  display:flex; align-items:center; gap:5px;
  background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.18);
  border-radius:18px; padding:3px 9px 3px 4px; cursor:pointer; flex-shrink:0;
}
.uc-avatar{
  width:22px; height:22px; border-radius:50%;
  background:linear-gradient(135deg,var(--gd),var(--gb));
  display:flex; align-items:center; justify-content:center;
  font-size:.65rem; font-weight:800; color:var(--pd); flex-shrink:0;
}
.uc-name{
  font-size:.65rem; color:rgba(255,255,255,0.9);
  font-weight:700; max-width:48px;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.uc-role{ font-size:.5rem; color:rgba(212,168,32,0.8); }

/* â”€â”€ 2í–‰: ë·°ëª¨ë“œ + ì–¸ì–´ íƒ­ â”€â”€ */
.header-toolbar{
  display:flex; align-items:center; justify-content:center;
  gap:8px; padding:7px 0 8px;
  border-top:1px solid rgba(255,255,255,0.1);
}

/* ë‚ ì§œ (ë°ìŠ¤í¬íƒ‘ìš©) */
.header-date{
  font-size:.62rem; color:rgba(255,255,255,0.45);
  text-align:center; padding-bottom:6px; display:none;
}

/* â”€â”€ ë³¸ë¬¸/íƒ­ â”€â”€ */
.body-wrap{ 
  padding-top:100px; padding-bottom:calc(70px + var(--safe-bottom));
  max-width:430px; margin:0 auto; /* ëª¨ë°”ì¼: ì¤‘ì•™ 430px */
}
.tabbar{ position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:430px; background:var(--card); border-top:1px solid var(--border); display:flex; box-shadow:0 -4px 20px rgba(90,31,160,0.1); padding-bottom:var(--safe-bottom); z-index:100; }
.tab-item{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:9px 4px 10px; cursor:pointer; position:relative; }
.tab-item.active .tab-icon{ font-size:1.2rem; transform:translateY(-2px); }
.tab-item.active .tab-label{ color:var(--p2); font-weight:700; }
.tab-item.active::after{ content:''; position:absolute; top:0; left:20%; right:20%; height:3px; background:linear-gradient(90deg,var(--p2),var(--p3)); border-radius:0 0 4px 4px; }
.tab-icon{ font-size:1.1rem; transition:transform .2s; }
.tab-label{ font-size:.6rem; color:var(--text3); margin-top:3px; font-weight:500; }
.tab-badge{ position:absolute; top:6px; right:calc(50% - 18px); background:var(--red); color:white; font-size:.55rem; font-weight:700; padding:1px 5px; border-radius:8px; }

.page{ display:none; }
.page.active{ display:block; }

/* â”€â”€ ê³µí†µ â”€â”€ */
.section-title{ font-family:'Nanum Myeongjo',serif; font-size:.88rem; font-weight:800; color:var(--pm); padding:16px 14px 8px; display:flex; align-items:center; justify-content:space-between; }
.more{ font-family:'Noto Sans KR',sans-serif; font-size:.72rem; color:var(--p3); font-weight:500; cursor:pointer; }
.kpi-scroll{ display:flex; gap:10px; padding:0 14px 4px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
.kpi-scroll::-webkit-scrollbar{ display:none; }
.kpi-card{ flex-shrink:0; width:130px; background:var(--card); border-radius:14px; padding:14px; border:1px solid var(--border); box-shadow:0 2px 10px rgba(90,31,160,0.07); position:relative; overflow:hidden; }
.kpi-card::after{ content:''; position:absolute; bottom:0; left:0; right:0; height:3px; }
.kc-purple::after{ background:linear-gradient(90deg,var(--p2),var(--p3)); }
.kc-red::after{ background:linear-gradient(90deg,var(--red),#EF9A9A); }
.kc-gold::after{ background:linear-gradient(90deg,var(--gd),var(--gb)); }
.kc-green::after{ background:linear-gradient(90deg,var(--green),#81C784); }
.kpi-icon{ font-size:1.3rem; margin-bottom:8px; }
.kpi-num{ font-family:'Nanum Myeongjo',serif; font-size:1.6rem; font-weight:800; color:var(--text); line-height:1; margin-bottom:4px; }
.kpi-num.red{ color:var(--red); }
.kpi-label{ font-size:.7rem; color:var(--text3); }
.kpi-trend{ font-size:.65rem; font-weight:700; margin-top:5px; display:inline-block; padding:2px 6px; border-radius:8px; }
.up{ background:rgba(46,125,50,0.1); color:var(--green); } .down{ background:rgba(229,57,53,0.1); color:var(--red); } .neu{ background:rgba(90,31,160,0.08); color:var(--p2); }

.card{ margin:0 14px; background:var(--card); border-radius:16px; border:1px solid var(--border); box-shadow:0 2px 12px rgba(90,31,160,0.06); overflow:hidden; }
.card-head{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.card-head h3{ font-family:'Nanum Myeongjo',serif; font-size:.93rem; font-weight:800; color:var(--pm); }
.card-more{ font-size:.72rem; color:var(--p3); cursor:pointer; }

.dday{ font-size:.7rem; font-weight:800; padding:3px 8px; border-radius:8px; font-family:'Nanum Myeongjo',serif; flex-shrink:0; }
.d0{ background:var(--red); color:white; } .d7{ background:rgba(229,57,53,0.15); color:var(--red); }
.d30{ background:rgba(245,124,0,0.12); color:var(--orange); } .safe{ background:rgba(46,125,50,0.1); color:var(--green); }
.badge{ display:inline-flex; align-items:center; gap:3px; font-size:.62rem; font-weight:700; padding:2px 7px; border-radius:8px; }
.badge::before{ content:''; width:5px; height:5px; border-radius:50%; flex-shrink:0; }
.badge.red{ background:rgba(229,57,53,0.1); color:var(--red); } .badge.red::before{ background:var(--red); }
.badge.orange{ background:rgba(245,124,0,0.1); color:var(--orange); } .badge.orange::before{ background:var(--orange); }
.badge.green{ background:rgba(46,125,50,0.1); color:var(--green); } .badge.green::before{ background:var(--green); }
.depth-chip{ font-size:.65rem; font-weight:700; padding:2px 8px; border-radius:8px; }
.dc-root{ background:rgba(212,168,32,0.15); color:var(--gd); }
.dc-1{ background:rgba(90,31,160,0.1); color:var(--p2); }
.dc-2{ background:rgba(160,112,216,0.1); color:var(--p4); }
.dc-3{ background:rgba(200,159,232,0.12); color:#9B59D0; }
.renew-btn{ width:44px; height:30px; background:linear-gradient(135deg,var(--p2),var(--p3)); border:none; border-radius:8px; color:white; font-size:.68rem; font-weight:700; cursor:pointer; flex-shrink:0; font-family:'Noto Sans KR',sans-serif; }

/* â”€â”€ íšŒì› ì•„ì´í…œ â”€â”€ */
.member-list-item{ display:flex; align-items:center; gap:10px; padding:12px 16px; border-bottom:1px solid rgba(90,31,160,0.06); cursor:pointer; transition:background .15s; }
.member-list-item:last-child{ border-bottom:none; }
.member-list-item:active{ background:rgba(90,31,160,0.03); }
.m-avatar{ width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1rem; font-weight:700; flex-shrink:0; }
.av-gold{ background:rgba(212,168,32,0.15); color:var(--gd); }
.av-red{ background:rgba(229,57,53,0.12); color:var(--red); }
.av-orange{ background:rgba(245,124,0,0.12); color:var(--orange); }
.av-purple{ background:rgba(90,31,160,0.1); color:var(--p2); }
.av-green{ background:rgba(46,125,50,0.1); color:var(--green); }
.m-info{ flex:1; min-width:0; }
.m-name{ font-size:.87rem; font-weight:700; color:var(--text); margin-bottom:2px; }
.m-sub{ font-size:.7rem; color:var(--text3); display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.m-right{ display:flex; flex-direction:column; align-items:flex-end; gap:5px; }
.tree-btn{ font-size:.65rem; font-weight:700; color:var(--p3); background:var(--p5); border:1px solid rgba(90,31,160,0.2); padding:4px 9px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:3px; white-space:nowrap; font-family:'Noto Sans KR',sans-serif; }
.tree-btn:active{ background:var(--p3); color:white; }

.search-box{ margin:0 14px 10px; display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 14px; }
.search-box input{ flex:1; border:none; background:transparent; font-size:.85rem; font-family:'Noto Sans KR',sans-serif; color:var(--text); outline:none; }
.search-box input::placeholder{ color:var(--text3); }

.page-header{ padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; }
.page-header h2{ font-family:'Nanum Myeongjo',serif; font-size:1.05rem; font-weight:800; color:var(--pm); }
.page-header p{ font-size:.72rem; color:var(--text3); margin-top:2px; }

/* â”€â”€ ì¬ê³  â”€â”€ */
.stock-full-item{ padding:12px 16px; border-bottom:1px solid rgba(90,31,160,0.06); }
.stock-full-item:last-child{ border-bottom:none; }
.sfi-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
.sfi-name{ font-size:.85rem; font-weight:600; color:var(--text); }
.sfi-code{ font-size:.65rem; color:var(--text3); font-family:monospace; margin-top:1px; }
.sfi-qty{ font-size:.85rem; font-weight:700; }
.stock-bar-bg{ height:5px; background:rgba(90,31,160,0.1); border-radius:3px; overflow:hidden; }
.stock-bar{ height:100%; border-radius:3px; }
.bar-d{ background:linear-gradient(90deg,var(--red),#EF9A9A); }
.bar-w{ background:linear-gradient(90deg,var(--orange),#FFCC02); }
.bar-o{ background:linear-gradient(90deg,var(--p3),var(--p4)); }

/* â”€â”€ ì•Œë¦¼ â”€â”€ */
.alert-item{ display:flex; align-items:flex-start; gap:10px; padding:13px 16px; border-bottom:1px solid rgba(90,31,160,0.06); }
.alert-item:last-child{ border-bottom:none; }
.alert-item.unread{ background:rgba(229,57,53,0.025); }
.alert-dot{ width:8px; height:8px; border-radius:50%; margin-top:5px; flex-shrink:0; }
.alert-dot.red{ background:var(--red); } .alert-dot.orange{ background:var(--orange); } .alert-dot.gray{ background:#CCC; }
.alert-content{ flex:1; }
.alert-title{ font-size:.82rem; font-weight:600; color:var(--text); margin-bottom:2px; }
.alert-desc{ font-size:.72rem; color:var(--text3); line-height:1.5; }
.alert-time{ font-size:.65rem; color:var(--text3); margin-top:4px; }
.alert-action{ font-size:.72rem; font-weight:700; color:white; background:linear-gradient(135deg,var(--p2),var(--p3)); border:none; padding:5px 10px; border-radius:8px; cursor:pointer; flex-shrink:0; font-family:'Noto Sans KR',sans-serif; }

/* â”€â”€ í™œë™ â”€â”€ */
.activity-item{ display:flex; align-items:flex-start; gap:10px; padding:11px 16px; border-bottom:1px solid rgba(90,31,160,0.06); }
.activity-item:last-child{ border-bottom:none; }
.act-icon{ width:34px; height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:.85rem; flex-shrink:0; }
.ai-in{ background:rgba(212,168,32,0.12); } .ai-out{ background:rgba(90,31,160,0.1); }
.ai-member{ background:rgba(46,125,50,0.1); } .ai-alert{ background:rgba(229,57,53,0.1); }
.act-content{ flex:1; }
.act-main{ font-size:.8rem; color:var(--text); line-height:1.45; }
.act-main strong{ color:var(--pm); }
.act-time{ font-size:.67rem; color:var(--text3); margin-top:2px; }

/* â•â•â•â• íŠ¸ë¦¬ íŒ¨ë„ ì˜¤ë²„ë ˆì´ â•â•â•â• */
.tree-panel-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.5);
  z-index:299;
  opacity:0;
  pointer-events:none;
  transition:opacity .3s;
}
.tree-panel-overlay.show{
  opacity:1;
  pointer-events:auto;
}

/* â•â•â•â• ê°œì¸ íŠ¸ë¦¬ íŒ¨ë„ â•â•â•â• */
.tree-panel{
  position:fixed;
  top:0; right:-100vw;          /* ê¸°ë³¸: í™”ë©´ ì˜¤ë¥¸ìª½ ë°– */
  width:100%; max-width:430px;
  height:100%; height:100dvh;
  background:var(--bg);
  z-index:300;
  transition:right .32s cubic-bezier(.4,0,.2,1);
  overflow-y:auto;
  overflow-x:hidden;
  padding-bottom:calc(20px + var(--safe-bottom));
  box-shadow:-6px 0 30px rgba(0,0,0,0.3);
}
.tree-panel.open{ right:0; }    /* ì—´ë¦´ ë•Œ: í™”ë©´ ì•ˆìœ¼ë¡œ */

/* ê°€ìš´ë° ì •ë ¬ ë³´ì • (max-width ë•Œë¬¸ì—) */
@media(min-width:430px){
  .tree-panel{ right:calc(-100vw + ((100vw - 430px)/2)); }
  .tree-panel.open{ right:calc((100vw - 430px)/2); }
}

.panel-header{
  background:linear-gradient(135deg,var(--pd),var(--pm));
  padding:14px 16px; position:sticky; top:0; z-index:10;
  box-shadow:0 2px 12px rgba(0,0,0,0.2);
}
.panel-header-row{ display:flex; align-items:center; gap:10px; }

/* â† ë’¤ë¡œê°€ê¸° ë²„íŠ¼ â€” í¬ê³  ëª…í™•í•˜ê²Œ */
.back-btn{
  min-width:76px; height:36px;
  background:rgba(255,255,255,0.18);
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.3);
  display:flex; align-items:center; justify-content:center; gap:5px;
  font-size:.8rem; font-weight:700; color:white;
  cursor:pointer; flex-shrink:0;
  font-family:'Noto Sans KR',sans-serif;
  transition:background .15s;
}
.back-btn:active{ background:rgba(255,255,255,0.3); }

/* ğŸ  í™ˆ ë²„íŠ¼ */
.home-btn{
  min-width:50px; height:36px;
  background:rgba(212,168,32,0.2);
  border-radius:10px;
  border:1px solid rgba(212,168,32,0.4);
  display:flex; align-items:center; justify-content:center; gap:4px;
  font-size:.8rem; font-weight:700; color:var(--gb);
  cursor:pointer; flex-shrink:0;
  font-family:'Noto Sans KR',sans-serif;
  transition:background .15s;
}
.home-btn:active{ background:rgba(212,168,32,0.35); }

.panel-title{ font-family:'Nanum Myeongjo',serif; font-size:.95rem; font-weight:800; color:var(--gb); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.panel-sub-title{ font-size:.62rem; color:rgba(255,255,255,0.55); margin-top:1px; }

/* í”„ë¡œí•„ */
.profile-card{ margin:14px 14px 0; background:linear-gradient(135deg,var(--pm),var(--p2)); border-radius:16px; padding:18px; box-shadow:0 4px 20px rgba(58,13,114,0.2); }
.profile-top{ display:flex; align-items:center; gap:14px; margin-bottom:14px; }
.profile-avatar{ width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,var(--gd),var(--gb)); display:flex; align-items:center; justify-content:center; font-size:1.3rem; font-weight:800; color:var(--pd); border:3px solid rgba(255,215,0,0.4); flex-shrink:0; }
.profile-name{ font-family:'Nanum Myeongjo',serif; font-size:1.1rem; font-weight:800; color:white; }
.profile-detail{ font-size:.72rem; color:rgba(255,255,255,0.65); margin-top:3px; }
.profile-stats{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
.ps-item{ background:rgba(255,255,255,0.1); border-radius:10px; padding:10px 8px; text-align:center; }
.ps-num{ font-family:'Nanum Myeongjo',serif; font-size:1.2rem; font-weight:800; color:var(--gb); }
.ps-label{ font-size:.65rem; color:rgba(255,255,255,0.65); margin-top:2px; }

/* ğŸ”’ ì ‘ê·¼ ì°¨ë‹¨ ë°•ìŠ¤ */
.blocked-box{
  margin:14px; background:var(--card); border-radius:16px;
  border:2px dashed rgba(229,57,53,0.3); padding:28px 20px; text-align:center;
}
.blocked-icon{ font-size:2.4rem; margin-bottom:10px; }
.blocked-title{ font-family:'Nanum Myeongjo',serif; font-size:1rem; color:var(--red); font-weight:800; margin-bottom:8px; }
.blocked-desc{ font-size:.8rem; color:var(--text3); line-height:1.7; }

/* íŠ¸ë¦¬ ì¹´ë“œ */
.tree-card{ margin:14px 14px 0; background:var(--card); border-radius:16px; border:1px solid var(--border); overflow:hidden; box-shadow:0 2px 12px rgba(90,31,160,0.06); }
.tree-card-head{ padding:12px 16px 10px; border-bottom:1px solid var(--border); }
.tree-card-head h3{ font-family:'Nanum Myeongjo',serif; font-size:.9rem; font-weight:800; color:var(--pm); }
.tree-legend{ display:flex; gap:7px; margin-top:8px; flex-wrap:wrap; }
.lc{ font-size:.6rem; font-weight:700; padding:3px 8px; border-radius:20px; }
.lc-me{ background:rgba(212,168,32,0.15); color:var(--gd); border:1px solid rgba(212,168,32,0.3); }
.lc-1{ background:rgba(90,31,160,0.1); color:var(--p2); border:1px solid rgba(90,31,160,0.2); }
.lc-2{ background:rgba(160,112,216,0.1); color:var(--p4); border:1px solid rgba(160,112,216,0.2); }
.lc-exp{ background:rgba(229,57,53,0.08); color:var(--red); border:1px dashed rgba(229,57,53,0.3); }
.tree-svg-wrap{ padding:14px; overflow-x:auto; -webkit-overflow-scrolling:touch; background:linear-gradient(180deg,rgba(237,224,255,0.3),transparent); }
.node-detail{ margin:0 16px 14px; background:var(--p5); border-radius:10px; padding:11px 14px; font-size:.78rem; color:var(--text2); line-height:1.7; border:1px solid rgba(90,31,160,0.12); }

/* í•˜ìœ„ íšŒì› ëª©ë¡ */
.sub-section{ margin:14px 14px 0; }
.sub-label{ font-size:.75rem; font-weight:700; color:var(--text3); letter-spacing:.08em; text-transform:uppercase; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.sub-label::after{ content:''; flex:1; height:1px; background:var(--border); }
.sub-card{ background:var(--card); border-radius:12px; border:1px solid var(--border); overflow:hidden; margin-bottom:8px; box-shadow:0 2px 8px rgba(90,31,160,0.05); }
.sub-item{ display:flex; align-items:center; gap:10px; padding:11px 14px; border-bottom:1px solid rgba(90,31,160,0.06); cursor:pointer; transition:background .15s; }
.sub-item:last-child{ border-bottom:none; }
.sub-item:active{ background:rgba(90,31,160,0.04); }
.sub-avatar{ width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.85rem; font-weight:700; flex-shrink:0; }
.sub-info{ flex:1; min-width:0; }
.sub-name{ font-size:.83rem; font-weight:600; color:var(--text); }
.sub-desc{ font-size:.68rem; color:var(--text3); margin-top:1px; }
.sub-right{ display:flex; flex-direction:column; align-items:flex-end; gap:4px; }

/* â”€â”€ ë°”í…€ì‹œíŠ¸ â”€â”€ */
.sheet-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:400; align-items:flex-end; justify-content:center; backdrop-filter:blur(2px); }
.sheet-overlay.show{ display:flex; }
.sheet{ width:100%; max-width:430px; background:var(--card); border-radius:22px 22px 0 0; padding:20px 20px calc(20px + var(--safe-bottom)); animation:sheetUp .3s cubic-bezier(.4,0,.2,1); max-height:88vh; overflow-y:auto; }
@keyframes sheetUp{ from{transform:translateY(100%)} to{transform:none} }
.sheet-handle{ width:40px; height:4px; background:#DDD; border-radius:2px; margin:0 auto 18px; }
.sheet h3{ font-family:'Nanum Myeongjo',serif; font-size:1.1rem; color:var(--pm); margin-bottom:18px; }
.form-label{ font-size:.75rem; font-weight:600; color:var(--text2); margin-bottom:5px; display:block; }
.form-input,.form-select{ width:100%; padding:11px 14px; border:1px solid var(--border); border-radius:10px; font-size:.88rem; font-family:'Noto Sans KR',sans-serif; color:var(--text); background:var(--bg); outline:none; margin-bottom:12px; -webkit-appearance:none; transition:border-color .2s; }
.form-input:focus,.form-select:focus{ border-color:var(--p3); background:white; }
.form-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.btn-full{ width:100%; padding:13px; background:linear-gradient(135deg,var(--p2),var(--p3)); color:white; border:none; border-radius:12px; font-size:.9rem; font-weight:700; font-family:'Noto Sans KR',sans-serif; cursor:pointer; margin-top:4px; }
.btn-full:active{ opacity:.85; }
.btn-gold{ background:linear-gradient(135deg,var(--gd),var(--gm)); color:var(--pd); }

/* í† ìŠ¤íŠ¸ */
#toast{ position:fixed; top:80px; left:50%; transform:translateX(-50%); background:linear-gradient(135deg,var(--pm),var(--p3)); color:white; padding:11px 20px; border-radius:22px; font-size:.83rem; font-weight:600; box-shadow:0 6px 24px rgba(58,13,114,0.35); display:none; z-index:999; white-space:nowrap; border-left:4px solid var(--gb); }

/* ë°°ë„ˆ */
.banner{ display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; font-size:.8rem; line-height:1.4; cursor:pointer; margin-bottom:7px; }
.banner.urgent{ background:rgba(229,57,53,0.1); border:1px solid rgba(229,57,53,0.3); color:#B71C1C; }
.banner.warn{ background:rgba(245,124,0,0.1); border:1px solid rgba(245,124,0,0.3); color:#BF360C; }
.banner-x{ font-size:.75rem; opacity:.55; flex-shrink:0; }

/* ê´€ë¦¬ì ì „ìš© ë°°ì§€ */
.admin-only-badge{
  display:inline-flex; align-items:center; gap:4px;
  background:linear-gradient(135deg,rgba(212,168,32,0.15),rgba(212,168,32,0.08));
  border:1px solid rgba(212,168,32,0.35);
  color:var(--gd); font-size:.62rem; font-weight:700;
  padding:2px 8px; border-radius:20px;
}

/* â”€â”€ ë§í¬ ìƒì„± ê²°ê³¼ ì‹œíŠ¸ â”€â”€ */
.link-result{
  background:linear-gradient(135deg,var(--pm),var(--p2));
  border-radius:16px; padding:18px; margin-bottom:16px;
  position:relative; overflow:hidden;
}
.link-result::before{ content:''; position:absolute; top:-20px; right:-20px; width:100px; height:100px; background:radial-gradient(circle,rgba(212,168,32,0.18),transparent 70%); }
.lr-success{ display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.lr-icon{ width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,var(--gd),var(--gb)); display:flex; align-items:center; justify-content:center; font-size:1.3rem; flex-shrink:0; }
.lr-name{ font-family:'Nanum Myeongjo',serif; font-size:1.05rem; font-weight:800; color:white; }
.lr-sub{ font-size:.72rem; color:rgba(255,255,255,0.65); margin-top:2px; }
.link-box{ background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); border-radius:10px; padding:11px 14px; margin-bottom:14px; cursor:pointer; transition:background .15s; }
.link-box:active{ background:rgba(255,255,255,0.22); }
.link-box-label{ font-size:.63rem; color:rgba(255,255,255,0.55); margin-bottom:4px; }
.link-box-url{ font-size:.73rem; color:rgba(255,255,255,0.9); font-weight:600; word-break:break-all; line-height:1.5; display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
.link-copy-icon{ font-size:1rem; flex-shrink:0; margin-top:1px; }
.share-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px; }
.sgbtn{ padding:12px 8px; border-radius:12px; border:none; font-size:.82rem; font-weight:700; cursor:pointer; font-family:'Noto Sans KR',sans-serif; display:flex; align-items:center; justify-content:center; gap:6px; transition:opacity .15s; }
.sgbtn:active{ opacity:.75; }
.sg-kakao{ background:#FEE500; color:#3C1E1E; }
.sg-sms  { background:rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.22) !important; color:white; }
.sg-copy { background:rgba(255,255,255,0.1);  border:1px solid rgba(255,255,255,0.18) !important; color:rgba(255,255,255,0.85); }
.sg-new  { background:linear-gradient(135deg,var(--p2),var(--p3)); color:white; width:100%; margin-top:4px; }
.link-btn{ font-size:.6rem; font-weight:700; color:var(--green); background:rgba(46,125,50,0.1); border:1px solid rgba(46,125,50,0.25); padding:3px 8px; border-radius:8px; cursor:pointer; white-space:nowrap; font-family:'Noto Sans KR',sans-serif; }
.link-btn:active{ background:rgba(46,125,50,0.2); }
@keyframes successPop{ 0%{transform:scale(.95);opacity:.7} 100%{transform:scale(1);opacity:1} }
.link-result{ animation:successPop .35s cubic-bezier(.4,0,.2,1); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¬ê³  ìƒì„¸ íŒ¨ë„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sp-overlay{
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.5); z-index:600;
  backdrop-filter:blur(2px);
}
.sp-overlay.show{ display:block; }

.sp-panel{
  position:fixed; top:0;
  right:-100vw;
  width:100%; max-width:430px; height:100%; height:100dvh;
  background:var(--bg); z-index:601;
  transition:right .32s cubic-bezier(.4,0,.2,1);
  overflow-y:auto; overflow-x:hidden;
  padding-bottom:40px;
  box-shadow:-6px 0 30px rgba(0,0,0,0.3);
}
.sp-panel.open{ right:0; }
@media(min-width:430px){
  .sp-panel{ right:calc(-100vw + ((100vw - 430px)/2)); }
  .sp-panel.open{ right:calc((100vw - 430px)/2); }
}

/* í—¤ë” */
.sp-head{
  background:linear-gradient(135deg,var(--pd),var(--pm));
  padding:14px 16px 18px; position:sticky; top:0; z-index:10;
  box-shadow:0 2px 14px rgba(0,0,0,0.25);
}
.sp-head-row{ display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.sp-back-btn{
  min-width:72px; height:36px;
  background:rgba(255,255,255,0.18);
  border:1px solid rgba(255,255,255,0.3);
  border-radius:10px;
  display:flex; align-items:center; justify-content:center; gap:4px;
  font-size:.8rem; font-weight:700; color:white;
  cursor:pointer; flex-shrink:0;
  font-family:'Noto Sans KR',sans-serif;
}
.sp-back-btn:active{ background:rgba(255,255,255,0.3); }
.sp-head-name{ font-family:'Nanum Myeongjo',serif; font-size:.95rem; font-weight:800; color:var(--gb); flex:1; }
.sp-head-code{ font-size:.6rem; color:rgba(255,255,255,0.5); margin-top:1px; }

/* ê²Œì´ì§€ */
.sp-gauge{
  background:rgba(255,255,255,0.09);
  border-radius:13px; padding:13px 15px;
}
.sp-gauge-top{ display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:8px; }
.sp-big-num{
  font-family:'Nanum Myeongjo',serif;
  font-size:2.3rem; font-weight:800; line-height:1;
}
.sp-gauge-right{ text-align:right; }
.sp-safe-txt{ font-size:.68rem; color:rgba(255,255,255,0.55); margin-bottom:4px; }
.sp-bar-track{
  height:8px; background:rgba(255,255,255,0.15);
  border-radius:4px; overflow:hidden; margin-bottom:5px;
}
.sp-bar-fill{
  height:100%; border-radius:4px;
  transition:width .7s cubic-bezier(.4,0,.2,1);
}
.sp-bar-ok  { background:linear-gradient(90deg,#43A047,#81C784); }
.sp-bar-warn{ background:linear-gradient(90deg,#FB8C00,#FFCC02); }
.sp-bar-low { background:linear-gradient(90deg,#E53935,#EF9A9A); }
.sp-gauge-foot{
  display:flex; align-items:center; justify-content:space-between;
  font-size:.7rem; color:rgba(255,255,255,0.6);
}

/* ì•¡ì…˜ ë²„íŠ¼ 2ê°œ */
.sp-acts{ display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:14px; }
.sp-act{
  padding:14px 10px; border:none; border-radius:14px; cursor:pointer;
  font-size:.85rem; font-weight:800; font-family:'Noto Sans KR',sans-serif;
  display:flex; flex-direction:column; align-items:center; gap:6px;
  transition:opacity .15s;
}
.sp-act:active{ opacity:.8; }
.sp-act-in { background:linear-gradient(135deg,var(--gd),var(--gm)); color:var(--pd); }
.sp-act-out{ background:linear-gradient(135deg,var(--p2),var(--p3)); color:white; }
.sp-act-em { font-size:1.5rem; }

/* ì„¹ì…˜ */
.sp-sec{ margin:0 14px 14px; }
.sp-sec-ttl{
  font-family:'Nanum Myeongjo',serif; font-size:.88rem; font-weight:800;
  color:var(--pm); margin-bottom:10px;
  display:flex; align-items:center; justify-content:space-between;
}

/* ìˆ˜ëŸ‰ ì¡°ì • */
.qty-row{
  background:var(--card); border-radius:14px;
  border:1px solid var(--border); padding:14px 16px;
  display:flex; align-items:center; gap:10px;
  box-shadow:0 2px 8px rgba(90,31,160,0.06);
}
.qty-pm{
  width:42px; height:42px; border-radius:50%;
  border:2px solid var(--border); background:var(--bg);
  font-size:1.4rem; font-weight:800; color:var(--pm);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:all .15s;
  font-family:'Noto Sans KR',sans-serif;
}
.qty-pm.m:active{ background:rgba(229,57,53,0.1); border-color:var(--red); }
.qty-pm.p:active{ background:rgba(46,125,50,0.1); border-color:var(--green); }
.qty-num{
  flex:1; text-align:center;
  font-family:'Nanum Myeongjo',serif;
  font-size:1.9rem; font-weight:800; color:var(--text);
  border:none; background:transparent; outline:none;
}
.qty-apply{
  padding:10px 16px; background:linear-gradient(135deg,var(--p2),var(--p3));
  color:white; border:none; border-radius:10px;
  font-size:.8rem; font-weight:700; cursor:pointer;
  font-family:'Noto Sans KR',sans-serif; flex-shrink:0;
}
.qty-apply:active{ opacity:.8; }

/* ì°¨íŠ¸ */
.sp-chart{
  background:var(--card); border-radius:14px;
  border:1px solid var(--border); padding:14px 16px;
  box-shadow:0 2px 8px rgba(90,31,160,0.06);
}
.chart-bars{
  display:flex; align-items:flex-end; gap:6px;
  height:80px; margin-bottom:8px;
}
.chart-col{ flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; height:100%; justify-content:flex-end; }
.chart-pair{ display:flex; gap:2px; align-items:flex-end; width:100%; }
.cb-in { border-radius:3px 3px 0 0; background:linear-gradient(180deg,var(--gm),var(--gd)); flex:1; min-height:3px; }
.cb-out{ border-radius:3px 3px 0 0; background:linear-gradient(180deg,var(--p3),var(--p2)); flex:1; min-height:3px; }
.chart-lbl{ font-size:.58rem; color:var(--text3); }
.chart-legend{ display:flex; gap:12px; }
.cl-item{ display:flex; align-items:center; gap:5px; font-size:.65rem; color:var(--text3); }
.cl-dot{ width:10px; height:10px; border-radius:3px; }

/* ì´ë ¥ */
.hist-list{
  background:var(--card); border-radius:14px;
  border:1px solid var(--border); overflow:hidden;
  box-shadow:0 2px 8px rgba(90,31,160,0.06);
}
.hist-row{
  display:flex; align-items:center; gap:10px;
  padding:11px 14px; border-bottom:1px solid rgba(90,31,160,0.06);
}
.hist-row:last-child{ border-bottom:none; }
.hist-ic{
  width:36px; height:36px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:.9rem; flex-shrink:0;
}
.hic-in { background:rgba(212,168,32,0.12); }
.hic-out{ background:rgba(90,31,160,0.1); }
.hic-adj{ background:rgba(46,125,50,0.1); }
.hist-info{ flex:1; min-width:0; }
.hist-main{ font-size:.82rem; font-weight:600; color:var(--text); }
.hist-date{ font-size:.67rem; color:var(--text3); margin-top:1px; }
.hist-q{ font-family:'Nanum Myeongjo',serif; font-size:.95rem; font-weight:800; flex-shrink:0; }
.hist-q.in { color:#A07810; }
.hist-q.out{ color:var(--p2); }
.hist-q.adj{ color:var(--green); }

/* ëª©ë¡ í´ë¦­ ì»¤ì„œ */
.stock-full-item{ cursor:pointer; transition:background .12s; }
.stock-full-item:active{ background:rgba(90,31,160,0.05); }


/* â•â• ì›”ë³„ êµ¬ë… í˜„í™© ì¹´ë“œ â•â• */
.sub-stat-card{
  margin:0 14px 14px;
  background:linear-gradient(135deg,var(--pd),var(--pm));
  border-radius:18px; padding:18px;
  box-shadow:0 6px 24px rgba(58,13,114,0.22);
  position:relative; overflow:hidden;
}
.sub-stat-card::before{
  content:''; position:absolute;
  top:-30px; right:-30px;
  width:140px; height:140px;
  background:radial-gradient(circle,rgba(212,168,32,0.18),transparent 70%);
  pointer-events:none;
}
.ssc-top{
  display:flex; align-items:flex-start;
  justify-content:space-between; margin-bottom:16px;
}
.ssc-month-badge{
  background:rgba(212,168,32,0.18);
  border:1px solid rgba(212,168,32,0.35);
  border-radius:20px; padding:5px 12px;
  font-size:.72rem; font-weight:800; color:var(--gb);
  display:flex; align-items:center; gap:5px;
}
.ssc-reset-info{
  font-size:.62rem; color:rgba(255,255,255,0.45);
  text-align:right; line-height:1.6;
}
/* ë©”ì¸ ìˆ«ì */
.ssc-main-row{
  display:flex; align-items:flex-end; gap:14px; margin-bottom:16px;
}
.ssc-big{
  font-family:'Nanum Myeongjo',serif;
  font-size:3.2rem; font-weight:800;
  color:white; line-height:1;
}
.ssc-big-unit{ font-size:1.1rem; color:rgba(255,255,255,0.7); margin-bottom:6px; }
.ssc-vs{
  font-size:.75rem; color:rgba(255,255,255,0.6);
  line-height:1.6; padding-bottom:6px;
}
.ssc-vs strong{ font-weight:800; }
.ssc-up  { color:#81C784; }
.ssc-down{ color:#EF9A9A; }
/* ì„¸ë¶€ ê·¸ë¦¬ë“œ */
.ssc-grid{
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
  margin-bottom:14px;
}
.ssc-item{
  background:rgba(255,255,255,0.1);
  border-radius:10px; padding:10px 8px; text-align:center;
}
.ssc-item-num{
  font-family:'Nanum Myeongjo',serif;
  font-size:1.3rem; font-weight:800; color:var(--gb);
}
.ssc-item-lbl{ font-size:.62rem; color:rgba(255,255,255,0.6); margin-top:2px; }
/* ì§„í–‰ ë°” */
.ssc-bar-row{
  display:flex; align-items:center; gap:8px; margin-bottom:4px;
}
.ssc-bar-lbl{ font-size:.65rem; color:rgba(255,255,255,0.55); width:32px; flex-shrink:0; }
.ssc-bar-track{
  flex:1; height:6px; background:rgba(255,255,255,0.15);
  border-radius:3px; overflow:hidden;
}
.ssc-bar-fill{ height:100%; border-radius:3px; transition:width .8s cubic-bezier(.4,0,.2,1); }
.ssb-active{ background:linear-gradient(90deg,#43A047,#81C784); }
.ssb-warn  { background:linear-gradient(90deg,#FB8C00,#FFCC02); }
.ssb-exp   { background:linear-gradient(90deg,#E53935,#EF9A9A); }
.ssc-bar-count{ font-size:.65rem; color:rgba(255,255,255,0.7); font-weight:700; width:24px; text-align:right; flex-shrink:0; }
/* ì›”ë³„ íˆìŠ¤í† ë¦¬ */
.ssc-history-ttl{
  font-family:'Nanum Myeongjo',serif; font-size:.82rem; font-weight:800;
  color:var(--pm); margin-bottom:8px;
  display:flex; align-items:center; justify-content:space-between;
}
.month-hist-wrap{
  display:flex; gap:5px; overflow-x:auto;
  -webkit-overflow-scrolling:touch; scrollbar-width:none;
  padding-bottom:4px;
}
.month-hist-wrap::-webkit-scrollbar{ display:none; }
.mh-col{
  flex-shrink:0; width:52px;
  background:var(--card); border-radius:10px;
  border:1px solid var(--border);
  padding:8px 4px; text-align:center;
  cursor:pointer; transition:all .15s;
}
.mh-col.current{
  background:linear-gradient(135deg,var(--p5),white);
  border-color:var(--p3);
}
.mh-col:active{ opacity:.8; }
.mh-bar-wrap{
  height:48px; display:flex; align-items:flex-end;
  justify-content:center; margin-bottom:4px;
}
.mh-bar{
  width:20px; border-radius:3px 3px 0 0;
  background:linear-gradient(180deg,var(--p3),var(--p2));
  min-height:3px; transition:height .5s;
}
.mh-col.current .mh-bar{ background:linear-gradient(180deg,var(--gm),var(--gd)); }
.mh-num{ font-family:'Nanum Myeongjo',serif; font-size:.75rem; font-weight:800; color:var(--pm); }
.mh-col.current .mh-num{ color:var(--gd); }
.mh-lbl{ font-size:.58rem; color:var(--text3); margin-top:1px; }
/* ì‹¤ì‹œê°„ ë±ƒì§€ */
@keyframes pulse-dot{
  0%,100%{ opacity:1; transform:scale(1); }
  50%{ opacity:.5; transform:scale(1.3); }
}
.live-dot{
  display:inline-block; width:7px; height:7px;
  background:#81C784; border-radius:50%;
  animation:pulse-dot 1.8s infinite; margin-right:4px;
}

.sec-title{ font-family:'Nanum Myeongjo',serif; font-size:.88rem; font-weight:800; color:var(--pm); padding:16px 14px 8px; display:flex; align-items:center; justify-content:space-between; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ–¥ï¸  ë°ìŠ¤í¬íƒ‘ ë°˜ì‘í˜• (768px+)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ ì–¸ì–´ í† ê¸€ ê³µí†µ â”€â”€ */
.lang-toggle{
  display:flex; align-items:center; gap:2px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:16px; padding:2px;
}
.lang-btn{
  padding:4px 12px; border-radius:13px;
  font-size:.68rem; font-weight:700; cursor:pointer;
  color:rgba(255,255,255,0.55); border:none;
  background:transparent; font-family:'Noto Sans KR',sans-serif;
  transition:all .18s; line-height:1.4;
}
.lang-btn.lang-active{
  background:linear-gradient(135deg,var(--gd),var(--gm));
  color:var(--pd); box-shadow:0 2px 8px rgba(212,168,32,.35);
}
.lang-btn:hover:not(.lang-active){ color:white; }

/* â”€â”€ ì‚¬ì´ë“œë°” (ê¸°ë³¸ ìˆ¨ê¹€) â”€â”€ */
.sidebar{ display:none; }

/* â”€â”€ ëª¨ë°”ì¼ ì „ìš© ìˆ¨ê¹€ â”€â”€ */
@media(max-width:767px){ .desktop-only{ display:none !important; } }
@media(min-width:768px){ .mobile-only{ display:none !important; } }

@media(min-width:768px){
  /* â”€â”€ html/body í’€í­ â”€â”€ */
  html,body{ overflow-x:hidden; }

  /* â”€â”€ ì•± ë˜í¼ ì „ì²´ ë ˆì´ì•„ì›ƒ â”€â”€ */
  #app{ display:flex; flex-direction:column; }

  /* â”€â”€ í—¤ë”: í’€í­ìœ¼ë¡œ â”€â”€ */
  .header{
    max-width:100%;
    left:0 !important; transform:none !important;
    padding:12px 32px 10px;
  }
  .header-row{ max-width:1280px; margin:0 auto; width:100%; }
  .header-date{ max-width:1280px; margin:0 auto; width:100%; text-align:left; }

  /* â”€â”€ ì‚¬ì´ë“œë°”/íƒ­ë°”: mode í´ë˜ìŠ¤ë¡œ ì œì–´ (ìœ„ CSS ì°¸ê³ ) â”€â”€ */
  /* í´ë°±: mode í´ë˜ìŠ¤ ì—†ì„ ë•Œë§Œ ìë™ ì „í™˜ (ìœ„ @media í´ë°± ì°¸ê³ ) */

  /* â”€â”€ KPI ì¹´ë“œ ì¤„ë°”ê¿ˆ â”€â”€ */
  .kpi-scroll{ flex-wrap:wrap; overflow-x:visible; }
  .kpi-card{ width:160px !important; }

  /* â”€â”€ íŒ¨ë„/ì‹œíŠ¸ í­ â”€â”€ */
  .tree-panel, .sp-panel{ max-width:520px; }
  .sheet{ max-width:480px; }

  /* â”€â”€ í˜ì´ì§€ í—¤ë” â”€â”€ */
  .page-header h2{ font-size:1.25rem; }
  .section-title{ font-size:.95rem; }

  /* â”€â”€ êµ¬ë… í˜„í™© ì¹´ë“œ â”€â”€ */
  .sub-stat-card{ max-width:640px; }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± ëª¨ë°”ì¼ / ğŸ–¥ï¸ ë°ìŠ¤í¬íƒ‘  ë·°ëª¨ë“œ ì‹œìŠ¤í…œ
   body.mode-mobile  â†’ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ
   body.mode-desktop â†’ ë°ìŠ¤í¬íƒ‘ ë ˆì´ì•„ì›ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ ë·°ëª¨ë“œ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ â”€â”€ */
.view-toggle {
  display:flex; align-items:center; gap:2px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:16px; padding:2px;
}
.view-btn {
  padding:4px 12px; border-radius:13px;
  font-size:.68rem; font-weight:700; cursor:pointer;
  color:rgba(255,255,255,0.55); border:none;
  background:transparent; transition:all .18s;
  white-space:nowrap; font-family:'Noto Sans KR',sans-serif;
  line-height:1.4;
}
.view-btn.view-active {
  background:rgba(255,255,255,0.2);
  color:#fff; box-shadow:0 1px 6px rgba(0,0,0,0.2);
}
.view-btn:hover:not(.view-active){ color:rgba(255,255,255,0.8); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± ëª¨ë°”ì¼ ëª¨ë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body.mode-mobile .sidebar  { display:none !important; }
body.mode-mobile .tabbar   { display:flex !important; }

body.mode-mobile .header {
  max-width:430px !important;
  left:50% !important;
  transform:translateX(-50%) !important;
  padding:12px 16px 10px !important;
}
body.mode-mobile .body-wrap {
  margin-left:0 !important;
  max-width:430px !important;
  margin-right:auto !important;
  margin-left:auto !important;
  padding-top:100px !important;
  padding-bottom:calc(70px + var(--safe-bottom)) !important;
  padding-left:0 !important;
  padding-right:0 !important;
}
body.mode-mobile .tabbar {
  max-width:430px !important;
  left:50% !important;
  transform:translateX(-50%) !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ–¥ï¸ ë°ìŠ¤í¬íƒ‘ ëª¨ë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body.mode-desktop .sidebar {
  display:flex !important;
  flex-direction:column;
  position:fixed !important;
  top:62px !important;
  left:0 !important;
  width:220px !important;
  height:calc(100vh - 62px) !important;
  background:var(--card) !important;
  border-right:1px solid var(--border) !important;
  padding:16px 10px 24px !important;
  overflow-y:auto !important;
  z-index:90 !important;
  box-shadow:2px 0 16px rgba(90,31,160,.08) !important;
}
body.mode-desktop .tabbar  { display:none !important; }
body.mode-desktop .header {
  max-width:100% !important;
  left:0 !important;
  transform:none !important;
  padding:10px 32px 0 !important;
}
/* ë°ìŠ¤í¬íƒ‘: 2í–‰ íˆ´ë°” ìˆ¨ê¸°ê³  ë‚ ì§œ í‘œì‹œ */
body.mode-desktop .header-toolbar { display:none !important; }
body.mode-desktop .header-date    { display:block !important; }
body.mode-desktop .body-wrap {
  margin-left:220px !important;
  max-width:none !important;
  padding-top:20px !important;
  padding-bottom:40px !important;
  padding-left:32px !important;
  padding-right:32px !important;
}
body.mode-desktop .kpi-scroll {
  flex-wrap:wrap !important;
  overflow-x:visible !important;
}
body.mode-desktop .kpi-card { width:160px !important; }
body.mode-desktop .sub-stat-card { max-width:640px; }

/* â”€â”€ ì‚¬ì´ë“œë°” ê³µí†µ ë‚´ë¶€ ìŠ¤íƒ€ì¼ (í•­ìƒ ì ìš©) â”€â”€ */
.sb-logo-row {
  display:flex; align-items:center; gap:8px;
  padding:6px 10px 14px; margin-bottom:4px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.sb-logo-icon {
  width:30px; height:30px;
  background:linear-gradient(135deg,var(--gd),var(--gb));
  border-radius:8px; display:flex; align-items:center;
  justify-content:center; font-size:15px; flex-shrink:0;
}
.sb-logo-txt {
  font-family:'Nanum Myeongjo',serif;
  font-size:.82rem; font-weight:800; color:var(--pm);
}
.sb-section {
  font-size:.6rem; font-weight:700; color:var(--text3);
  letter-spacing:.1em; text-transform:uppercase;
  padding:14px 12px 6px; flex-shrink:0;
}
.sb-item {
  display:flex; align-items:center; gap:10px;
  padding:11px 14px; border-radius:12px; cursor:pointer;
  font-size:.88rem; font-weight:600; color:var(--text2);
  transition:all .15s; position:relative; margin:2px 0;
  user-select:none; flex-shrink:0;
}
.sb-item:hover { background:var(--p5); color:var(--pm); }
.sb-item.sb-active {
  background:linear-gradient(135deg,var(--p5),rgba(90,31,160,.1));
  color:var(--pm); font-weight:800;
}
.sb-item.sb-active::before {
  content:''; position:absolute; left:0; top:20%; bottom:20%;
  width:3px; background:linear-gradient(180deg,var(--p2),var(--p3));
  border-radius:0 3px 3px 0;
}
.sb-icon { font-size:1rem; flex-shrink:0; }
.sb-badge {
  margin-left:auto; background:var(--red); color:white;
  font-size:.55rem; font-weight:700;
  padding:2px 6px; border-radius:8px;
}
.sb-divider { height:1px; background:var(--border); margin:8px 4px; flex-shrink:0; }

/* @media ëŠ” ë·°ëª¨ë“œ ë¯¸ì„¤ì • ìƒíƒœì—ì„œë§Œ ìë™ íŒë‹¨ (í´ë°±) */
@media(min-width:768px){
  body:not(.mode-mobile):not(.mode-desktop) .sidebar {
    display:flex;
    flex-direction:column;
    position:fixed;
    top:73px; left:0;
    width:220px; height:calc(100vh - 73px);
    background:var(--card); border-right:1px solid var(--border);
    padding:16px 10px 24px; overflow-y:auto; z-index:90;
  }
  body:not(.mode-mobile):not(.mode-desktop) .tabbar { display:none; }
  body:not(.mode-mobile):not(.mode-desktop) .body-wrap {
    margin-left:220px; padding-top:24px; padding-left:32px; padding-right:32px;
  }
}
@media(max-width:767px){
  body:not(.mode-mobile):not(.mode-desktop) .sidebar { display:none; }
  body:not(.mode-mobile):not(.mode-desktop) .tabbar  { display:flex; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prod-modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.5);
  z-index:500; display:none; align-items:flex-end;
  justify-content:center;
}
.prod-modal-overlay.open{ display:flex; }
.prod-modal{
  width:100%; max-width:480px;
  background:var(--card); border-radius:22px 22px 0 0;
  padding:20px 20px calc(24px + var(--safe-bottom));
  animation:sheetUp .28s cubic-bezier(.4,0,.2,1);
}
.prod-modal-title{
  font-family:'Nanum Myeongjo',serif;
  font-size:1rem; font-weight:800; color:var(--pm);
  margin-bottom:16px; display:flex; align-items:center; gap:8px;
}
.prod-tabs{
  display:flex; gap:6px; margin-bottom:16px;
  background:var(--p5); border-radius:12px; padding:4px;
}
.prod-tab{
  flex:1; padding:7px 4px; border-radius:9px; cursor:pointer;
  font-size:.78rem; font-weight:700; text-align:center;
  color:var(--text3); transition:all .15s; border:none;
  background:transparent; font-family:'Noto Sans KR',sans-serif;
}
.prod-tab.active{
  background:var(--card); color:var(--pm);
  box-shadow:0 1px 6px rgba(90,31,160,.15);
}
/* ìƒˆ ìƒí’ˆ ì¶”ê°€ í¼ íŒíŠ¸ */
.prod-hint{
  font-size:.72rem; color:var(--text3); margin:-4px 0 12px;
  padding:8px 12px; background:var(--p5);
  border-radius:8px; line-height:1.5;
}
/* si-product ë“œë¡­ë‹¤ìš´ì— ì‹ ê·œ ì¶”ê°€ ë²„íŠ¼ */
.si-product-row{
  display:flex; gap:8px; align-items:center; margin-bottom:12px;
}
.si-product-row select{ flex:1; margin-bottom:0 !important; }
.btn-add-product{
  flex-shrink:0; height:42px; width:42px;
  background:linear-gradient(135deg,var(--gd),var(--gm));
  border:none; border-radius:10px; cursor:pointer;
  font-size:1.2rem; display:flex; align-items:center;
  justify-content:center; box-shadow:0 2px 8px rgba(212,168,32,.3);
  transition:transform .1s;
}
.btn-add-product:active{ transform:scale(.95); }


/* â•â•â•â• ìœ ì € ë©”ë‰´ ë“œë¡­ë‹¤ìš´ â•â•â•â• */
.user-menu{
  position:absolute; top:56px; right:14px;
  background:var(--card); border:1px solid var(--border);
  border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,0.18);
  z-index:300; min-width:175px; overflow:hidden; display:none;
}
.user-menu.open{ display:block; animation:sheetUp .2s ease; }
.umenu-head{
  padding:12px 16px 10px; border-bottom:1px solid var(--border);
}
.umenu-name{ font-size:.85rem; font-weight:800; color:var(--pm); }
.umenu-id  { font-size:.68rem; color:var(--text3); margin-top:2px; }
.umenu-item{
  padding:12px 16px; font-size:.82rem; font-weight:600;
  color:var(--text); cursor:pointer; display:flex; align-items:center; gap:9px;
  transition:background .12s;
}
.umenu-item:hover{ background:var(--p5); }
.umenu-item.danger{ color:var(--red); border-top:1px solid var(--border); }
.umenu-item.danger:hover{ background:rgba(211,47,47,.06); }

/* â•â•â•â• ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ë°” â•â•â•â• */
.pw-strength-bar{
  height:4px; border-radius:2px; margin:6px 0 3px;
  transition:width .25s, background .25s; display:none;
}
.pw-strength-bar.weak  { background:var(--red);    width:30%; display:block; }
.pw-strength-bar.medium{ background:var(--orange); width:65%; display:block; }
.pw-strength-bar.strong{ background:var(--green);  width:100%;display:block; }
.pw-strength-txt{ font-size:.68rem; margin-bottom:10px; display:none; }

/* â•â•â•â• í˜„ì¬ ê³„ì • ì •ë³´ ì¹´ë“œ â•â•â•â• */
.cur-account-card{
  background:var(--p5); border:1px solid var(--border);
  border-radius:12px; padding:12px 14px; margin-bottom:16px;
}
.cur-account-row{
  display:flex; justify-content:space-between; align-items:center;
  padding:5px 0; font-size:.78rem;
}
.cur-account-row:not(:last-child){ border-bottom:1px solid var(--border); }
.cur-account-key{ color:var(--text3); font-weight:600; }
.cur-account-val{ color:var(--pm); font-weight:700; }

/* â•â•â•â• ë¡œê·¸ì¸ í™”ë©´ â€” ê¸°ë³¸ê³„ì • íŒíŠ¸ â•â•â•â• */
.login-hint{
  background:rgba(212,168,32,.1); border:1px solid rgba(212,168,32,.3);
  border-radius:10px; padding:10px 14px; margin-bottom:14px;
  font-size:.75rem; color:rgba(255,255,255,.8); line-height:1.7;
}
.login-hint code{
  color:var(--gb); font-weight:800; background:rgba(212,168,32,.15);
  padding:1px 5px; border-radius:4px;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ í™œë™ê¸°ë¡ / â­ ë§Œì¡±ë„ / ğŸ“Š ê´€ë¦¬ì ë¦¬í¬íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* ì„¹ì…˜ í—¤ë” */
.act-section-hd{
  padding:18px 14px 8px; display:flex; align-items:center;
  justify-content:space-between;
}
.act-section-hd h3{
  font-size:.95rem; font-weight:800; color:var(--pm);
  display:flex; align-items:center; gap:7px; margin:0;
}
.act-cnt-badge{
  font-size:.65rem; background:var(--p5); color:var(--p2);
  padding:2px 9px; border-radius:10px; font-weight:700;
}
/* í™œë™ ìœ í˜• ì¹© ì„ íƒ */
.atype-row{ display:flex; flex-wrap:wrap; gap:7px; padding:0 14px 12px; }
.atype-chip{
  padding:7px 14px; border-radius:20px;
  border:1.5px solid var(--border); background:var(--card);
  font-size:.78rem; font-weight:600; color:var(--text3);
  cursor:pointer; transition:all .15s;
  font-family:'Noto Sans KR',sans-serif;
}
.atype-chip.on{ border-color:var(--p2); background:var(--p5); color:var(--pm); }
/* í™œë™ ì¹´ë“œ */
.act-card{
  background:var(--card); border:1px solid var(--border);
  border-radius:14px; margin:0 14px 10px; overflow:hidden;
}
.act-card-head{
  padding:12px 14px 10px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.act-card-title{ font-size:.85rem; font-weight:800; color:var(--pm); }
.act-card-cnt{ font-size:.68rem; color:var(--text3); }
.act-item{
  padding:12px 14px; border-bottom:1px solid var(--border);
  position:relative;
}
.act-item:last-child{ border-bottom:none; }
.act-item-meta{
  display:flex; gap:6px; flex-wrap:wrap; margin-bottom:5px;
}
.act-tag{
  font-size:.65rem; font-weight:700; padding:2px 8px; border-radius:6px;
}
.act-tag-date{ background:rgba(90,31,160,.08); color:var(--p2); }
.act-tag-place{ background:rgba(212,168,32,.1); color:#7a5900; }
.act-tag-attend{ background:rgba(46,125,50,.1); color:var(--green); }
.act-tag-absent{ background:rgba(211,47,47,.1); color:var(--red); }
.act-item-memo{ font-size:.78rem; color:var(--text); line-height:1.5; }
.act-del-btn{
  position:absolute; top:10px; right:10px;
  width:24px; height:24px; border-radius:50%;
  border:none; background:rgba(211,47,47,.08);
  color:var(--red); font-size:.75rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:background .15s;
}
.act-del-btn:hover{ background:rgba(211,47,47,.2); }
.act-empty-box{
  padding:22px; text-align:center;
  font-size:.78rem; color:var(--text3);
}
/* í™œë™ ì¶”ê°€ ë²„íŠ¼ */
.btn-add-act{
  width:calc(100% - 28px); margin:0 14px 14px; padding:11px;
  border:1.5px dashed var(--border); border-radius:11px;
  background:transparent; color:var(--p2); font-size:.8rem;
  font-weight:700; cursor:pointer; transition:all .15s;
  font-family:'Noto Sans KR',sans-serif;
}
.btn-add-act:hover{ border-color:var(--p2); background:var(--p5); }

/* â”€â”€ ë§Œì¡±ë„ í‰ê°€ â”€â”€ */
.rating-select-row{
  display:grid; grid-template-columns:1fr 1fr 1fr;
  gap:8px; padding:0 14px 14px;
}
.rating-opt{
  padding:14px 4px; border-radius:13px;
  border:2px solid var(--border); background:var(--card);
  text-align:center; cursor:pointer; transition:all .18s;
}
.rating-opt .ro-emoji{ font-size:1.6rem; display:block; }
.rating-opt .ro-txt{ font-size:.7rem; font-weight:700; color:var(--text3); margin-top:5px; display:block; }
.rating-opt.sel-great{ border-color:var(--green); background:rgba(46,125,50,.06); }
.rating-opt.sel-great .ro-txt{ color:var(--green); }
.rating-opt.sel-good { border-color:var(--p2); background:var(--p5); }
.rating-opt.sel-good  .ro-txt{ color:var(--p2); }
.rating-opt.sel-bad  { border-color:var(--red); background:rgba(211,47,47,.06); }
.rating-opt.sel-bad   .ro-txt{ color:var(--red); }

.rating-hist-item{
  padding:12px 14px; border-bottom:1px solid var(--border);
}
.rating-hist-item:last-child{ border-bottom:none; }
.rating-hist-top{ display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.r-badge{ padding:3px 10px; border-radius:8px; font-size:.68rem; font-weight:800; }
.rb-great{ background:rgba(46,125,50,.1); color:var(--green); }
.rb-good { background:var(--p5); color:var(--p2); }
.rb-bad  { background:rgba(211,47,47,.1); color:var(--red); }
.r-date  { font-size:.68rem; color:var(--text3); }
.r-reason{ font-size:.78rem; color:var(--text); line-height:1.5; }

/* â”€â”€ ê´€ë¦¬ì ë¦¬í¬íŠ¸ â”€â”€ */
.rpt-stat-row{
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:8px; padding:0 14px 14px;
}
.rpt-stat{
  background:var(--card); border:1px solid var(--border);
  border-radius:12px; padding:12px 8px; text-align:center;
}
.rpt-stat-n{ font-size:1.35rem; font-weight:800; color:var(--pm); }
.rpt-stat-l{ font-size:.62rem; color:var(--text3); margin-top:2px; }

.rpt-member-item{
  padding:11px 14px; border-bottom:1px solid var(--border);
  cursor:pointer; transition:background .12s;
}
.rpt-member-item:hover{ background:var(--p5); }
.rpt-mi-top{ display:flex; align-items:center; justify-content:space-between; }
.rpt-mi-name{ font-size:.85rem; font-weight:700; color:var(--text); }
.rpt-mi-acts{
  display:flex; gap:5px;
}
.rpt-mi-act-tag{
  font-size:.62rem; padding:2px 7px; border-radius:6px;
  font-weight:700; background:var(--p5); color:var(--p2);
}
.rpt-mi-sub{ font-size:.7rem; color:var(--text3); margin-top:3px; }
.rpt-mi-rating{ font-size:.68rem; margin-top:3px; }

.rpt-bar-row{
  display:flex; align-items:center; gap:8px; margin-bottom:8px;
}
.rpt-bar-label{ font-size:.75rem; font-weight:700; width:56px; flex-shrink:0; color:var(--text2); }
.rpt-bar-track{
  flex:1; height:12px; background:var(--bg);
  border-radius:6px; overflow:hidden;
}
.rpt-bar-fill{ height:100%; border-radius:6px; transition:width .5s; }
.rbf-great{ background:var(--green); }
.rbf-good { background:var(--p2); }
.rbf-bad  { background:var(--red); }
.rpt-bar-pct{ font-size:.7rem; color:var(--text3); width:34px; text-align:right; flex-shrink:0; }

.rpt-detail-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  z-index:400; display:none; align-items:flex-end; justify-content:center;
}
.rpt-detail-overlay.open{ display:flex; }
.rpt-detail-panel{
  width:100%; max-width:520px; max-height:85vh;
  background:var(--card); border-radius:22px 22px 0 0;
  overflow-y:auto; animation:sheetUp .28s ease;
  padding-bottom:calc(20px + var(--safe-bottom));
}
.rpt-detail-head{
  padding:18px 18px 12px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:0; background:var(--card); z-index:1;
}
.rpt-detail-name{ font-size:1rem; font-weight:800; color:var(--pm); }


/* â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€ */
#db-loading{
  position:fixed; inset:0; z-index:9999;
  background:linear-gradient(160deg,var(--pd),var(--pm));
  display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:16px;
}
.db-spinner{
  width:48px; height:48px; border-radius:50%;
  border:4px solid rgba(255,255,255,0.2);
  border-top-color:var(--gb);
  animation:spin .8s linear infinite;
}
@keyframes spin{{ to{{ transform:rotate(360deg); }} }}
.db-loading-txt{{ color:rgba(255,255,255,0.8); font-size:.88rem; font-weight:600; }}


@keyframes pulse{
  0%,100%{ transform:scale(1); opacity:1; }
  50%{ transform:scale(1.15); opacity:.8; }
}
@keyframes dotPulse{
  0%,100%{ background:rgba(255,255,255,.2); transform:translateY(0); }
  50%{ background:rgba(212,168,32,.8); transform:translateY(-4px); }
}

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë¡œê·¸ì¸ í™”ë©´
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- DB ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="db-loading">
  <div style="font-size:2.8rem;animation:pulse 1.5s ease-in-out infinite;">ğŸ¦‹</div>
  <div class="db-spinner"></div>
  <div class="db-loading-txt" id="db-loading-txt">ì„œë²„ ì—°ê²° ì¤‘...</div>
  <div style="font-size:.7rem;color:rgba(255,255,255,.4);margin-top:8px;text-align:center;line-height:1.6;" id="db-loading-sub">
    ì²« ì ‘ì† ì‹œ 10~20ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”
  </div>
  <div style="margin-top:16px;display:flex;gap:6px;" id="db-dots">
    <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3);animation:dotPulse 1.2s ease-in-out 0s infinite;"></div>
    <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3);animation:dotPulse 1.2s ease-in-out 0.2s infinite;"></div>
    <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3);animation:dotPulse 1.2s ease-in-out 0.4s infinite;"></div>
  </div>
</div>

<div class="login-screen" id="login-screen">
  <div class="login-inner">
    <div class="login-logo">
      <div class="icon">ğŸ¦‹</div>
      <div class="co-name">(ì£¼)ë‚´ëª¸ì• ë§ê²Œ</div>
      <div class="co-sub">ERP System Â· êµ¬ë…íšŒì› í†µí•©ê´€ë¦¬</div>
    </div>

    <div class="login-card">
      <h2>ë¡œê·¸ì¸</h2>
      <p>ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
      <!-- ê¸°ë³¸ ê³„ì • ì•ˆë‚´ -->
      <div class="login-hint">
        ğŸ”‘ <strong style="color:var(--gb);">ê¸°ë³¸ ê´€ë¦¬ì ê³„ì •</strong><br>
        ì•„ì´ë””: <code>admin</code> &nbsp;/&nbsp; ë¹„ë°€ë²ˆí˜¸: <code>admin123</code><br>
        <span style="font-size:.68rem;opacity:.75;">ë¡œê·¸ì¸ í›„ ìƒë‹¨ ìœ ì €ì¹© â†’ ê³„ì • ì„¤ì •ì—ì„œ ë³€ê²½í•˜ì„¸ìš”</span>
      </div>
      <input class="login-input" type="text" id="login-id-inp" placeholder="ì•„ì´ë””">
      <input class="login-input" type="password" id="login-pw-inp" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <div class="login-error" id="login-error">âŒ ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- ë°ëª¨ìš© ë¹ ë¥¸ ë¡œê·¸ì¸ -->
    <div class="quick-login">
      <p>â€” ë°ëª¨ ê³„ì •ìœ¼ë¡œ ë¹ ë¥¸ ë¡œê·¸ì¸ â€”</p>
      <div class="quick-logins">
        <div class="ql-btn admin-btn" onclick="quickLogin('admin')">ğŸ‘‘ ê´€ë¦¬ì</div>
      </div>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì•± ë³¸ì²´
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app" id="app">

  <!-- í—¤ë” -->
  <header class="header">
    <!-- â”€â”€ 1í–‰: ë¡œê³  + ìœ ì € + ì•Œë¦¼ â”€â”€ -->
    <div class="header-row">
      <div class="header-logo">
        <div class="logo-icon">ğŸ¦‹</div>
        <div>
          <div class="logo-name">(ì£¼)ë‚´ëª¸ì• ë§ê²Œ</div>
          <div class="logo-sub">ERP</div>
        </div>
      </div>
      <div class="header-right">
        <div class="user-chip" onclick="openUserMenu(event)">
          <div class="uc-avatar" id="uc-avatar">ê¹€</div>
          <div>
            <div class="uc-name" id="uc-name">ê¹€ì˜í¬</div>
            <div class="uc-role" id="uc-role">êµ¬ë…íšŒì›</div>
          </div>
        </div>
        <div class="hbtn" id="notif-btn">ğŸ””<span class="dot"></span></div>
      </div>
    </div>

    <!-- â”€â”€ 2í–‰: ë·°ëª¨ë“œ íƒ­ + ì–¸ì–´ íƒ­ â”€â”€ -->
    <div class="header-toolbar">
      <div class="view-toggle">
        <button class="view-btn view-active" id="view-mobile" onclick="setViewMode('mobile')">ğŸ“± ëª¨ë°”ì¼</button>
        <button class="view-btn" id="view-desktop" onclick="setViewMode('desktop')">ğŸ–¥ï¸ ë°ìŠ¤í¬íƒ‘</button>
      </div>
      <div class="lang-toggle">
        <button class="lang-btn lang-active" id="lang-ko" onclick="setLang('ko')">KO</button>
        <button class="lang-btn" id="lang-en" onclick="setLang('en')">EN</button>
      </div>
    </div>

    <!-- ë‚ ì§œ (ë°ìŠ¤í¬íƒ‘) -->
    <div class="header-date" id="today-date"></div>
    <!-- ìœ ì € ë©”ë‰´ ë“œë¡­ë‹¤ìš´ -->
    <div class="user-menu" id="user-menu">
      <div class="umenu-head">
        <div class="umenu-name" id="umenu-name">ê´€ë¦¬ì</div>
        <div class="umenu-id"   id="umenu-id">admin</div>
      </div>
      <div class="umenu-item" id="umenu-setting" onclick="openAdminSetting()">
        âš™ï¸ ê³„ì • ì„¤ì • / ì•„ì´ë”” ë³€ê²½
      </div>
      <div class="umenu-item danger" onclick="doLogout()">
        ğŸšª ë¡œê·¸ì•„ì›ƒ
      </div>
    </div>
  </header>

  <!-- ğŸ–¥ï¸ ë°ìŠ¤í¬íƒ‘ ì‚¬ì´ë“œë°” -->
  <nav class="sidebar" id="sidebar">
    <div class="sb-logo-row">
      <div class="sb-logo-icon">ğŸ¦‹</div>
      <div class="sb-logo-txt">ë‚´ëª¸ì• ë§ê²Œ</div>
    </div>
    <div class="sb-section">MENU</div>
    <div class="sb-item sb-active" id="sb-home-wrap" onclick="showTab('home')">
      <span class="sb-icon">ğŸ </span><span id="sb-home">í™ˆ</span>
    </div>
    <div class="sb-item" id="sb-members-wrap" onclick="showTab('members')">
      <span class="sb-icon">ğŸ‘¥</span><span id="sb-members">íšŒì›</span>
    </div>
    <div class="sb-item" id="sb-stock-wrap" onclick="showTab('stock')" style="display:none;">
      <span class="sb-icon">ğŸ“¦</span><span id="sb-stock">ì¬ê³ </span>
    </div>
    <div class="sb-item" id="sb-activity-wrap" onclick="showTab('activity')">
      <span class="sb-icon">ğŸ“‹</span><span id="sb-activity">í™œë™ê¸°ë¡Â·ë¦¬í¬íŠ¸</span>
    </div>
    <div class="sb-item" id="sb-rating-wrap" onclick="showTab('rating')" style="display:none;">
      <span class="sb-icon">â­</span><span id="sb-rating">ë§Œì¡±ë„ í‰ê°€</span>
    </div>
    <div class="sb-divider"></div>
    <div class="sb-item" id="sb-alerts-wrap" onclick="showTab('alerts')">
      <span class="sb-icon">ğŸ””</span><span id="sb-alerts">ì•Œë¦¼</span>
      <span class="sb-badge" id="sb-alert-badge" style="display:none;"></span>
    </div>
  </nav>

  <div class="body-wrap">

    <!-- â–¶ í™ˆ -->
    <div class="page active" id="page-home">
      <div style="padding:12px 14px 0;" id="banner-area"></div>

      <!-- â˜… ì›”ë³„ êµ¬ë… í˜„í™© ì¹´ë“œ -->
      <div id="sub-stat-wrap" style="display:none;margin-top:14px;"></div>
      <!-- ì›”ë³„ íˆìŠ¤í† ë¦¬ -->
      <div id="month-hist-wrap-erp" style="display:none;margin:0 14px 4px;"></div>

      <div class="section-title" id="lbl-summary">ğŸ“Š í˜„í™© ìš”ì•½</div>
      <div class="kpi-scroll" id="kpi-area"></div>

      <!-- ê´€ë¦¬ì ì „ìš© ë¹ ë¥¸ ì‹¤í–‰ -->
      <div id="admin-quick" style="display:none;">
        <div class="section-title" style="padding-top:18px;">âš¡ ë¹ ë¥¸ ì‹¤í–‰ <span class="admin-only-badge">ğŸ‘‘ ê´€ë¦¬ì</span></div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 14px;">
          <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 4px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;" onclick="openSheet('add-member')"><span style="font-size:1.3rem;">ğŸ‘¤</span><span style="font-size:.63rem;color:var(--text2);font-weight:600;text-align:center;line-height:1.3;">íšŒì›<br>ë“±ë¡</span></div>
          <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 4px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;" onclick="openSheet('stock-in')"><span style="font-size:1.3rem;">ğŸ“¥</span><span style="font-size:.63rem;color:var(--text2);font-weight:600;text-align:center;line-height:1.3;">ì…ê³ <br>ì²˜ë¦¬</span></div>
          <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 4px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;" onclick="openSheet('stock-out')"><span style="font-size:1.3rem;">ğŸ“¤</span><span style="font-size:.63rem;color:var(--text2);font-weight:600;text-align:center;line-height:1.3;">ì¶œê³ <br>ì²˜ë¦¬</span></div>
          <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 4px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;" onclick="showTab('alerts')"><span style="font-size:1.3rem;">ğŸ””</span><span style="font-size:.63rem;color:var(--red);font-weight:600;text-align:center;line-height:1.3;">ì•Œë¦¼<br>í™•ì¸</span></div>
        </div>
      </div>

      <div class="section-title" style="padding-top:20px;">
        <span id="lbl-expiring">â° ë§Œë£Œ ì„ë°•</span> <span class="more" id="lbl-more-all" onclick="showTab('members')">ì „ì²´ â†’</span>
      </div>
      <div class="card" id="expire-list"></div>
      <div class="card" id="dashboard-chart-wrap" style="margin-top:10px;padding:14px 16px;display:none;"></div>
      <div class="card" id="stock-summary-chart"  style="margin-top:10px;padding:14px 16px;display:none;"></div>
      <div class="section-title" style="padding-top:20px;" id="lbl-activity">ğŸ• ìµœê·¼ í™œë™</div>
      <div class="card" style="margin-bottom:14px;" id="activity-list">
        <div style="padding:20px;text-align:center;color:var(--text3);font-size:.82rem;">ì•„ì§ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>
    </div>

    <!-- â–¶ êµ¬ë…íšŒì› -->
    <div class="page" id="page-members">
      <div class="page-header">
        <div><h2 id="members-title">êµ¬ë…íšŒì› ê´€ë¦¬</h2><p id="members-desc">ì´ë¦„ì„ ëˆ„ë¥´ë©´ ê°œì¸ ì¶”ì²œ íŠ¸ë¦¬ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”</p></div>
        <button class="renew-btn" id="add-member-btn" style="width:auto;padding:0 14px;height:34px;display:none;" onclick="openSheet('add-member')">+ ë“±ë¡</button>
      </div>
      <div class="search-box"><span>ğŸ”</span><input type="text" id="member-search" placeholder="íšŒì›ëª… ê²€ìƒ‰" oninput="filterMembers()"></div>
      <div class="card" id="member-list-wrap" style="margin-bottom:14px;"></div>
    </div>

    <!-- â–¶ ì¬ê³  (ê´€ë¦¬ì ì „ìš©) -->
    <div class="page" id="page-stock">
      <div class="page-header"><div><h2 id="pg-stock-ttl">ì¬ê³  ê´€ë¦¬</h2><p id="pg-stock-sub">ì…ê³  Â· ì¶œê³  Â· ì¬ê³  í˜„í™©</p></div></div>
      <div class="kpi-scroll" style="padding-bottom:10px;">
        <div class="kpi-card kc-gold" style="width:120px;"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-num" id="sk-total" style="font-size:1.4rem;">â€”</div><div class="kpi-label">ì´ ì¬ê³ </div></div>
        <div class="kpi-card kc-purple" style="width:120px;"><div class="kpi-icon">ğŸ“¥</div><div class="kpi-num" id="sk-monthin" style="font-size:1.4rem;">â€”</div><div class="kpi-label">ì´ë‹¬ ì…ê³ </div></div>
        <div class="kpi-card kc-red" style="width:120px;"><div class="kpi-icon">âš ï¸</div><div class="kpi-num red" id="sk-low" style="font-size:1.4rem;">â€”</div><div class="kpi-label">ë¶€ì¡± ìƒí’ˆ</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:0 14px 12px;">
        <button class="btn-full btn-gold" id="btn-stock-in-full" onclick="openSheet('stock-in')">ğŸ“¥ ì…ê³  ë“±ë¡</button>
        <button class="btn-full" id="btn-stock-out-full" onclick="openSheet('stock-out')">ğŸ“¤ ì¶œê³  ë“±ë¡</button>
      </div>
      <div class="card" style="margin-bottom:14px;">
        <div id="stock-list-wrap"></div>
      </div>
    </div>

    <!-- â–¶ ì•Œë¦¼ -->
    <div class="page" id="page-alerts">
      <div class="page-header"><div><h2 id="pg-alerts-ttl">ì•Œë¦¼ ì„¼í„°</h2><p id="alert-count-label">ë¯¸í™•ì¸ ì•Œë¦¼</p></div></div>
      <div class="card" id="alert-list" style="margin-bottom:14px;"></div>
    </div>


    <!-- â–¶ í™œë™ê¸°ë¡ (íšŒì›/ê´€ë¦¬ì ê³µìš©) -->
    <div class="page" id="page-activity">

      <!-- íšŒì›ìš© -->
      <div id="act-member-view">
        <div class="page-header">
          <div><h2>ğŸ“‹ ë‚˜ì˜ í™œë™ê¸°ë¡</h2><p>í™œë™ ë‚´ì—­ì„ ì§ì ‘ ê¸°ë¡í•˜ì„¸ìš”</p></div>
        </div>

        <!-- í™”ìƒ êµìœ¡ -->
        <div class="act-card">
          <div class="act-card-head">
            <span class="act-card-title">ğŸ¥ í™”ìƒ êµìœ¡</span>
            <span class="act-card-cnt" id="cnt-online">0ê±´</span>
          </div>
          <div id="list-online"></div>
        </div>
        <button class="btn-add-act" onclick="openActSheet('online')">ï¼‹ í™”ìƒ êµìœ¡ ê¸°ë¡ ì¶”ê°€</button>

        <!-- ì„¼í„° ë°©ë¬¸ -->
        <div class="act-card">
          <div class="act-card-head">
            <span class="act-card-title">ğŸ¢ ì„¼í„° ë°©ë¬¸</span>
            <span class="act-card-cnt" id="cnt-visit">0ê±´</span>
          </div>
          <div id="list-visit"></div>
        </div>
        <button class="btn-add-act" onclick="openActSheet('visit')">ï¼‹ ì„¼í„° ë°©ë¬¸ ê¸°ë¡ ì¶”ê°€</button>

        <!-- ì˜¤í”ˆ ì„¸ë¯¸ë‚˜ -->
        <div class="act-card">
          <div class="act-card-head">
            <span class="act-card-title">ğŸ¤ ì˜¤í”ˆ ì„¸ë¯¸ë‚˜</span>
            <span class="act-card-cnt" id="cnt-seminar">0ê±´</span>
          </div>
          <div id="list-seminar"></div>
        </div>
        <button class="btn-add-act" onclick="openActSheet('seminar')">ï¼‹ ì˜¤í”ˆ ì„¸ë¯¸ë‚˜ ê¸°ë¡ ì¶”ê°€</button>

        <div style="height:20px;"></div>
      </div>

      <!-- ê´€ë¦¬ì ë¦¬í¬íŠ¸ (ê´€ë¦¬ì ì „ìš©) -->
      <div id="act-admin-view" style="display:none;">
        <div class="page-header">
          <div><h2>ğŸ“Š í™œë™Â·ë§Œì¡±ë„ ë¦¬í¬íŠ¸</h2><p>ì „ì²´ íšŒì› í˜„í™©</p></div>
        </div>

        <!-- ìš”ì•½ í†µê³„ -->
        <div class="rpt-stat-row">
          <div class="rpt-stat"><div class="rpt-stat-n" id="rpt-total-act">0</div><div class="rpt-stat-l">ì „ì²´ í™œë™</div></div>
          <div class="rpt-stat"><div class="rpt-stat-n" id="rpt-rated-cnt">0</div><div class="rpt-stat-l">í‰ê°€ ì°¸ì—¬</div></div>
          <div class="rpt-stat"><div class="rpt-stat-n" id="rpt-satisfy-pct">â€”</div><div class="rpt-stat-l">ë§Œì¡± ë¹„ìœ¨</div></div>
        </div>

        <!-- ë§Œì¡±ë„ ë¶„í¬ -->
        <div class="section-title">â­ ë§Œì¡±ë„ ë¶„í¬</div>
        <div style="padding:4px 14px 14px;">
          <div class="rpt-bar-row">
            <span class="rpt-bar-label">ğŸ˜„ ë§¤ìš°ë§Œì¡±</span>
            <div class="rpt-bar-track"><div class="rpt-bar-fill rbf-great" id="rbar-great" style="width:0%"></div></div>
            <span class="rpt-bar-pct" id="rpct-great">0ê±´</span>
          </div>
          <div class="rpt-bar-row">
            <span class="rpt-bar-label">ğŸ™‚ ë§Œì¡±</span>
            <div class="rpt-bar-track"><div class="rpt-bar-fill rbf-good" id="rbar-good" style="width:0%"></div></div>
            <span class="rpt-bar-pct" id="rpct-good">0ê±´</span>
          </div>
          <div class="rpt-bar-row">
            <span class="rpt-bar-label">ğŸ˜ ë¶ˆë§Œì¡±</span>
            <div class="rpt-bar-track"><div class="rpt-bar-fill rbf-bad" id="rbar-bad" style="width:0%"></div></div>
            <span class="rpt-bar-pct" id="rpct-bad">0ê±´</span>
          </div>
        </div>

        <!-- ë¶ˆë§Œì¡± ì˜ê²¬ -->
        <div class="section-title">ğŸ’¬ ê°œì„  ì˜ê²¬ (ë¶ˆë§Œì¡±)</div>
        <div class="card" id="rpt-bad-comments" style="margin:0 14px 14px;padding:0;overflow:hidden;">
          <div class="act-empty-box">ë¶ˆë§Œì¡± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‘</div>
        </div>

        <!-- íšŒì›ë³„ í™œë™ í˜„í™© -->
        <div class="section-title">ğŸ‘¤ íšŒì›ë³„ í™œë™ í˜„í™©</div>
        <div class="card" id="rpt-member-list" style="margin:0 14px 14px;padding:0;overflow:hidden;"></div>
      </div>
    </div>

    <!-- â–¶ ë§Œì¡±ë„ í‰ê°€ (íšŒì› ì „ìš©) -->
    <div class="page" id="page-rating">
      <div class="page-header">
        <div><h2>â­ êµ¬ë… ë§Œì¡±ë„ í‰ê°€</h2><p>ì†”ì§í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”</p></div>
      </div>

      <!-- í‰ê°€ ì…ë ¥ -->
      <div class="card" style="margin:0 14px 12px;padding:16px;">
        <div style="font-size:.82rem;font-weight:700;color:var(--text2);margin-bottom:12px;">í˜„ì¬ êµ¬ë…ì— ì–¼ë§ˆë‚˜ ë§Œì¡±í•˜ì‹œë‚˜ìš”?</div>
        <div class="rating-select-row">
          <div class="rating-opt" id="ropt-great" onclick="selectRating('great')">
            <span class="ro-emoji">ğŸ˜„</span>
            <span class="ro-txt">ë§¤ìš° ë§Œì¡±</span>
          </div>
          <div class="rating-opt" id="ropt-good" onclick="selectRating('good')">
            <span class="ro-emoji">ğŸ™‚</span>
            <span class="ro-txt">ë§Œì¡±</span>
          </div>
          <div class="rating-opt" id="ropt-bad" onclick="selectRating('bad')">
            <span class="ro-emoji">ğŸ˜</span>
            <span class="ro-txt">ë¶ˆë§Œì¡±</span>
          </div>
        </div>
        <label class="form-label">ì´ìœ  / ì˜ê²¬ <span style="color:var(--text3);font-weight:400;">(ì„ íƒ Â· ì§ì ‘ ì‘ì„±)</span></label>
        <textarea id="rating-reason" class="form-input"
          style="resize:none;height:80px;line-height:1.5;"
          placeholder="ë§Œì¡±í•˜ì‹  ì´ìœ , ê°œì„ ëìœ¼ë©´ í•˜ëŠ” ì  ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”"></textarea>
        <div id="rating-err" style="font-size:.75rem;color:var(--red);margin:-4px 0 8px;display:none;"></div>
        <button class="btn-full btn-gold" onclick="submitRating()">â­ í‰ê°€ ì œì¶œ</button>
      </div>

      <!-- ë‚´ í‰ê°€ ì´ë ¥ -->
      <div class="section-title">ğŸ“œ ë‚´ í‰ê°€ ì´ë ¥</div>
      <div class="card" id="my-rating-hist" style="margin:0 14px 20px;padding:0;overflow:hidden;">
        <div class="act-empty-box">ì•„ì§ í‰ê°€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>
    </div>

  </div><!-- /body-wrap -->

  <!-- íƒ­ë°” -->
  <nav class="tabbar" id="tabbar">
    <div class="tab-item active" id="tab-home" onclick="showTab('home')"><span class="tab-icon">ğŸ </span><span class="tab-label">í™ˆ</span></div>
    <div class="tab-item" id="tab-members" onclick="showTab('members')"><span class="tab-icon">ğŸ‘¥</span><span class="tab-label">íšŒì›</span></div>
    <div class="tab-item" id="tab-activity" onclick="showTab('activity')"><span class="tab-icon">ğŸ“‹</span><span class="tab-label" id="tab-act-label">í™œë™</span></div>
    <div class="tab-item" id="tab-rating" onclick="showTab('rating')" style="display:none;"><span class="tab-icon">â­</span><span class="tab-label">í‰ê°€</span></div>
    <div class="tab-item" id="tab-stock" onclick="showTab('stock')" style="display:none;"><span class="tab-icon">ğŸ“¦</span><span class="tab-label">ì¬ê³ </span></div>
    <div class="tab-item" id="tab-alerts" onclick="showTab('alerts')"><span class="tab-icon">ğŸ””</span><span class="tab-label">ì•Œë¦¼</span><span class="tab-badge" id="alert-badge" style="display:none;"></span></div>
  </nav>

</div><!-- /app -->


<!-- â•â•â•â• íŠ¸ë¦¬ íŒ¨ë„ ë’¤ ì˜¤ë²„ë ˆì´ (íƒ­í•˜ë©´ ë‹«í˜) â•â•â•â• -->
<div class="tree-panel-overlay" id="tree-panel-overlay" onclick="closeTreePanel()"></div>

<!-- â•â•â•â• ê°œì¸ íŠ¸ë¦¬ íŒ¨ë„ â•â•â•â• -->
<div class="tree-panel" id="tree-panel">
  <div class="panel-header">
    <div class="panel-header-row">
      <!-- â† ë’¤ë¡œê°€ê¸° -->
      <div class="back-btn" onclick="closeTreePanel()">â† ë’¤ë¡œ</div>
      <!-- ì œëª© -->
      <div style="flex:1;min-width:0;">
        <div class="panel-title" id="panel-title">ì¶”ì²œ íŠ¸ë¦¬</div>
        <div class="panel-sub-title" id="panel-subtitle">ë‚˜ì˜ í•˜ìœ„ ì¶”ì²œ ë„¤íŠ¸ì›Œí¬</div>
      </div>
      <!-- ğŸ  í™ˆ -->
      <div class="home-btn" onclick="closeTreePanel();showTab('home')">ğŸ  í™ˆ</div>
    </div>
  </div>

  <!-- í”„ë¡œí•„ -->
  <div class="profile-card">
    <div class="profile-top">
      <div class="profile-avatar" id="panel-avatar-char">ì´</div>
      <div>
        <div class="profile-name" id="panel-fullname">ì´ì² ìˆ˜</div>
        <div class="profile-detail" id="panel-contact">010-2345-6789</div>
        <div class="profile-detail" id="panel-depth-label" style="margin-top:3px;"></div>
      </div>
    </div>
    <div class="profile-stats">
      <div class="ps-item"><div class="ps-num" id="stat-direct">-</div><div class="ps-label">ì§ì ‘ ì¶”ì²œ</div></div>
      <div class="ps-item"><div class="ps-num" id="stat-indirect">-</div><div class="ps-label">ê°„ì ‘ ì¶”ì²œ</div></div>
      <div class="ps-item"><div class="ps-num" id="stat-total">-</div><div class="ps-label">ì´ í•˜ìœ„</div></div>
    </div>
    <!-- íŒ¨ë„ ë‚´ ì•¡ì…˜ ë²„íŠ¼ -->
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button onclick="openSheet('renew')" style="flex:1;padding:10px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.25);border-radius:10px;color:white;font-size:.8rem;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;">ğŸ”„ êµ¬ë… ì—°ì¥</button>
      <button onclick="closeTreePanel();showTab('home')" style="flex:1;padding:10px;background:rgba(212,168,32,0.2);border:1px solid rgba(212,168,32,0.35);border-radius:10px;color:var(--gb);font-size:.8rem;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;">ğŸ  í™ˆìœ¼ë¡œ</button>
      <button onclick="closeTreePanel()" style="flex:1;padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:rgba(255,255,255,0.7);font-size:.8rem;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;">â† ëª©ë¡</button>
    </div>
  </div>

  <!-- ğŸ”’ ìƒìœ„ ì°¨ë‹¨ ì•ˆë‚´ -->
  <div id="blocked-parent-box" style="display:none;">
    <div class="blocked-box">
      <div class="blocked-icon">ğŸ”’</div>
      <div class="blocked-title">ìƒìœ„ ì¶”ì²œì¸ì€ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
      <div class="blocked-desc">ë³¸ì¸ì˜ ìƒìœ„ ì¶”ì²œ ê²½ë¡œëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ê¶ê¸ˆí•œ ì‚¬í•­ì€ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>
    </div>
  </div>

  <!-- íŠ¸ë¦¬ ì‹œê°í™” -->
  <div class="tree-card">
    <div class="tree-card-head">
      <h3 id="tree-card-title">ğŸŒ³ ë‚˜ì˜ ì¶”ì²œ íŠ¸ë¦¬</h3>
      <div class="tree-legend">
        <span class="lc lc-me">ë‚˜ (ê¸°ì¤€)</span>
        <span class="lc lc-1">ì§ì ‘ 1ì´Œ</span>
        <span class="lc lc-2">ê°„ì ‘ 2ì´Œ+</span>
        <span class="lc lc-exp">ë§Œë£Œ</span>
      </div>
    </div>
    <div class="tree-svg-wrap">
      <svg id="panel-svg" viewBox="0 0 340 220" width="340" height="220" style="display:block;"></svg>
    </div>
    <div class="node-detail" id="node-detail">ğŸ‘† ë…¸ë“œë¥¼ í„°ì¹˜í•˜ë©´ íšŒì› ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <!-- í•˜ìœ„ íšŒì› ëª©ë¡ -->
  <div id="sub-members-wrap"></div>

  <div style="height:20px;"></div>
</div>


<!-- â•â•â•â• ë°”í…€ì‹œíŠ¸ â•â•â•â• -->
<div class="sheet-overlay" id="sheet-add-member">
  <div class="sheet">
    <div class="sheet-handle"></div>

    <!-- â”€â”€ STEP 1: ë“±ë¡ í¼ â”€â”€ -->
    <div id="reg-form-view">
      <h3>ğŸ‘¤ ì‹ ê·œ êµ¬ë…íšŒì› ë“±ë¡</h3>
      <label class="form-label">íšŒì›ëª… *</label>
      <input class="form-input" type="text" id="reg-name" placeholder="ì˜ˆ) í™ê¸¸ë™" oninput="regValidate()">
      <label class="form-label">íœ´ëŒ€í° ë²ˆí˜¸ *</label>
      <input class="form-input" type="tel" id="reg-phone" placeholder="010-0000-0000" maxlength="13"
             oninput="regFormatPhone(this);regValidate()" inputmode="numeric">
      <div class="form-row">
        <div><label class="form-label">êµ¬ë… ì‹œì‘ì¼ *</label><input class="form-input" type="date" id="reg-start"></div>
        <div><label class="form-label">êµ¬ë… ë§ˆê°ì¼ *</label><input class="form-input" type="date" id="reg-end"></div>
      </div>
      <label class="form-label">ì¶”ì²œì¸ (ì„ íƒ)</label>
      <select class="form-select" id="reg-referrer">
        <option value="">â€” ì¶”ì²œì¸ ì—†ìŒ (ROOT) â€”</option>
      </select>
      <div id="reg-err" style="font-size:.75rem;color:var(--red);margin:-6px 0 10px;display:none;"></div>
      <button class="btn-full" id="reg-submit-btn" onclick="submitRegister()">âœ… ë“±ë¡ ì™„ë£Œ â†’ ë§í¬ ìƒì„±</button>
    </div>

    <!-- â”€â”€ STEP 2: ë§í¬ ìƒì„± ê²°ê³¼ â”€â”€ -->
    <div id="reg-link-view" style="display:none;">
      <h3>ğŸ”— íšŒì› ì „ìš© ë§í¬ ìƒì„±ë¨</h3>
      <div class="link-result">
        <div class="lr-success">
          <div class="lr-icon" id="lr-icon">í™</div>
          <div>
            <div class="lr-name" id="lr-name">í™ê¸¸ë™ ë‹˜</div>
            <div class="lr-sub" id="lr-sub">010-5678-9012 Â· êµ¬ë… ë§ˆê°: 2025-03-01</div>
          </div>
        </div>
        <!-- ë§í¬ ë°•ìŠ¤ (í„°ì¹˜í•˜ë©´ ë³µì‚¬) -->
        <div class="link-box" onclick="copyMemberLink()" id="lr-link-box">
          <div class="link-box-label">ğŸ“ íšŒì› ì „ìš© ë§í¬ (í„°ì¹˜í•˜ë©´ ë³µì‚¬)</div>
          <div class="link-box-url">
            <span id="lr-link-text">ë§í¬ ìƒì„± ì¤‘...</span>
            <span class="link-copy-icon">ğŸ“‹</span>
          </div>
        </div>
        <!-- ê³µìœ  ë²„íŠ¼ë“¤ -->
        <div class="share-grid">
          <button class="sgbtn sg-kakao" onclick="shareKakao()">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</button>
          <button class="sgbtn sg-sms"   onclick="shareSMS()">ğŸ“± ë¬¸ì ì „ì†¡</button>
          <button class="sgbtn sg-copy"  onclick="copyMemberLink()">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
          <button class="sgbtn sg-copy"  onclick="copyMsgTemplate()">ğŸ“ ë¬¸ì í…œí”Œë¦¿</button>
        </div>
        <button class="sgbtn sg-new btn-full" onclick="resetRegForm()">â• ë‹¤ë¥¸ íšŒì› ë“±ë¡í•˜ê¸°</button>
      </div>
      <button class="btn-full" style="background:var(--bg);color:var(--text2);border:1px solid var(--border);"
              onclick="closeSheet('add-member');initApp()">âœ“ ì™„ë£Œ (ëª©ë¡ ìƒˆë¡œê³ ì¹¨)</button>
    </div>
  </div>
</div>
<div class="sheet-overlay" id="sheet-stock-in">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3>ğŸ“¥ ì…ê³  ì²˜ë¦¬</h3>
    <label class="form-label">ìƒí’ˆ ì„ íƒ *</label>
    <div class="si-product-row">
      <select class="form-select" id="si-product" onchange="siUpdatePreview()" style="margin-bottom:0;">
        <option value="">â€” ìƒí’ˆì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš” â€”</option>
      </select>
      <button class="btn-add-product" onclick="openProdModal('in')" title="ìƒí’ˆ ì¶”ê°€/ê´€ë¦¬">â•</button>
    </div>
    <div style="background:var(--p5);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
      <span style="font-size:.78rem;color:var(--text2);">í˜„ì¬ ì¬ê³ </span>
      <span style="font-family:'Nanum Myeongjo',serif;font-size:1.1rem;font-weight:800;color:var(--pm);" id="si-cur-qty">â€”</span>
    </div>
    <div class="form-row">
      <div><label class="form-label">ì…ê³  ìˆ˜ëŸ‰ *</label><input class="form-input" type="number" id="si-qty" placeholder="0" min="1" oninput="siUpdatePreview()"></div>
      <div><label class="form-label">ì…ê³ ì¼ *</label><input class="form-input" type="date" id="si-date"></div>
    </div>
    <div id="si-after" style="display:none;background:rgba(46,125,50,0.08);border:1px solid rgba(46,125,50,0.25);border-radius:10px;padding:10px 14px;margin-bottom:12px;justify-content:space-between;align-items:center;">
      <span style="font-size:.78rem;color:var(--green);">ì…ê³  í›„ ì¬ê³ </span>
      <span style="font-family:'Nanum Myeongjo',serif;font-size:1.1rem;font-weight:800;color:var(--green);" id="si-after-qty">â€”</span>
    </div>
    <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
    <input class="form-input" type="text" id="si-memo" placeholder="ì˜ˆ) ì •ê¸° ì…ê³ , ê¸´ê¸‰ ì¶”ê°€ ë“±">
    <div id="si-err" style="font-size:.75rem;color:var(--red);margin:-6px 0 10px;display:none;"></div>
    <button class="btn-full btn-gold" onclick="submitStockIn()">ğŸ“¥ ì…ê³  ì™„ë£Œ</button>
  </div>
</div>
<div class="sheet-overlay" id="sheet-stock-out">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3>ğŸ“¤ ì¶œê³  ì²˜ë¦¬</h3>
    <label class="form-label">ìƒí’ˆ ì„ íƒ *</label>
    <div class="si-product-row">
      <select class="form-select" id="so-product" onchange="soUpdatePreview()" style="margin-bottom:0;">
        <option value="">â€” ìƒí’ˆì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš” â€”</option>
      </select>
      <button class="btn-add-product" onclick="openProdModal('out')" title="ìƒí’ˆ ì¶”ê°€/ê´€ë¦¬">â•</button>
    </div>
    <div style="background:var(--p5);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
      <span style="font-size:.78rem;color:var(--text2);">í˜„ì¬ ì¬ê³ </span>
      <span style="font-family:'Nanum Myeongjo',serif;font-size:1.1rem;font-weight:800;color:var(--pm);" id="so-cur-qty">â€”</span>
    </div>
    <div class="form-row">
      <div><label class="form-label">ì¶œê³  ìˆ˜ëŸ‰ *</label><input class="form-input" type="number" id="so-qty" placeholder="0" min="1" oninput="soUpdatePreview()"></div>
      <div><label class="form-label">ì¶œê³ ì¼ *</label><input class="form-input" type="date" id="so-date"></div>
    </div>
    <div id="so-after" style="display:none;background:rgba(90,31,160,0.07);border:1px solid rgba(90,31,160,0.2);border-radius:10px;padding:10px 14px;margin-bottom:12px;justify-content:space-between;align-items:center;">
      <span style="font-size:.78rem;color:var(--p2);">ì¶œê³  í›„ ì¬ê³ </span>
      <span style="font-family:'Nanum Myeongjo',serif;font-size:1.1rem;font-weight:800;color:var(--p2);" id="so-after-qty">â€”</span>
    </div>
    <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
    <input class="form-input" type="text" id="so-memo" placeholder="ì˜ˆ) í™ê¸¸ë™ ì¶œê³ , ì •ê¸° ë°°ì†¡ ë“±">
    <div id="so-err" style="font-size:.75rem;color:var(--red);margin:-6px 0 10px;display:none;"></div>
    <button class="btn-full" onclick="submitStockOut()">ğŸ“¤ ì¶œê³  ì™„ë£Œ</button>
  </div>
</div>
<div class="sheet-overlay" id="sheet-renew">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3>ğŸ”„ êµ¬ë… ì—°ì¥</h3>
    <label class="form-label">í˜„ì¬ ë§ˆê°ì¼</label><input class="form-input" type="text" id="renew-cur" readonly style="background:#f5f5f5;">
    <label class="form-label">ì—°ì¥ ê¸°ê°„ *</label>
    <select class="form-select" id="renew-months" onchange="calcRenew()"><option value="1">1ê°œì›”</option><option value="3">3ê°œì›”</option><option value="6">6ê°œì›”</option><option value="12" selected>12ê°œì›”</option></select>
    <label class="form-label">ìƒˆ ë§ˆê°ì¼ (ìë™ ê³„ì‚°)</label><input class="form-input" type="text" id="new-end-date" readonly style="background:#f0ecff;color:var(--p2);font-weight:700;">
    <button class="btn-full" onclick="closeSheet('renew');toast('âœ“ êµ¬ë…ì´ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!')">ì—°ì¥ ì™„ë£Œ</button>
  </div>
</div>


<!-- â•â•â•â• ê´€ë¦¬ì ê³„ì • ì„¤ì • â•â•â•â• -->
<div class="sheet-overlay" id="sheet-admin-setting">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3>âš™ï¸ ê³„ì • ì„¤ì •</h3>

    <!-- í˜„ì¬ ê³„ì • ì •ë³´ -->
    <div class="cur-account-card">
      <div class="cur-account-row">
        <span class="cur-account-key">í˜„ì¬ ì•„ì´ë””</span>
        <span class="cur-account-val" id="cur-aid">admin</span>
      </div>
      <div class="cur-account-row">
        <span class="cur-account-key">ì´ë¦„</span>
        <span class="cur-account-val" id="cur-aname">ê´€ë¦¬ì</span>
      </div>
      <div class="cur-account-row">
        <span class="cur-account-key">ì—°ë½ì²˜</span>
        <span class="cur-account-val" id="cur-acontact">â€”</span>
      </div>
    </div>

    <!-- ì•„ì´ë”” ë³€ê²½ -->
    <label class="form-label">ìƒˆ ì•„ì´ë”” * <span style="font-size:.65rem;color:var(--text3);">(ì˜ë¬¸Â·ìˆ«ìÂ·_ 4~20ì)</span></label>
    <input class="form-input" type="text" id="new-aid"
      placeholder="ì˜ˆ) mycompany_admin" maxlength="20"
      oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">

    <!-- ì´ë¦„ ë³€ê²½ -->
    <label class="form-label">ê´€ë¦¬ì ì´ë¦„ *</label>
    <input class="form-input" type="text" id="new-aname"
      placeholder="í‘œì‹œë  ì´ë¦„" maxlength="10">

    <!-- ì—°ë½ì²˜ -->
    <label class="form-label">ì—°ë½ì²˜</label>
    <input class="form-input" type="tel" id="new-acontact"
      placeholder="010-0000-0000" maxlength="13"
      oninput="fmtPhone(this)">

    <div style="height:1px;background:var(--border);margin:16px 0;"></div>
    <div style="font-size:.75rem;font-weight:700;color:var(--text3);margin-bottom:10px;">
      ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ <span style="font-weight:400;">(ë³€ê²½ ì•ˆ í•  ê²½ìš° ë¹„ì›Œë‘ì„¸ìš”)</span>
    </div>

    <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
    <input class="form-input" type="password" id="cur-apw" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">

    <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ <span style="font-size:.65rem;color:var(--text3);">(6ì ì´ìƒ)</span></label>
    <input class="form-input" type="password" id="new-apw"
      placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" oninput="checkPwStrength(this,'pw-sbar','pw-stxt')">
    <div class="pw-strength-bar" id="pw-sbar"></div>
    <div class="pw-strength-txt" id="pw-stxt"></div>

    <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
    <input class="form-input" type="password" id="new-apw2" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">

    <div id="as-err" style="font-size:.75rem;color:var(--red);margin:-4px 0 10px;display:none;"></div>
    <div id="as-ok"  style="font-size:.75rem;color:var(--green);margin:-4px 0 10px;display:none;"></div>

    <button class="btn-full btn-gold" onclick="saveAdminSetting()">âœ… ì €ì¥</button>
    <button class="btn-full" style="background:transparent;color:var(--text3);border:1px solid var(--border);margin-top:8px;"
      onclick="closeSheet('admin-setting')">ì·¨ì†Œ</button>
  </div>
</div>


<!-- â•â•â•â• í™œë™ ê¸°ë¡ ì…ë ¥ ì‹œíŠ¸ â•â•â•â• -->
<div class="sheet-overlay" id="sheet-act-input">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3 id="act-sheet-title">ğŸ“‹ í™œë™ ê¸°ë¡ ì¶”ê°€</h3>

    <!-- ì°¸ì„ ì—¬ë¶€ -->
    <label class="form-label">ì°¸ì„ ì—¬ë¶€ *</label>
    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <button id="abtn-attend" onclick="setAttend('attend')"
        style="flex:1;padding:10px;border-radius:10px;border:2px solid var(--border);
          background:var(--card);font-size:.82rem;font-weight:700;cursor:pointer;
          font-family:'Noto Sans KR',sans-serif;transition:all .15s;"
        >âœ… ì°¸ì„</button>
      <button id="abtn-absent" onclick="setAttend('absent')"
        style="flex:1;padding:10px;border-radius:10px;border:2px solid var(--border);
          background:var(--card);font-size:.82rem;font-weight:700;cursor:pointer;
          font-family:'Noto Sans KR',sans-serif;transition:all .15s;"
        >âŒ ë¶ˆì°¸</button>
    </div>

    <!-- ì¼ì‹œ / ì¥ì†Œ -->
    <div class="form-row">
      <div>
        <label class="form-label">ì¼ì‹œ *</label>
        <input class="form-input" type="date" id="act-date">
      </div>
      <div>
        <label class="form-label">ì‹œê°„</label>
        <input class="form-input" type="time" id="act-time" placeholder="14:00">
      </div>
    </div>
    <label class="form-label">ì¥ì†Œ</label>
    <input class="form-input" type="text" id="act-place" placeholder="ì˜ˆ) ë³¸ì‚¬ 2ì¸µ êµìœ¡ì¥, ì˜¨ë¼ì¸(Zoom)">

    <label class="form-label">ë©”ëª¨ / ë‚´ìš©</label>
    <textarea class="form-input" id="act-memo" style="resize:none;height:70px;line-height:1.5;"
      placeholder="êµìœ¡ ì£¼ì œ, ê°•ì‚¬ëª…, ëŠë‚€ ì  ë“± ììœ ë¡­ê²Œ ê¸°ë¡"></textarea>

    <div id="act-err" style="font-size:.75rem;color:var(--red);margin:-4px 0 10px;display:none;"></div>
    <button class="btn-full btn-gold" onclick="submitActRecord()">ğŸ“‹ ê¸°ë¡ ì €ì¥</button>
    <button class="btn-full" style="background:transparent;color:var(--text3);border:1px solid var(--border);margin-top:8px;"
      onclick="closeSheet('act-input')">ì·¨ì†Œ</button>
  </div>
</div>

<!-- â•â•â•â• ê´€ë¦¬ì íšŒì› í™œë™ ìƒì„¸ íŒ¨ë„ â•â•â•â• -->
<div class="rpt-detail-overlay" id="rpt-detail-overlay" onclick="if(event.target===this)closeRptDetail()">
  <div class="rpt-detail-panel">
    <div class="rpt-detail-head">
      <span class="rpt-detail-name" id="rpt-detail-name">íšŒì›ëª…</span>
      <button onclick="closeRptDetail()"
        style="background:transparent;border:none;font-size:1.2rem;cursor:pointer;color:var(--text3);">âœ•</button>
    </div>
    <div id="rpt-detail-body" style="padding:14px;"></div>
  </div>
</div>

<div id="toast"></div>

<script>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“±/ğŸ–¥ï¸ ë·°ëª¨ë“œ ì „í™˜ ì‹œìŠ¤í…œ
   - 'mobile'  : í•˜ë‹¨ íƒ­ë°”, 430px ì¤‘ì•™, ì‚¬ì´ë“œë°” ìˆ¨ê¹€
   - 'desktop' : ì‚¬ì´ë“œë°”, í’€í­, íƒ­ë°” ìˆ¨ê¹€
   - 'auto'    : í™”ë©´ ë„ˆë¹„ì— ë”°ë¼ ìë™ (ê¸°ë³¸ê°’ ì•„ë‹˜)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let VIEW_MODE = (function(){
  try { return localStorage.getItem('erp_view') || 'mobile'; } catch(e){ return 'mobile'; }
})();

function setViewMode(mode){
  VIEW_MODE = mode;
  try { localStorage.setItem('erp_view', mode); } catch(e){}
  applyViewMode();
}

function applyViewMode(){
  const body = document.body;

  /* í´ë˜ìŠ¤ ì´ˆê¸°í™” */
  body.classList.remove('mode-mobile','mode-desktop');

  if(VIEW_MODE === 'desktop'){
    body.classList.add('mode-desktop');
  } else {
    body.classList.add('mode-mobile');
  }

  /* ë²„íŠ¼ í™œì„±í™” í‘œì‹œ */
  const bm = document.getElementById('view-mobile');
  const bd = document.getElementById('view-desktop');
  if(bm){ bm.classList.toggle('view-active', VIEW_MODE==='mobile'); }
  if(bd){ bd.classList.toggle('view-active', VIEW_MODE==='desktop'); }

  /* ì‚¬ì´ë“œë°” ë‚´ í˜„ì¬ í™œì„± íƒ­ ë™ê¸°í™” */
  const activePage = document.querySelector('.page.active');
  if(activePage){
    const pageId = activePage.id.replace('page-','');
    document.querySelectorAll('.sb-item').forEach(s=>s.classList.remove('sb-active'));
    const sbw = document.getElementById('sb-'+pageId+'-wrap');
    if(sbw) sbw.classList.add('sb-active');
  }
}

/* í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì ìš© */
(function(){ applyViewMode(); })();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ i18n â€” í•œêµ­ì–´ / English
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let LANG = (function(){
  try{ return localStorage.getItem('erp_lang')||'ko'; }catch(e){ return 'ko'; }
})();

const I18N = {
  ko:{
    appName:'ë‚´ëª¸ì• ë§ê²Œ', appSub:'ERP',
    tabHome:'í™ˆ', tabMembers:'íšŒì›', tabStock:'ì¬ê³ ', tabAlerts:'ì•Œë¦¼',
    secSummary:'ğŸ“Š í˜„í™© ìš”ì•½', secQuick:'âš¡ ë¹ ë¥¸ ì‹¤í–‰', secExpiring:'â° ë§Œë£Œ ì„ë°•', secActivity:'ğŸ• ìµœê·¼ í™œë™',
    btnRegMember:'íšŒì›\në“±ë¡', btnStockIn:'ì…ê³ \nì²˜ë¦¬', btnStockOut:'ì¶œê³ \nì²˜ë¦¬', btnViewAlerts:'ì•Œë¦¼\ní™•ì¸',
    moreAll:'ì „ì²´ â†’',
    kpiNetwork:'ë‚´ ë„¤íŠ¸ì›Œí¬', kpiAllMembers:'ì „ì²´ íšŒì›',
    kpiExpiring:'ë§Œë£Œ ì„ë°•', kpiStock:'ì´ ì¬ê³ ', kpiLowStock:'ë¶€ì¡± ìƒí’ˆ',
    kpiDirect:'ì§ì ‘ ì¶”ì²œ', kpiMonthly:'ì´ë‹¬ ì¶”ì²œ',
    pageMembers:'êµ¬ë…íšŒì› ê´€ë¦¬', pageMembersSub:'ì´ë¦„ì„ ëˆ„ë¥´ë©´ ê°œì¸ ì¶”ì²œ íŠ¸ë¦¬ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”',
    searchPlaceholder:'íšŒì›ëª… ê²€ìƒ‰', btnAddMember:'+ ë“±ë¡',
    pageStock:'ì¬ê³  ê´€ë¦¬', pageStockSub:'ì…ê³  Â· ì¶œê³  Â· ì¬ê³  í˜„í™©',
    btnStockInFull:'ğŸ“¥ ì…ê³  ë“±ë¡', btnStockOutFull:'ğŸ“¤ ì¶œê³  ë“±ë¡',
    pageAlerts:'ì•Œë¦¼ ì„¼í„°',
    loginTitle:'ERP ë¡œê·¸ì¸', loginIdPh:'ì•„ì´ë””', loginPwPh:'ë¹„ë°€ë²ˆí˜¸',
    loginBtn:'ë¡œê·¸ì¸', loginErr:'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    loginQuick:'ë¹ ë¥¸ ë¡œê·¸ì¸ (ë°ëª¨)',
    sheetAddTitle:'ğŸ‘¤ ì‹ ê·œ êµ¬ë…íšŒì› ë“±ë¡',
    fldName:'íšŒì›ëª… *', fldPhone:'íœ´ëŒ€í° ë²ˆí˜¸ *',
    fldStart:'êµ¬ë… ì‹œì‘ì¼ *', fldEnd:'êµ¬ë… ë§ˆê°ì¼ *',
    fldReferrer:'ì¶”ì²œì¸ (ì„ íƒ)', optNoRef:'â€” ì¶”ì²œì¸ ì—†ìŒ (ROOT) â€”',
    btnSubmitReg:'âœ… ë“±ë¡ ì™„ë£Œ â†’ ë§í¬ ìƒì„±',
    sheetInTitle:'ğŸ“¥ ì…ê³  ì²˜ë¦¬', sheetOutTitle:'ğŸ“¤ ì¶œê³  ì²˜ë¦¬',
    fldProduct:'ìƒí’ˆ ì„ íƒ *', fldCurStock:'í˜„ì¬ ì¬ê³ ',
    fldInQty:'ì…ê³  ìˆ˜ëŸ‰ *', fldInDate:'ì…ê³ ì¼ *', fldAfterIn:'ì…ê³  í›„ ì¬ê³ ',
    fldOutQty:'ì¶œê³  ìˆ˜ëŸ‰ *', fldOutDate:'ì¶œê³ ì¼ *', fldAfterOut:'ì¶œê³  í›„ ì¬ê³ ',
    fldMemo:'ë©”ëª¨ (ì„ íƒ)', phMemoIn:'ì˜ˆ) ì •ê¸° ì…ê³ , ê¸´ê¸‰ ì¶”ê°€ ë“±', phMemoOut:'ì˜ˆ) í™ê¸¸ë™ ì¶œê³ , ì •ê¸° ë°°ì†¡ ë“±',
    btnStockInDone:'ğŸ“¥ ì…ê³  ì™„ë£Œ', btnStockOutDone:'ğŸ“¤ ì¶œê³  ì™„ë£Œ',
    sheetRenewTitle:'ğŸ”„ êµ¬ë… ì—°ì¥',
    fldCurEnd:'í˜„ì¬ ë§ˆê°ì¼', fldExtend:'ì—°ì¥ ê¸°ê°„ *', fldNewEnd:'ìƒˆ ë§ˆê°ì¼',
    opt1m:'1ê°œì›”', opt3m:'3ê°œì›”', opt6m:'6ê°œì›”', opt1y:'1ë…„',
    btnRenewDone:'âœ… ì—°ì¥ ì™„ë£Œ',
    rolAdmin:'ğŸ‘‘ ê´€ë¦¬ì',
    labelActive:'í™œì„±', labelWarn:'ì„ë°•', labelExpired:'ë§Œë£Œ',
    noExpiring:'âœ… ë§Œë£Œ ì„ë°• íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤',
    btnRenew:'ì—°ì¥',
    companyStatTitle:'ğŸ¢ íšŒì‚¬ ì „ì²´ êµ¬ë… í˜„í™©',
    monthlyActive:'ì´ë‹¬ í™œì„± êµ¬ë…ì', nextSettle:'ë‹¤ìŒ ì •ì‚°ê¹Œì§€',
    prevSame:'ì „ì›”ê³¼ ë™ì¼', prevUp:'â–² {n}ëª… ì¦ê°€', prevDown:'â–¼ {n}ëª… ê°ì†Œ',
    statActive:'âœ… í™œì„±', statWarn:'âš ï¸ ë§Œë£Œ ì„ë°•', statExpired:'âŒ ë§Œë£Œ',
    monthChart:'ğŸ“… ì›”ë³„ í™œì„± êµ¬ë…ì ì¶”ì´',
    settleInfo:'ë§¤ì›” 1ì¼ 00:00 ìë™ ì •ì‚° Â· ë‹¤ìŒ ì •ì‚°: {d}',
    sidebarTitle:'MENU',
    days:['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],
    dateFormat:'{y}ë…„ {m}ì›” {d}ì¼ ({w}ìš”ì¼)',
  },
  en:{
    appName:'MyBodyFit', appSub:'ERP',
    tabHome:'Home', tabMembers:'Members', tabStock:'Stock', tabAlerts:'Alerts',
    secSummary:'ğŸ“Š Overview', secQuick:'âš¡ Quick Actions', secExpiring:'â° Expiring Soon', secActivity:'ğŸ• Recent Activity',
    btnRegMember:'Add\nMember', btnStockIn:'Stock\nIn', btnStockOut:'Stock\nOut', btnViewAlerts:'View\nAlerts',
    moreAll:'All â†’',
    kpiNetwork:'My Network', kpiAllMembers:'Total Members',
    kpiExpiring:'Expiring', kpiStock:'Total Stock', kpiLowStock:'Low Stock',
    kpiDirect:'Direct Ref.', kpiMonthly:'Monthly Ref.',
    pageMembers:'Member Management', pageMembersSub:'Tap a name to view their referral tree',
    searchPlaceholder:'Search members', btnAddMember:'+ Add',
    pageStock:'Inventory', pageStockSub:'In Â· Out Â· Stock Overview',
    btnStockInFull:'ğŸ“¥ Stock In', btnStockOutFull:'ğŸ“¤ Stock Out',
    pageAlerts:'Notifications',
    loginTitle:'ERP Login', loginIdPh:'Username', loginPwPh:'Password',
    loginBtn:'Sign In', loginErr:'Invalid username or password.',
    loginQuick:'Quick Login (Demo)',
    sheetAddTitle:'ğŸ‘¤ New Member Registration',
    fldName:'Name *', fldPhone:'Phone *',
    fldStart:'Start Date *', fldEnd:'End Date *',
    fldReferrer:'Referrer (Optional)', optNoRef:'â€” No Referrer (ROOT) â€”',
    btnSubmitReg:'âœ… Register & Generate Link',
    sheetInTitle:'ğŸ“¥ Stock In', sheetOutTitle:'ğŸ“¤ Stock Out',
    fldProduct:'Select Product *', fldCurStock:'Current Stock',
    fldInQty:'Quantity *', fldInDate:'Date *', fldAfterIn:'Stock After In',
    fldOutQty:'Quantity *', fldOutDate:'Date *', fldAfterOut:'Stock After Out',
    fldMemo:'Memo (Optional)', phMemoIn:'e.g. Regular restock, Urgent order', phMemoOut:'e.g. John delivery, Regular shipment',
    btnStockInDone:'ğŸ“¥ Confirm Stock In', btnStockOutDone:'ğŸ“¤ Confirm Stock Out',
    sheetRenewTitle:'ğŸ”„ Renew Subscription',
    fldCurEnd:'Current End Date', fldExtend:'Extension *', fldNewEnd:'New End Date',
    opt1m:'1 Month', opt3m:'3 Months', opt6m:'6 Months', opt1y:'1 Year',
    btnRenewDone:'âœ… Confirm Renewal',
    rolAdmin:'ğŸ‘‘ Admin',
    labelActive:'Active', labelWarn:'Warning', labelExpired:'Expired',
    noExpiring:'âœ… No members expiring soon',
    btnRenew:'Renew',
    companyStatTitle:'ğŸ¢ Company Subscriptions',
    monthlyActive:'Active Subscribers This Month', nextSettle:'Next reset in',
    prevSame:'Same as last month', prevUp:'â–² +{n} increase', prevDown:'â–¼ -{n} decrease',
    statActive:'âœ… Active', statWarn:'âš ï¸ Expiring', statExpired:'âŒ Expired',
    monthChart:'ğŸ“… Monthly Active Subscribers',
    settleInfo:'Auto reset on 1st of each month Â· Next: {d}',
    sidebarTitle:'MENU',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    dateFormat:'{w}, {m}/{d}/{y}',
  }
};

function t(key, vars){
  const dict = I18N[LANG] || I18N.ko;
  let val = dict[key] !== undefined ? dict[key] : (I18N.ko[key] || key);
  if(vars) Object.entries(vars).forEach(([k,v])=>{ val=val.replace('{'+k+'}',v); });
  return val;
}

function setLang(lang){
  LANG = lang;
  try{ localStorage.setItem('erp_lang', lang); }catch(e){}
  applyLang();
}

function applyLang(){
  /* ë²„íŠ¼ í™œì„±í™” */
  const bKo=document.getElementById('lang-ko'), bEn=document.getElementById('lang-en');
  if(bKo){ bKo.classList.toggle('lang-active', LANG==='ko'); }
  if(bEn){ bEn.classList.toggle('lang-active', LANG==='en'); }

  /* html lang */
  document.documentElement.lang = LANG;

  /* íƒ­ ë¼ë²¨ */
  [['tab-home','tabHome'],['tab-members','tabMembers'],
   ['tab-stock','tabStock'],['tab-alerts','tabAlerts']].forEach(([id,key])=>{
    const el=document.querySelector('#'+id+' .tab-label');
    if(el) el.textContent=t(key);
  });

  /* ì‚¬ì´ë“œë°” ë¼ë²¨ */
  [['sb-home','tabHome'],['sb-members','tabMembers'],
   ['sb-stock','tabStock'],['sb-alerts','tabAlerts']].forEach(([id,key])=>{
    const el=document.getElementById(id);
    if(el) el.textContent=t(key);
  });

  /* ê²€ìƒ‰ placeholder */
  const sp=document.getElementById('member-search');
  if(sp) sp.placeholder=t('searchPlaceholder');

  /* íšŒì› ë“±ë¡ ë²„íŠ¼ */
  const ab=document.getElementById('add-member-btn');
  if(ab) ab.textContent=t('btnAddMember');

  /* ë¡œê·¸ì¸ */
  const li=document.getElementById('login-id-inp');
  if(li) li.placeholder=t('loginIdPh');
  const lp=document.getElementById('login-pw-inp');
  if(lp) lp.placeholder=t('loginPwPh');
  const lb=document.getElementById('login-btn');
  if(lb) lb.textContent=t('loginBtn');

  /* ì„¹ì…˜ íƒ€ì´í‹€ ê°±ì‹  */
  const _lbls = {
    'lbl-summary':  LANG==='en'?'ğŸ“Š Overview':'ğŸ“Š í˜„í™© ìš”ì•½',
    'lbl-expiring': LANG==='en'?'â° Expiring Soon':'â° ë§Œë£Œ ì„ë°•',
    'lbl-more-all': LANG==='en'?'All â†’':'ì „ì²´ â†’',
    'lbl-activity': LANG==='en'?'ğŸ• Recent Activity':'ğŸ• ìµœê·¼ í™œë™',
  };
  Object.entries(_lbls).forEach(([id,txt])=>{ const e=document.getElementById(id);if(e)e.textContent=txt; });

  /* í˜ì´ì§€/ë²„íŠ¼ í…ìŠ¤íŠ¸ */
  const _pageMap = {
    'members-title': t('pageMembers'),
    'members-desc':  t('pageMembersSub'),
    'pg-stock-ttl':  t('pageStock'),
    'pg-stock-sub':  t('pageStockSub'),
    'pg-alerts-ttl': t('pageAlerts'),
    'btn-stock-in-full':  t('btnStockInFull'),
    'btn-stock-out-full': t('btnStockOutFull'),
    'add-member-btn':     t('btnAddMember'),
  };
  Object.entries(_pageMap).forEach(([id,txt])=>{ const e=document.getElementById(id);if(e)e.textContent=txt; });

  /* ë·°ëª¨ë“œ ìœ ì§€ */
  if(typeof applyViewMode === 'function') applyViewMode();
}

/* â•â•â•â• ì•± ì‹œì‘: DB ë¡œë“œ í›„ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ â•â•â•â• */
(async function startApp(){
  try {
    await loadAllDataFromDB();
  } catch(e) {
    console.error('startApp ì˜¤ë¥˜:', e);
  }
  /* DB ë¡œë”© í™”ë©´ ìˆ¨ê¹€ â†’ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ */
  const dbLoading = document.getElementById('db-loading');
  if(dbLoading) dbLoading.style.display = 'none';
  console.log('âœ… ì•± ì‹œì‘ ì™„ë£Œ â€” ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ');

  /* ìŠ¬ë¦½ ë°©ì§€: 5ë¶„ë§ˆë‹¤ DB í•‘ */
  setInterval(async () => {
    try { await supa.from('members').select('id').limit(1); }
    catch(e) { console.log('í•‘ ì‹¤íŒ¨:', e); }
  }, 5 * 60 * 1000);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì²´ íšŒì› ë°ì´í„° (ê´€ë¦¬ìë§Œ ì „ë¶€ ì ‘ê·¼)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ALL_MEMBERS = {}; /* DBì—ì„œ ë¡œë“œ */
const STOCK_DATA_RESET = {}; /* ì´ˆê¸°ê°’ */

/* â”€â”€ DB í–‰ â†’ ì•± ê°ì²´ ë³€í™˜ â”€â”€ */
function dbRowToMember(row){
  const today = new Date();
  const end   = new Date(row.end_date);
  const ddays = Math.ceil((end - today) / 86400000);
  return {
    id:         row.id,
    pw:         row.pw,
    name:       row.name,
    initial:    row.name?.[0] || '?',
    role:       row.role,
    contact:    row.contact || '',
    referrerId: row.referrer_id || null,
    startDate:  row.start_date || '',
    endDate:    row.end_date   || '',
    status:     row.status     || 'active',
    depth:      row.depth      || 0,
    depthLabel: row.depth_label|| 'ROOT',
    avatar:     row.avatar     || 'av-purple',
    dday:       ddays > 0 ? 'D-'+ddays : 'D+'+Math.abs(ddays),
    ddayClass:  ddays > 30 ? 'safe' : ddays > 7 ? 'warn' : ddays > 0 ? 'danger' : 'expired',
    direct:0, indirect:0, total:0,
    activities: { online:[], visit:[], seminar:[] },
    ratings:    []
  };
}

function dbRowToProduct(row){
  return {
    code: row.code, name: row.name,
    qty:  row.qty,  safe: row.safe, max: row.max,
    monthly:{ labels:['8ì›”','9ì›”','10ì›”','11ì›”','12ì›”','1ì›”'], inArr:[0,0,0,0,0,0], outArr:[0,0,0,0,0,0] },
    history:[]
  };
}

/* â”€â”€ ì•± ì‹œì‘ ì‹œ ì „ì²´ ë°ì´í„° ë¡œë“œ â”€â”€ */
async function loadAllDataFromDB(){
  const setTxt = t => {
    const el = document.getElementById('db-loading-txt');
    if(el) el.textContent = t;
  };

  try {
    setTxt('íšŒì› ë°ì´í„° ë¡œë“œ ì¤‘...');
    const { data:mRows, error:mErr } = await supa.from('members').select('*');
    if(mErr) throw mErr;
    (mRows||[]).forEach(row => { ALL_MEMBERS[row.id] = dbRowToMember(row); });
    console.log('íšŒì› ë¡œë“œ ì™„ë£Œ:', (mRows||[]).length + 'ëª…');

    setTxt('ìƒí’ˆ ë°ì´í„° ë¡œë“œ ì¤‘...');
    const { data:pRows, error:pErr } = await supa.from('products').select('*');
    if(pErr) throw pErr;
    (pRows||[]).forEach(row => { STOCK_DATA[row.code] = dbRowToProduct(row); });
    console.log('ìƒí’ˆ ë¡œë“œ ì™„ë£Œ:', (pRows||[]).length + 'ê°œ');

    setTxt('ì…ì¶œê³  ì´ë ¥ ë¡œë“œ ì¤‘...');
    const { data:hRows, error:hErr } = await supa.from('stock_history').select('*').order('created_at',{ascending:false}).limit(200);
    if(hErr) throw hErr;
    (hRows||[]).forEach(row => {
      const p = STOCK_DATA[row.product_code];
      if(p) p.history.push({ t:row.type, q:row.qty, d:row.date, m:row.memo||'' });
    });

    setTxt('í™œë™ ê¸°ë¡ ë¡œë“œ ì¤‘...');
    const { data:aRows, error:aErr } = await supa.from('activities').select('*').order('date',{ascending:false}).limit(500);
    if(aErr) throw aErr;
    (aRows||[]).forEach(row => {
      const m = ALL_MEMBERS[row.member_id];
      if(m && m.activities?.[row.type]){
        m.activities[row.type].push({
          id:row.id, date:row.date, time:row.time||'',
          place:row.place||'', attend:row.attend||'attend', memo:row.memo||''
        });
      }
    });

    setTxt('í‰ê°€ ë°ì´í„° ë¡œë“œ ì¤‘...');
    const { data:rRows, error:rErr } = await supa.from('ratings').select('*').order('created_at',{ascending:false}).limit(500);
    if(rErr) throw rErr;
    (rRows||[]).forEach(row => {
      const m = ALL_MEMBERS[row.member_id];
      if(m) m.ratings.push({ id:row.id, level:row.level, reason:row.reason||'', date:row.date });
    });

    setTxt('ì™„ë£Œ!');
    console.log('âœ… ì „ì²´ DB ë¡œë“œ ì™„ë£Œ');

  } catch(e) {
    console.error('DB ë¡œë“œ ì˜¤ë¥˜:', e);
    if(!ALL_MEMBERS['admin']){
      ALL_MEMBERS['admin'] = {
        id:'admin', pw:'admin123', name:'ê´€ë¦¬ì', role:'admin',
        initial:'ê´€', contact:'', referrerId:null,
        startDate:'2024-01-01', endDate:'2099-12-31',
        status:'active', depth:0, depthLabel:'',
        avatar:'av-purple', dday:'', ddayClass:'ok',
        direct:0, indirect:0, total:0,
        activities:{online:[],visit:[],seminar:[]}, ratings:[]
      };
    }
    alert('âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
  }
}

/* â”€â”€ í•˜ìœ„ íšŒì› ê³„ì‚° â”€â”€ */
function getDirectChildren(id){ return Object.values(ALL_MEMBERS).filter(m=>m.referrerId===id); }
function getAllDescendants(id){
  const result=[];
  function walk(pid){ getDirectChildren(pid).forEach(c=>{ result.push(c); walk(c.id); }); }
  walk(id); return result;
}
/* í•´ë‹¹ íšŒì›ì´ ë³¼ ìˆ˜ ìˆëŠ” íšŒì› ëª©ë¡ (ë³¸ì¸ + í•˜ìœ„ ì „ì²´) */
function getVisibleMembers(viewerId){
  if(viewerId==='admin') return Object.values(ALL_MEMBERS).filter(m=>m.id!=='admin');
  return [ALL_MEMBERS[viewerId], ...getAllDescendants(viewerId)];
}

/* â•â•â•â• ë¡œê·¸ì¸ ìƒíƒœ â•â•â•â• */
let CURRENT_USER = null;

/* â•â•â•â• ë¡œê·¸ì¸ â•â•â•â• */
async function doLogin(){
  const _idEl=document.getElementById('login-id-inp');
  const _pwEl=document.getElementById('login-pw-inp');
  if(!_idEl||!_pwEl) return;
  const id=_idEl.value.trim();
  const pw=_pwEl.value.trim();
  if(!id||!pw){ document.getElementById('login-error').style.display='block'; return; }

  /* ë¡œê·¸ì¸ ë²„íŠ¼ ë¹„í™œì„±í™” */
  const btn = document.querySelector('.login-btn');
  if(btn){ btn.textContent='í™•ì¸ ì¤‘...'; btn.disabled=true; }

  try {
    const { data, error } = await supa
      .from('members')
      .select('*')
      .eq('id', id)
      .eq('pw', pw)
      .single();

    if(error || !data){
      document.getElementById('login-error').style.display='block';
      if(btn){ btn.textContent='ë¡œê·¸ì¸'; btn.disabled=false; }
      return;
    }
    /* DB ë°ì´í„°ë¥¼ ALL_MEMBERSì— ë§¤í•‘ */
    ALL_MEMBERS[data.id] = dbRowToMember(data);
    loginAs(ALL_MEMBERS[data.id]);
  } catch(e){
    dbErr('ë¡œê·¸ì¸', e);
    if(btn){ btn.textContent='ë¡œê·¸ì¸'; btn.disabled=false; }
  }
}
function quickLogin(id){ loginAs(ALL_MEMBERS[id]); }
function loginAs(user){
  CURRENT_USER = user;
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').classList.add('show');
  document.getElementById('login-error').style.display='none';
  const _liEl=document.getElementById('login-id-inp');
  const _lpEl=document.getElementById('login-pw-inp');
  if(_liEl) _liEl.value='';
  if(_lpEl) _lpEl.value='';
  initApp();
  applyLang();
  applyViewMode();
}
function doLogout(){
  if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  CURRENT_USER=null;
  document.getElementById('app').classList.remove('show');
  document.getElementById('login-screen').style.display='flex';
  showTab('home');
}

/* â•â•â•â• ì•± ì´ˆê¸°í™” (ë¡œê·¸ì¸ í›„) â•â•â•â• */
function initApp(){
  const u = CURRENT_USER;
  const isAdmin = u.role==='admin';

  // í—¤ë” ìœ ì €ì¹©
  document.getElementById('uc-avatar').textContent = u.initial;
  document.getElementById('uc-name').textContent = u.name;
  document.getElementById('uc-role').textContent = isAdmin ? t('rolAdmin') : u.depthLabel;

  // ë‚ ì§œ
  (function(){ const _d=new Date(),_w=t('days')[_d.getDay()];
    document.getElementById('today-date').textContent = LANG==='en'
      ? _w+', '+(_d.getMonth()+1)+'/'+_d.getDate()+'/'+_d.getFullYear()
      : _d.getFullYear()+'ë…„ '+(_d.getMonth()+1)+'ì›” '+_d.getDate()+'ì¼ ('+_w+'ìš”ì¼)';
  })();

  // ê´€ë¦¬ì ì „ìš© UI
  document.getElementById('admin-quick').style.display = isAdmin?'block':'none';
  document.getElementById('add-member-btn').style.display = isAdmin?'':'none';
  const stockTab = document.getElementById('tab-stock');
  stockTab.style.display = isAdmin?'':'none';
  document.getElementById('notif-btn').onclick = isAdmin ? ()=>showTab('alerts') : ()=>showTab('alerts');

  // ì‚¬ì´ë“œë°” ì¬ê³ íƒ­
  const _sbSt=document.getElementById('sb-stock-wrap');
  if(_sbSt) _sbSt.style.display=isAdmin?'':'none';

  // KPI
  renderKPI(u, isAdmin);
  renderBanners(u, isAdmin);
  renderExpireList(u, isAdmin);
  renderMemberList(u, isAdmin);
  renderAlerts(u, isAdmin);

  // ì•Œë¦¼ ë°°ì§€ ì‚¬ì´ë“œë°” ë™ê¸°í™”
  setTimeout(()=>{
    const _tb=document.getElementById('alert-badge');
    const _sb=document.getElementById('sb-alert-badge');
    if(_sb&&_tb){_sb.textContent=_tb.textContent;_sb.style.display=_tb.textContent?'':'none';}
  },120);
  // ì¬ê³  ëª©ë¡ ë™ì  ë Œë” + ë“œë¡­ë‹¤ìš´ ë™ê¸°í™”
  renderStockList();
  syncProductSelects(null);
}

/* â”€â”€ KPI ë Œë” â”€â”€ */
function renderKPI(u, isAdmin){
  const visible = getVisibleMembers(u.id);
  const active = visible.filter(m=>m.status==='active').length;
  const expiring = visible.filter(m=>['d0','d7'].includes(m.ddayClass)).length;
  let html = `
    <div class="kpi-card kc-purple"><div class="kpi-icon">ğŸ‘¥</div><div class="kpi-num">${visible.length}</div><div class="kpi-label">${isAdmin?'ì „ì²´ íšŒì›':'ë‚´ ë„¤íŠ¸ì›Œí¬'}</div></div>
    <div class="kpi-card kc-red"><div class="kpi-icon">â°</div><div class="kpi-num red">${expiring}</div><div class="kpi-label">ë§Œë£Œ ì„ë°•</div></div>`;
  if(isAdmin){
    const _tot = typeof STOCK_DATA!=='undefined' ? Object.values(STOCK_DATA).reduce((s,p)=>s+p.qty,0) : 0;
    const _low = typeof STOCK_DATA!=='undefined' ? Object.values(STOCK_DATA).filter(p=>p.qty<p.safe).length : 0;
    html += `<div class="kpi-card kc-gold" onclick="showTab('stock')" style="cursor:pointer;"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-num" id="kpi-total-stock">${_tot.toLocaleString()}</div><div class="kpi-label">ì´ ì¬ê³ </div></div>`;
    if(_low>0) html += `<div class="kpi-card kc-red" onclick="showTab('stock')" style="cursor:pointer;"><div class="kpi-icon">âš ï¸</div><div class="kpi-num red" id="kpi-low-stock">${_low}</div><div class="kpi-label">ë¶€ì¡± ìƒí’ˆ</div></div>`;
  }
  html += `<div class="kpi-card kc-green"><div class="kpi-icon">ğŸŒ³</div><div class="kpi-num">${u.direct||0}</div><div class="kpi-label">${isAdmin?'ì´ë‹¬ ì¶”ì²œ':'ì§ì ‘ ì¶”ì²œ'}</div></div>`;
  document.getElementById('kpi-area').innerHTML = html;
  const _dcw=document.getElementById('dashboard-chart-wrap');
  const _scw=document.getElementById('stock-summary-chart');
  if(isAdmin){
    if(_dcw) _dcw.style.display='block';
    if(_scw) _scw.style.display='block';
    setTimeout(()=>{ renderDashboardChart(); renderStockSummaryChart(); refreshStockKPI(); }, 80);
  } else {
    if(_dcw) _dcw.style.display='none';
    if(_scw) _scw.style.display='none';
  }
  // â˜… ì›”ë³„ êµ¬ë… í˜„í™© ì¹´ë“œ (ê´€ë¦¬ì/íšŒì› ëª¨ë‘)
  setTimeout(renderSubStatCard, 100);
}

/* â”€â”€ ë°°ë„ˆ ë Œë” â”€â”€ */
function renderBanners(u, isAdmin){
  let html='';
  if(isAdmin){
    const _todayExp = getVisibleMembers(u.id).filter(m=>m.ddayClass==='d0');
    const _weekExp  = getVisibleMembers(u.id).filter(m=>m.ddayClass==='d7');
    if(_todayExp.length>0) html += `<div class="banner urgent" onclick="this.remove()"><span>ğŸš¨</span><div style="flex:1;"><strong>ì˜¤ëŠ˜ ë§Œë£Œ ${_todayExp.length}ëª…</strong> â€” ${_todayExp.map(m=>m.name).join(', ')} ë‹˜</div><span class="banner-x">âœ•</span></div>`;
    if(_weekExp.length>0)  html += `<div class="banner warn"   onclick="this.remove()"><span>âš ï¸</span><div style="flex:1;"><strong>7ì¼ë‚´ ë§Œë£Œ ${_weekExp.length}ëª…</strong> â€” ${_weekExp.map(m=>m.name).join(', ')}</div><span class="banner-x">âœ•</span></div>`;
    if(typeof STOCK_DATA!=='undefined'){
      const _lowItems=Object.values(STOCK_DATA).filter(p=>p.qty<p.safe);
      if(_lowItems.length>0) html += `<div class="banner warn" onclick="showTab('stock')"><span>ğŸ“¦</span><div style="flex:1;"><strong>ì¬ê³  ë¶€ì¡± ${_lowItems.length}í’ˆëª©</strong> â€” ${_lowItems.map(p=>p.name+' '+p.qty+'ê°œ').join(', ')}</div><span class="banner-x">â†’</span></div>`;
    }
  } else {
    // ë³¸ì¸ ë§Œë£Œ ì„ë°•
    if(u.ddayClass==='d0') html += `<div class="banner urgent" onclick="this.remove()"><span>ğŸš¨</span><div style="flex:1;"><strong>ì˜¤ëŠ˜ êµ¬ë… ë§Œë£Œ</strong> â€” ê´€ë¦¬ìì—ê²Œ ì—°ì¥ì„ ìš”ì²­í•˜ì„¸ìš”</div><span class="banner-x">âœ•</span></div>`;
    else if(u.ddayClass==='d7') html += `<div class="banner warn" onclick="this.remove()"><span>âš ï¸</span><div style="flex:1;"><strong>êµ¬ë… ë§Œë£Œ ì„ë°• (${u.dday})</strong> â€” ë§ˆê°ì¼: ${u.endDate}</div><span class="banner-x">âœ•</span></div>`;
    // í•˜ìœ„ ë§Œë£Œ
    const expiring = getAllDescendants(u.id).filter(m=>['d0','d7'].includes(m.ddayClass));
    if(expiring.length>0) html += `<div class="banner warn" onclick="this.remove()"><span>ğŸ””</span><div style="flex:1;"><strong>í•˜ìœ„ íšŒì› ë§Œë£Œ ì„ë°• ${expiring.length}ëª…</strong> â€” ${expiring.map(m=>m.name).join(', ')}</div><span class="banner-x">âœ•</span></div>`;
  }
  document.getElementById('banner-area').innerHTML = html;
}

/* â”€â”€ ë§Œë£Œ ì„ë°• ë¦¬ìŠ¤íŠ¸ â”€â”€ */
function renderExpireList(u, isAdmin){
  const visible = getVisibleMembers(u.id).filter(m=>['d0','d7','d30'].includes(m.ddayClass) && m.id!==u.id);
  let html='';
  if(visible.length===0){
    html = `<div style="padding:20px;text-align:center;color:var(--text3);font-size:.82rem;">${t('noExpiring')}</div>`;
  } else {
    visible.slice(0,4).forEach(m=>{
      const renew = (isAdmin||m.referrerId===u.id) ? `<button class="renew-btn" onclick="openSheet('renew')" style="${m.ddayClass==='d0'?'':'background:var(--bg);color:var(--text2);border:1px solid var(--border);'}">ì—°ì¥</button>` : '';
      html += `<div class="member-list-item" onclick="openTreePanel('${m.id}')">
        <div class="m-avatar ${m.avatar}">${m.initial}</div>
        <div class="m-info"><div class="m-name">${m.name}</div><div class="m-sub"><span class="depth-chip dc-${m.depth>=3?'3':m.depth}">${m.depthLabel}</span> ë§Œë£Œ: ${m.endDate}</div></div>
        <div class="m-right"><span class="dday ${m.ddayClass}">${m.dday}</span>${renew}</div>
      </div>`;
    });
  }
  document.getElementById('expire-list').innerHTML = html;
}

/* â”€â”€ íšŒì› ëª©ë¡ ë Œë” â”€â”€ */
function renderMemberList(u, isAdmin){
  const visible = getVisibleMembers(u.id);
  document.getElementById('members-title').textContent = isAdmin ? 'êµ¬ë…íšŒì› ì „ì²´' : 'ë‚´ ë„¤íŠ¸ì›Œí¬ íšŒì›';
  document.getElementById('members-desc').textContent = isAdmin ? 'ì „ì²´ íšŒì› ëª©ë¡ Â· íŠ¸ë¦¬ ë²„íŠ¼ìœ¼ë¡œ ê°œì¸ íŠ¸ë¦¬ í™•ì¸' : 'ë‚˜ì™€ ë‚´ í•˜ìœ„ íšŒì›ë§Œ í‘œì‹œë©ë‹ˆë‹¤';

  let html='';
  visible.forEach(m=>{
    const depthChip = m.depth===0 ? `<span class="depth-chip dc-root">ROOT</span>` :
                      m.depth===1 ? `<span class="depth-chip dc-1">ì§ì ‘ 1ì´Œ</span>` :
                      m.depth===2 ? `<span class="depth-chip dc-2">ê°„ì ‘ 2ì´Œ</span>` :
                                    `<span class="depth-chip dc-3">ê°„ì ‘ ${m.depth}ì´Œ</span>`;
    const isSelf = m.id === u.id;
    const refName = m.referrerId ? ALL_MEMBERS[m.referrerId]?.name : null;
    const subTxt = isSelf ? 'ë‚˜ì˜ ê³„ì •' : (refName ? `ì¶”ì²œì¸: ${refName}` : 'ROOT');
    const linkBtn = isAdmin ? `<button class="link-btn" onclick="event.stopPropagation();showMemberLink('${m.id}')">ğŸ”— ë§í¬</button>` : '';
    html += `<div class="member-list-item" data-name="${m.name}" onclick="openTreePanel('${m.id}')">
      <div class="m-avatar ${m.avatar}">${m.initial}</div>
      <div class="m-info">
        <div class="m-name">${m.name}${isSelf?' <span style="font-size:.62rem;color:var(--gd);font-weight:700;">(ë‚˜)</span>':''}</div>
        <div class="m-sub">${depthChip} ${subTxt}</div>
      </div>
      <div class="m-right">
        <span class="dday ${m.ddayClass}" style="font-size:.65rem;">${m.dday}</span>
        <div style="display:flex;gap:5px;">${linkBtn}<button class="tree-btn" onclick="event.stopPropagation();openTreePanel('${m.id}')">ğŸŒ³ íŠ¸ë¦¬</button></div>
      </div>
    </div>`;
  });
  document.getElementById('member-list-wrap').innerHTML = html;
}

/* â”€â”€ ì•Œë¦¼ ë Œë” â”€â”€ */
function renderAlerts(u, isAdmin){
  const wrap = document.getElementById('alert-list');
  const badge = document.getElementById('alert-badge');
  const sbBadge = document.getElementById('sb-alert-badge');
  if(!wrap) return;

  /* ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì•Œë¦¼ë§Œ í‘œì‹œ (ìƒ˜í”Œ ì—†ìŒ) */
  const alerts = window._dynamicAlerts || [];

  if(alerts.length === 0){
    wrap.innerHTML = `<div style="padding:32px 20px;text-align:center;color:var(--text3);">
      <div style="font-size:2rem;margin-bottom:8px;">ğŸ””</div>
      <div style="font-size:.85rem;font-weight:600;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
      <div style="font-size:.75rem;margin-top:4px;">ì¬ê³  ë¶€ì¡±, ë§Œë£Œ ì„ë°• ì‹œ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>`;
    if(badge){ badge.style.display='none'; }
    if(sbBadge){ sbBadge.style.display='none'; }
    return;
  }

  wrap.innerHTML = alerts.map(a => `
    <div class="alert-item ${a.unread?'unread':''}">
      <div class="alert-dot ${a.color}"></div>
      <div class="alert-content">
        <div class="alert-title">${a.title}</div>
        <div class="alert-desc">${a.desc}</div>
        <div class="alert-time">${a.time}</div>
      </div>
      ${a.action ? `<button class="alert-action" onclick="${a.action.fn}">${a.action.label}</button>` : ''}
    </div>`).join('');

  const unreadCount = alerts.filter(a=>a.unread).length;
  if(badge){ badge.textContent = unreadCount||''; badge.style.display = unreadCount?'':'none'; }
  if(sbBadge){ sbBadge.textContent = unreadCount||''; sbBadge.style.display = unreadCount?'':'none'; }
}
function openTreePanel(targetId){
  currentPanelId = targetId;
  const target = ALL_MEMBERS[targetId];
  const viewer = CURRENT_USER;

  /* â”€â”€ target ë˜ëŠ” viewerê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ â”€â”€ */
  if(!target){ console.warn('openTreePanel: ì•Œ ìˆ˜ ì—†ëŠ” íšŒì› ID â†’', targetId); return; }
  if(!viewer){ return; }

  const isAdmin = viewer.role==='admin';

  /* ë·°ì–´ê°€ ëŒ€ìƒì˜ í•˜ìœ„ì— ìˆëŠ”ì§€, ì¦‰ ëŒ€ìƒì´ ë·°ì–´ì˜ ìƒìœ„ì¸ì§€ í™•ì¸
     â†’ ëŒ€ìƒ IDê°€ ë·°ì–´ì˜ ì¡°ìƒ ì²´ì¸ì— ìˆìœ¼ë©´ ì°¨ë‹¨ (ë³¸ì¸ ì œì™¸)
     â†’ ê´€ë¦¬ìëŠ” ëª¨ë‘ í—ˆìš© */
  const isAncestor = !isAdmin && (targetId !== viewer.id) && isAncestorOf(targetId, viewer.id);

  // íŒ¨ë„ í—¤ë”
  document.getElementById('panel-title').textContent = target.name + ' ì¶”ì²œ íŠ¸ë¦¬';
  document.getElementById('panel-subtitle').textContent = isAdmin ? 'ê´€ë¦¬ì ì „ì²´ ì¡°íšŒ' : (targetId===viewer.id ? 'ë‚˜ì˜ í•˜ìœ„ ë„¤íŠ¸ì›Œí¬' : 'í•˜ìœ„ íšŒì› ë„¤íŠ¸ì›Œí¬');
  document.getElementById('panel-avatar-char').textContent = target.initial;
  document.getElementById('panel-fullname').textContent = target.name;
  document.getElementById('panel-contact').textContent = isAdmin||targetId===viewer.id ? target.contact : 'ğŸ“µ ë¹„ê³µê°œ';
  document.getElementById('panel-depth-label').textContent = target.depthLabel + (target.referrerId&&(isAdmin||targetId===viewer.id) ? ' Â· ì¶”ì²œì¸: '+(ALL_MEMBERS[target.referrerId]?.name||'') : '');
  document.getElementById('stat-direct').textContent = target.direct;
  document.getElementById('stat-indirect').textContent = target.indirect;
  document.getElementById('stat-total').textContent = target.total;
  document.getElementById('tree-card-title').textContent = 'ğŸŒ³ ' + target.name + ' ì¶”ì²œ íŠ¸ë¦¬';
  document.getElementById('node-detail').innerHTML = 'ğŸ‘† ë…¸ë“œë¥¼ í„°ì¹˜í•˜ë©´ íšŒì› ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.';

  // ğŸ”’ ìƒìœ„ ì°¨ë‹¨ í‘œì‹œ
  document.getElementById('blocked-parent-box').style.display = isAncestor ? 'block' : 'none';

  // íŠ¸ë¦¬ ë Œë”
  if(isAncestor){
    // ìƒìœ„ íŠ¸ë¦¬ ì ‘ê·¼ â†’ ì°¨ë‹¨: ë…¸ë“œë§Œ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
    drawBlockedTree(target);
  } else {
    // ìì‹  or í•˜ìœ„ íšŒì› â†’ ì •ìƒ íŠ¸ë¦¬
    const treeRoot = buildTree(targetId);
    setTimeout(()=>drawTree(treeRoot, targetId), 80);
  }

  // í•˜ìœ„ ëª©ë¡ ë Œë”
  renderSubMembersList(target, isAncestor, isAdmin, viewer);

  document.getElementById('tree-panel').classList.add('open');
  document.getElementById('tree-panel-overlay').classList.add('show');
  // â˜… íŠ¸ë¦¬ íŒ¨ë„ì— íšŒì‚¬ êµ¬ë… í˜„í™© ì¹´ë“œ ì‚½ì…
  setTimeout(injectSubStatIntoPanel, 120);
}

function closeTreePanel(){
  const panel = document.getElementById('tree-panel');
  const overlay = document.getElementById('tree-panel-overlay');
  panel.classList.remove('open');
  overlay.classList.remove('show');
  // ë‹«íŒ í›„ ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
  setTimeout(()=>{ panel.scrollTop = 0; }, 350);
}

/* ëŒ€ìƒì´ ë·°ì–´ì˜ ì¡°ìƒì¸ì§€ í™•ì¸ */
function isAncestorOf(ancestorId, descendantId){
  let cur = ALL_MEMBERS[descendantId];
  while(cur && cur.referrerId){
    if(cur.referrerId === ancestorId) return true;
    cur = ALL_MEMBERS[cur.referrerId];
  }
  return false;
}

/* íŠ¸ë¦¬ ë°ì´í„° ë¹Œë“œ */
function buildTree(rootId, depth=0){
  const m = ALL_MEMBERS[rootId];
  if(!m) return null;
  const children = getDirectChildren(rootId).map(c=>buildTree(c.id, depth+1)).filter(Boolean);
  return { id:rootId, name:m.name, depth, status:m.status, children };
}

/* â”€â”€ ğŸ”’ ì°¨ë‹¨ íŠ¸ë¦¬ (íšŒìƒ‰ ìë¬¼ì‡ ) â”€â”€ */
function drawBlockedTree(target){
  const svg = document.getElementById('panel-svg');
  svg.setAttribute('viewBox','0 0 340 120'); svg.setAttribute('height','120');
  svg.innerHTML=`
    <circle cx="170" cy="50" r="28" fill="#EEE" stroke="#DDD" stroke-width="2"/>
    <text x="170" y="46" text-anchor="middle" fill="#AAA" font-size="18" font-family="sans-serif">ğŸ”’</text>
    <text x="170" y="64" text-anchor="middle" fill="#BBB" font-size="9" font-weight="bold" font-family="Noto Sans KR,sans-serif">${target.name}</text>
    <text x="170" y="95" text-anchor="middle" fill="#CCC" font-size="9" font-family="Noto Sans KR,sans-serif">ìƒìœ„ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ì œí•œ</text>`;
}

/* â”€â”€ ì •ìƒ íŠ¸ë¦¬ ê·¸ë¦¬ê¸° â”€â”€ */
function drawTree(root, viewerId){
  const svg = document.getElementById('panel-svg');
  svg.innerHTML='';

  const desc = countDesc(root);
  const H = desc<=0?120 : desc<=3?180 : desc<=7?240:300;
  svg.setAttribute('viewBox',`0 0 340 ${H}`); svg.setAttribute('height',H);

  if(!root.children||root.children.length===0){
    svg.innerHTML=`
      <defs><linearGradient id="g0" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#D4A820"/><stop offset="100%" stop-color="#FFD700"/></linearGradient></defs>
      <circle cx="170" cy="46" r="28" fill="url(#g0)"/>
      <text x="170" y="50" text-anchor="middle" fill="#1E0642" font-size="11" font-weight="bold" font-family="Noto Sans KR,sans-serif">${root.name}</text>
      <text x="170" y="86" text-anchor="middle" fill="#A07810" font-size="9" font-weight="700" font-family="Noto Sans KR,sans-serif">ë‚˜ (í•˜ìœ„ ì—†ìŒ)</text>`;
    return;
  }

  const pos={};
  function layout(node,d,minX,maxX){
    pos[node.id]={x:(minX+maxX)/2, y:28+d*Math.max(60,(H-30)/Math.max(2,maxDepth(root))), node};
    if(node.children&&node.children.length){
      const step=(maxX-minX)/node.children.length;
      node.children.forEach((c,i)=>layout(c,d+1,minX+i*step,minX+(i+1)*step));
    }
  }
  layout(root,0,16,324);

  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  defs.innerHTML=`
    <linearGradient id="g0" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#D4A820"/><stop offset="100%" stop-color="#FFD700"/></linearGradient>
    <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#5A1FA0"/><stop offset="100%" stop-color="#9B59D0"/></linearGradient>
    <linearGradient id="g2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A070D8"/><stop offset="100%" stop-color="#C89FE8"/></linearGradient>`;
  svg.appendChild(defs);

  function lines(node){
    if(!node.children) return;
    node.children.forEach(c=>{
      const p=pos[node.id], ch=pos[c.id];
      const l=document.createElementNS('http://www.w3.org/2000/svg','line');
      l.setAttribute('x1',p.x); l.setAttribute('y1',p.y+18);
      l.setAttribute('x2',ch.x); l.setAttribute('y2',ch.y-18);
      l.setAttribute('stroke',c.depth===1?'#D4A820':'#9B59D0');
      l.setAttribute('stroke-width',c.depth===1?'2.5':'1.8');
      if(c.depth>1)l.setAttribute('stroke-dasharray','5,3');
      l.setAttribute('opacity','0.75'); svg.appendChild(l);
      lines(c);
    });
  }
  lines(root);

  function nodes(node){
    const {x,y}=pos[node.id];
    const r=node.depth===0?22:node.depth===1?17:14;
    const gIdx=Math.min(node.depth,2);
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor='pointer';

    if(node.status==='expired'||node.status==='warn'){
      const ring=document.createElementNS('http://www.w3.org/2000/svg','circle');
      ring.setAttribute('cx',x); ring.setAttribute('cy',y); ring.setAttribute('r',r+5);
      ring.setAttribute('fill','none');
      ring.setAttribute('stroke',node.status==='expired'?'#E53935':'#F57C00');
      ring.setAttribute('stroke-width','1.5'); ring.setAttribute('stroke-dasharray','3,2'); ring.setAttribute('opacity','0.7');
      g.appendChild(ring);
    }

    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',r);
    c.setAttribute('fill',`url(#g${gIdx})`); g.appendChild(c);

    // ë³¸ì¸ í‘œì‹œ (ë³„ ì•„ì´ì½˜)
    const isSelf = node.id === viewerId;
    if(isSelf){
      const star=document.createElementNS('http://www.w3.org/2000/svg','text');
      star.setAttribute('x',x+r-4); star.setAttribute('y',y-r+4);
      star.setAttribute('text-anchor','middle'); star.setAttribute('font-size','10');
      star.textContent='â­'; g.appendChild(star);
    }

    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',x); t.setAttribute('y',y+4); t.setAttribute('text-anchor','middle');
    t.setAttribute('fill',node.depth<2?'#1E0642':'#2D0A5E');
    t.setAttribute('font-size',node.depth===0?'10':'9'); t.setAttribute('font-weight','bold');
    t.setAttribute('font-family','Noto Sans KR,sans-serif'); t.textContent=node.name; g.appendChild(t);

    const labels=['ë‚˜(ROOT)','1ì´Œ','2ì´Œ','3ì´Œ','4ì´Œ'];
    const lb=document.createElementNS('http://www.w3.org/2000/svg','text');
    lb.setAttribute('x',x); lb.setAttribute('y',y+r+11); lb.setAttribute('text-anchor','middle');
    lb.setAttribute('fill',node.depth===0?'#A07810':node.depth===1?'#5A1FA0':'#A070D8');
    lb.setAttribute('font-size','8'); lb.setAttribute('font-weight','700');
    lb.setAttribute('font-family','Noto Sans KR,sans-serif'); lb.textContent=labels[node.depth]||`${node.depth}ì´Œ`; g.appendChild(lb);

    g.addEventListener('click',()=>{
      const m=ALL_MEMBERS[node.id];
      const statusTxt={active:'âœ… í™œì„±',expired:'ğŸ”´ ë§Œë£Œ',warn:'âš ï¸ ë§Œë£Œì„ë°•'}[node.status]||'';
      document.getElementById('node-detail').innerHTML=
        `<strong style="color:var(--pm)">${node.name}</strong> Â· ${labels[node.depth]||node.depth+'ì´Œ'} Â· ${statusTxt}
         <br><span style="font-size:.7rem;color:var(--text3);">ë§Œë£Œì¼: ${m?.endDate||'-'}</span>
         ${node.depth>0&&node.id!==viewerId?`<br><span style="font-size:.7rem;color:var(--p3);cursor:pointer;" onclick="closeTreePanel();setTimeout(()=>openTreePanel('${node.id}'),300)">â†’ ì´ íšŒì›ì˜ íŠ¸ë¦¬ ë³´ê¸°</span>`:''}`;
    });
    svg.appendChild(g);
    if(node.children) node.children.forEach(nodes);
  }
  nodes(root);
}

/* â”€â”€ í•˜ìœ„ íšŒì› ëª©ë¡ ë Œë” â”€â”€ */
function renderSubMembersList(target, isAncestor, isAdmin, viewer){
  const wrap=document.getElementById('sub-members-wrap');
  if(isAncestor){
    wrap.innerHTML=`<div class="sub-section"><div class="sub-label">í•˜ìœ„ íšŒì› ëª©ë¡</div><div class="blocked-box"><div class="blocked-icon">ğŸ”’</div><div class="blocked-title">ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</div><div class="blocked-desc">ìƒìœ„ íšŒì›ì˜ í•˜ìœ„ ëª©ë¡ì€ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div></div></div>`;
    return;
  }

  const directs = getDirectChildren(target.id);
  const allDesc = getAllDescendants(target.id);
  const indirects = allDesc.filter(m=>m.referrerId!==target.id);

  let html='<div class="sub-section">';

  // ì¶”ì²œì¸ (ê´€ë¦¬ì ë˜ëŠ” ë³¸ì¸ ê³„ì •ì¼ ë•Œë§Œ í‘œì‹œ)
  if(target.referrerId && (isAdmin || target.id===viewer.id)){
    const ref=ALL_MEMBERS[target.referrerId];
    if(ref){
      html+=`<div class="sub-label">ğŸ‘† ì¶”ì²œì¸ (ìƒìœ„)</div>
      <div class="sub-card"><div class="sub-item">
        <div class="sub-avatar ${ref.avatar}">${ref.initial}</div>
        <div class="sub-info"><div class="sub-name">${ref.name}</div><div class="sub-desc">ë‚˜ë¥¼ ì§ì ‘ ì¶”ì²œí•œ íšŒì›</div></div>
        <span class="depth-chip dc-root" style="font-size:.6rem;">ìƒìœ„</span>
      </div></div>`;
    }
  } else if(target.referrerId && !isAdmin && target.id!==viewer.id){
    // ë‹¤ë¥¸ íšŒì›ì˜ ìƒìœ„ëŠ” ìˆ¨ê¹€
    html+=`<div class="sub-label">ğŸ‘† ì¶”ì²œì¸</div>
    <div class="blocked-box" style="margin:0 0 8px;"><div style="display:flex;align-items:center;gap:8px;"><span style="font-size:1.2rem;">ğŸ”’</span><span style="font-size:.8rem;color:var(--text3);">ìƒìœ„ ì¶”ì²œì¸ ì •ë³´ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span></div></div>`;
  }

  if(directs.length>0){
    html+=`<div class="sub-label">ğŸŒŸ ì§ì ‘ ì¶”ì²œ íšŒì› (1ì´Œ) Â· ${directs.length}ëª…</div><div class="sub-card">`;
    directs.forEach(m=>{
      const statusBadge=m.status==='expired'?`<span class="badge red" style="font-size:.6rem;">ë§Œë£Œ</span>`:m.status==='warn'?`<span class="badge orange" style="font-size:.6rem;">ì„ë°•</span>`:`<span class="badge green" style="font-size:.6rem;">í™œì„±</span>`;
      html+=`<div class="sub-item" onclick="closeTreePanel();setTimeout(()=>openTreePanel('${m.id}'),300)">
        <div class="sub-avatar ${m.avatar}">${m.initial}</div>
        <div class="sub-info"><div class="sub-name">${m.name}</div><div class="sub-desc">ë§Œë£Œ: ${m.endDate}</div></div>
        <div class="sub-right"><span class="dday ${m.ddayClass}" style="font-size:.62rem;">${m.dday}</span>${statusBadge}</div>
      </div>`;
    });
    html+=`</div>`;
  }

  if(indirects.length>0){
    html+=`<div class="sub-label">ğŸ”— ê°„ì ‘ ì¶”ì²œ íšŒì› (2ì´Œ+) Â· ${indirects.length}ëª…</div><div class="sub-card">`;
    indirects.forEach(m=>{
      const refName=ALL_MEMBERS[m.referrerId]?.name||'';
      const depthChip=m.depth>=3?'dc-3':'dc-2';
      const statusBadge=m.status==='expired'?`<span class="badge red" style="font-size:.6rem;">ë§Œë£Œ</span>`:m.status==='warn'?`<span class="badge orange" style="font-size:.6rem;">ì„ë°•</span>`:`<span class="badge green" style="font-size:.6rem;">í™œì„±</span>`;
      html+=`<div class="sub-item" onclick="closeTreePanel();setTimeout(()=>openTreePanel('${m.id}'),300)">
        <div class="sub-avatar ${m.avatar}">${m.initial}</div>
        <div class="sub-info"><div class="sub-name">${m.name} <span class="depth-chip ${depthChip}" style="font-size:.58rem;">${m.depth}ì´Œ</span></div><div class="sub-desc">ì¶”ì²œì¸: ${refName}</div></div>
        <div class="sub-right"><span class="dday ${m.ddayClass}" style="font-size:.62rem;">${m.dday}</span>${statusBadge}</div>
      </div>`;
    });
    html+=`</div>`;
  }

  if(directs.length===0&&indirects.length===0){
    html+=`<div style="text-align:center;padding:24px 16px;color:var(--text3);font-size:.82rem;"><div style="font-size:2rem;margin-bottom:8px;">ğŸŒ±</div>ì•„ì§ ì¶”ì²œí•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
  }

  html+='</div>';
  wrap.innerHTML=html;
}

/* â”€â”€ ìœ í‹¸ â”€â”€ */
function maxDepth(node,d=0){ if(!node.children||!node.children.length) return d; return Math.max(...node.children.map(c=>maxDepth(c,d+1))); }
function countDesc(node){ if(!node.children||!node.children.length) return 0; return node.children.length+node.children.reduce((s,c)=>s+countDesc(c),0); }

/* â”€â”€ íƒ­ ì „í™˜ â”€â”€ */
function showTab(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(s=>s.classList.remove('sb-active'));
  const page=document.getElementById('page-'+id), tab=document.getElementById('tab-'+id);
  if(page) page.classList.add('active');
  if(tab)  tab.classList.add('active');
  const sbw=document.getElementById('sb-'+id+'-wrap');
  if(sbw) sbw.classList.add('sb-active');
  window.scrollTo(0,0);
  if(id==='stock'){ refreshStockKPI(); renderStockList(); }
  if(id==='activity'){ renderActivityPage(); }
  if(id==='rating'){
    const m = ensureMemberData(CURRENT_USER?.id);
    if(m) renderMyRatingHist(m.ratings);
  }
}
function refreshStockKPI(){
  if(typeof STOCK_DATA==='undefined') return;
  const total   = Object.values(STOCK_DATA).reduce((s,p)=>s+p.qty,0);
  const monthIn = Object.values(STOCK_DATA).reduce((s,p)=>s+(p.monthly?.inArr?.slice(-1)[0]||0),0);
  const low     = Object.values(STOCK_DATA).filter(p=>p.qty<p.safe).length;
  const t=document.getElementById('sk-total'), m=document.getElementById('sk-monthin'), l=document.getElementById('sk-low');
  if(t) t.textContent=total.toLocaleString();
  if(m) m.textContent=monthIn;
  if(l){ l.textContent=low; l.style.color=low>0?'var(--red)':'var(--green)'; }
  const ht=document.getElementById('kpi-total-stock'), hl=document.getElementById('kpi-low-stock');
  if(ht) ht.textContent=total.toLocaleString();
  if(hl){ hl.textContent=low; hl.parentElement.style.display=low>0?'':'none'; }
}

/* â”€â”€ ë°”í…€ì‹œíŠ¸ â”€â”€ */
/* openSheet: ì•„ë˜ í†µí•© ë²„ì „ ì‚¬ìš© */
function closeSheet(id){ document.getElementById('sheet-'+id).classList.remove('show'); }
document.querySelectorAll('.sheet-overlay').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('show'); }));

/* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2800); }

/* â”€â”€ ì—°ì¥ ê³„ì‚° â”€â”€ */
function calcRenew(){ const m=parseInt(document.getElementById('renew-months').value); const d=new Date('2025-01-27'); d.setMonth(d.getMonth()+m); document.getElementById('new-end-date').value=d.toISOString().split('T')[0]; }

/* â”€â”€ ê²€ìƒ‰ â”€â”€ */
function filterMembers(){ const q=document.getElementById('member-search').value.trim().toLowerCase(); document.querySelectorAll('#member-list-wrap .member-list-item').forEach(el=>{ const name=el.getAttribute('data-name')||''; el.style.display=name.toLowerCase().includes(q)?'':'none'; }); }

/* â”€â”€ ë‚ ì§œ â”€â”€ */
const _todayInit=new Date().toISOString().split('T')[0];
['s1','e1','si-date','so-date'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=_todayInit; });
calcRenew();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íšŒì› ë§í¬ ìƒì„± ê¸°ëŠ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// ë§í¬ ë² ì´ìŠ¤ URL (ë°°í¬ í›„ ì‹¤ì œ URLë¡œ ë³€ê²½)
const MEMBER_PAGE_URL = 'member_auth.html';

/* ì „í™”ë²ˆí˜¸ ìë™ í¬ë§· */
function regFormatPhone(el){
  let v = el.value.replace(/\D/g,'');
  if(v.length<=3)      el.value=v;
  else if(v.length<=7) el.value=v.slice(0,3)+'-'+v.slice(3);
  else                 el.value=v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7,11);
}

/* ë“±ë¡ í¼ ì—´ë¦´ ë•Œ ì¶”ì²œì¸ select ì±„ìš°ê¸° */
function openSheet(id){
  const el = document.getElementById('sheet-'+id);
  if(el) el.classList.add('show');
  if(id==='add-member') initRegForm();
  if(id==='stock-in')   setTimeout(siInit, 60);
  if(id==='stock-out')  setTimeout(soInit, 60);
}

function initRegForm(){
  // í¼ ë·° ì´ˆê¸°í™”
  document.getElementById('reg-form-view').style.display='block';
  document.getElementById('reg-link-view').style.display='none';
  const _rn=document.getElementById('reg-name'); if(_rn) _rn.value='';
  const _rp=document.getElementById('reg-phone'); if(_rp) _rp.value='';
  document.getElementById('reg-err').style.display='none';
  // ë‚ ì§œ ê¸°ë³¸ê°’
  const today=new Date().toISOString().split('T')[0];
  const _rs=document.getElementById('reg-start'); if(_rs) _rs.value=today;
  const end=new Date(); end.setFullYear(end.getFullYear()+1);
  const _re=document.getElementById('reg-end'); if(_re) _re.value=end.toISOString().split('T')[0];
  // ì¶”ì²œì¸ ëª©ë¡ ì±„ìš°ê¸°
  const sel=document.getElementById('reg-referrer');
  sel.innerHTML='<option value="">â€” ì¶”ì²œì¸ ì—†ìŒ (ROOT) â€”</option>';
  Object.values(ALL_MEMBERS).filter(m=>m.role!=='admin').forEach(m=>{
    sel.innerHTML+=`<option value="${m.id}">${m.name} (${m.depthLabel})</option>`;
  });
}

/* ì…ë ¥ê°’ ê²€ì¦ */
function regValidate(){
  const name=document.getElementById('reg-name').value.trim();
  const phone=document.getElementById('reg-phone').value.trim();
  const btn=document.getElementById('reg-submit-btn');
  btn.style.opacity=(name&&/^01[0-9]-\d{3,4}-\d{4}$/.test(phone))?'1':'0.5';
}

/* ë“±ë¡ ì œì¶œ */
async function submitRegister(){
  const name  = document.getElementById('reg-name').value.trim();
  const phone = document.getElementById('reg-phone').value.trim();
  const start = document.getElementById('reg-start').value;
  const end   = document.getElementById('reg-end').value;
  const refId = document.getElementById('reg-referrer').value;
  const errEl = document.getElementById('reg-err');

  // ìœ íš¨ì„± ê²€ì‚¬
  if(!name){ errEl.textContent='âŒ íšŒì›ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.style.display='block'; return; }
  if(!/^01[0-9]-\d{3,4}-\d{4}$/.test(phone)){ errEl.textContent='âŒ ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.style.display='block'; return; }
  if(!start||!end){ errEl.textContent='âŒ êµ¬ë… ì‹œì‘ì¼ê³¼ ë§ˆê°ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; errEl.style.display='block'; return; }
  if(end<start){ errEl.textContent='âŒ ë§ˆê°ì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì•ì— ìˆìŠµë‹ˆë‹¤.'; errEl.style.display='block'; return; }
  // ì¤‘ë³µ ì „í™”ë²ˆí˜¸ í™•ì¸
  const dup=Object.values(ALL_MEMBERS).find(m=>m.contact===phone);
  if(dup){ errEl.textContent=`âŒ ì´ë¯¸ ë“±ë¡ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤ (${dup.name}).`; errEl.style.display='block'; return; }
  errEl.style.display='none';

  const newId = 'member_' + Date.now();
  const refMember = refId ? ALL_MEMBERS[refId] : null;
  const newDepth  = refMember ? (refMember.depth+1) : 0;
  const depthLabels={0:'ROOT',1:'1ì´Œ',2:'2ì´Œ',3:'3ì´Œ'};
  const avatarList=['av-green','av-purple','av-red','av-orange'];
  const avatarVal = avatarList[Math.floor(Math.random()*avatarList.length)];

  /* DB INSERT */
  const btn = document.getElementById('reg-submit-btn');
  if(btn){ btn.textContent='ë“±ë¡ ì¤‘...'; btn.disabled=true; }

  const { error: regErr } = await supa.from('members').insert({
    id:           newId,
    pw:           '',
    name:         name,
    role:         'member',
    contact:      phone,
    referrer_id:  refId || null,
    start_date:   start,
    end_date:     end,
    status:       'active',
    depth:        newDepth,
    depth_label:  depthLabels[newDepth]||newDepth+'ì´Œ',
    avatar:       avatarVal
  });

  if(regErr){ dbErr('íšŒì› ë“±ë¡', regErr); if(btn){btn.textContent='ë“±ë¡';btn.disabled=false;} return; }

  /* ë©”ëª¨ë¦¬ ë°˜ì˜ */
  ALL_MEMBERS[newId] = dbRowToMember({
    id:newId, pw:'', name, role:'member', contact:phone,
    referrer_id:refId||null, start_date:start, end_date:end,
    status:'active', depth:newDepth,
    depth_label:depthLabels[newDepth]||newDepth+'ì´Œ', avatar:avatarVal
  });

  if(btn){ btn.textContent='ë“±ë¡'; btn.disabled=false; }

  // ë§í¬ ìƒì„±
  const memberLink = generateMemberLink(phone);

  // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì „í™˜
  document.getElementById('reg-form-view').style.display='none';
  document.getElementById('reg-link-view').style.display='block';
  refreshSubStat();
  document.getElementById('lr-icon').textContent=name[0];
  document.getElementById('lr-name').textContent=name+' ë‹˜ ë“±ë¡ ì™„ë£Œ!';
  document.getElementById('lr-sub').textContent=phone+' Â· êµ¬ë… ë§ˆê°: '+end;
  document.getElementById('lr-link-text').textContent=memberLink;
  document.getElementById('lr-link-box').dataset.link=memberLink;
}

/* ë§í¬ ìƒì„± í•¨ìˆ˜ */
function generateMemberLink(phone){
  const base = window.location.href.replace(/\/[^\/]*$\s*/,'').replace(/\?.*$/,'');
  return base + '/member_auth.html?phone=' + encodeURIComponent(phone.replace(/-/g,''));
}

/* íšŒì› ëª©ë¡ì—ì„œ ë§í¬ ë³´ê¸° */
function showMemberLink(memberId){
  const m = ALL_MEMBERS[memberId];
  if(!m) return;
  const link = generateMemberLink(m.contact);
  openSheet('add-member');
  setTimeout(()=>{
    document.getElementById('reg-form-view').style.display='none';
    document.getElementById('reg-link-view').style.display='block';
    document.getElementById('lr-icon').textContent=m.initial;
    document.getElementById('lr-name').textContent=m.name+' ë‹˜ì˜ ì „ìš© ë§í¬';
    document.getElementById('lr-sub').textContent=m.contact+' Â· '+m.depthLabel;
    document.getElementById('lr-link-text').textContent=link;
    document.getElementById('lr-link-box').dataset.link=link;
  }, 80);
}

/* ë§í¬ ë³µì‚¬ */
function getLinkValue(){
  return document.getElementById('lr-link-box')?.dataset?.link
      || document.getElementById('lr-link-text')?.textContent
      || '';
}
function copyText(text, msg){
  msg = msg || 'âœ“ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
  // ë°©ë²•1: Clipboard API (https / localhost)
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text)
      .then(()=>toast(msg))
      .catch(()=>fallbackCopy(text, msg));
    return;
  }
  // ë°©ë²•2: execCommand fallback
  fallbackCopy(text, msg);
}
function fallbackCopy(text, msg){
  msg = msg || 'âœ“ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:0;left:0;opacity:0;pointer-events:none;';
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if(ok){ toast(msg); return; }
  } catch(e){}
  // ë°©ë²•3: prompt ë¡œ ì§ì ‘ ì„ íƒ
  window.prompt('ì•„ë˜ ë§í¬ë¥¼ ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš” (Ctrl+C / ê¸¸ê²Œ ëˆ„ë¥´ê¸°)', text);
}
function copyMemberLink(){
  const link = getLinkValue();
  if(!link){ toast('âŒ ë§í¬ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”'); return; }
  copyText(link, 'âœ“ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

/* ë¬¸ì í…œí”Œë¦¿ ë³µì‚¬ */
function copyMsgTemplate(){
  const name = (document.getElementById('lr-name')?.textContent||'').replace(' ë‹˜ ë“±ë¡ ì™„ë£Œ!','').replace(' ë‹˜ì˜ ì „ìš© ë§í¬','');
  const link = getLinkValue();
  if(!link){ toast('âŒ ë§í¬ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”'); return; }
  const msg = '[ë‚´ëª¸ì• ë§ê²Œ] '+name+' ë‹˜, íšŒì› ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.\nì•„ë˜ ë§í¬ì—ì„œ ë‚˜ì˜ ì¶”ì²œ íŠ¸ë¦¬ì™€ êµ¬ë… í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.\n\n'+link+'\n\n(ë³¸ì¸ ì „í™”ë²ˆí˜¸ë¡œ ì¸ì¦ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤)';
  copyText(msg, 'âœ“ ë¬¸ì í…œí”Œë¦¿ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

/* shareKakao: ì•„ë˜ í†µí•© ë²„ì „ ì‚¬ìš© */

/* ë¬¸ì ì „ì†¡ (ëª¨ë°”ì¼ SMS ì•± ì—´ê¸°) */
function shareSMS(){
  const name = (document.getElementById('lr-name')?.textContent||'').replace(' ë‹˜ ë“±ë¡ ì™„ë£Œ!','').replace(' ë‹˜ì˜ ì „ìš© ë§í¬','');
  const link = getLinkValue();
  if(!link){ toast('âŒ ë§í¬ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”'); return; }
  const msg = encodeURIComponent('[ë‚´ëª¸ì• ë§ê²Œ] '+name+' ë‹˜ ì „ìš© ë§í¬: '+link);
  window.location.href = 'sms:?body='+msg;
}

/* í¼ ë¦¬ì…‹ (ë‹¤ë¥¸ íšŒì› ë“±ë¡) */
function resetRegForm(){
  initRegForm();
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¬ê³  DB + íŒ¨ë„ ê¸°ëŠ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STOCK_DATA = {}; /* DBì—ì„œ ë¡œë“œ */
let spCode = null;
window._dynamicAlerts = []; // ë™ì  ì•Œë¦¼ ì €ì¥ì†Œ

function openStockPanel(code){
  spCode = code;
  const p = STOCK_DATA[code];
  if(!p){ return; }

  // í—¤ë”
  document.getElementById('sp-pname').textContent = p.name;
  document.getElementById('sp-pcode').textContent = p.code;

  // ê²Œì´ì§€
  spRenderGauge(p);

  // ìˆ˜ëŸ‰ ì¸í’‹
  const _spq=document.getElementById('sp-qtyinput'); if(_spq) _spq.value=p.qty;

  // ì°¨íŠ¸
  spRenderChart(p.monthly);

  // ì´ë ¥
  spRenderHist(p.history);

  // íŒ¨ë„ ì—´ê¸°
  document.getElementById('sp-overlay').classList.add('show');
  document.getElementById('sp-panel').classList.add('open');
  document.getElementById('sp-panel').scrollTop = 0;
}

function spRenderGauge(p){
  const pct  = Math.min(100, Math.round(p.qty / p.max * 100));
  const low  = p.qty < p.safe * 0.5;
  const warn = p.qty < p.safe;

  document.getElementById('sp-bignum').innerHTML =
    '<span>' + p.qty + '</span><span style="font-size:1rem;font-weight:500;">ê°œ</span>';
  document.getElementById('sp-bignum').style.color = low ? '#EF9A9A' : warn ? '#FFCC80' : '#81C784';
  document.getElementById('sp-safetxt').textContent = 'ì•ˆì „ì¬ê³ : ' + p.safe + 'ê°œ';
  document.getElementById('sp-maxtxt').textContent  = 'ìµœëŒ€ ' + p.max + 'ê°œ';

  const fill = document.getElementById('sp-fill');
  fill.style.width = pct + '%';
  fill.className   = 'sp-bar-fill ' + (low ? 'sp-bar-low' : warn ? 'sp-bar-warn' : 'sp-bar-ok');

  const badge = low  ? '<span class="badge red">ë¶€ì¡±</span>'
               : warn ? '<span class="badge orange">ì£¼ì˜</span>'
               :        '<span class="badge green">ì •ìƒ</span>';
  document.getElementById('sp-badge').innerHTML = badge;

  const stxt = low  ? 'ğŸš¨ ê¸´ê¸‰ ë¶€ì¡± â€” ì¦‰ì‹œ ì…ê³  í•„ìš”'
              : warn ? 'âš ï¸ ì•ˆì „ì¬ê³  ì´í•˜ â€” ì…ê³  ê¶Œì¥'
              :        'âœ… ì¬ê³  ì •ìƒ (' + pct + '%)';
  document.getElementById('sp-statustxt').textContent = stxt;
}

function spRenderChart(m){
  const maxV = Math.max(...m.inArr, ...m.outArr, 1);
  const wrap = document.getElementById('sp-chartbars');
  wrap.innerHTML = '';
  m.labels.forEach(function(lbl, i){
    const ih = Math.round(m.inArr[i]  / maxV * 68);
    const oh = Math.round(m.outArr[i] / maxV * 68);
    const col = document.createElement('div');
    col.className = 'chart-col';
    col.innerHTML =
      '<div class="chart-pair">' +
      '<div class="cb-in"  style="height:' + ih + 'px;"></div>' +
      '<div class="cb-out" style="height:' + oh + 'px;"></div>' +
      '</div>' +
      '<div class="chart-lbl">' + lbl + '</div>';
    wrap.appendChild(col);
  });
}

function spRenderHist(history){
  const el = document.getElementById('sp-histlist');
  if(!history.length){
    el.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text3);font-size:.82rem;">ì´ë ¥ ì—†ìŒ</div>';
    return;
  }
  el.innerHTML = history.map(function(h){
    const isIn  = h.t === 'in';
    const isAdj = h.t === 'adj';
    const ic    = isIn ? 'ğŸ“¥' : isAdj ? 'ğŸ”§' : 'ğŸ“¤';
    const icls  = isIn ? 'hic-in' : isAdj ? 'hic-adj' : 'hic-out';
    const qcls  = isIn ? 'in' : isAdj ? 'adj' : 'out';
    const sign  = (isIn || isAdj) ? '+' : '-';
    const lbl   = isIn ? 'ì…ê³ ' : isAdj ? 'ì¡°ì •' : 'ì¶œê³ ';
    return '<div class="hist-row">' +
      '<div class="hist-ic ' + icls + '">' + ic + '</div>' +
      '<div class="hist-info">' +
        '<div class="hist-main">' + lbl + ' Â· ' + h.m + '</div>' +
        '<div class="hist-date">' + h.d + '</div>' +
      '</div>' +
      '<div class="hist-q ' + qcls + '">' + sign + h.q + 'ê°œ</div>' +
    '</div>';
  }).join('');
}

function spAdjust(delta){
  const inp = document.getElementById('sp-qtyinput');
  const p   = STOCK_DATA[spCode];
  const nv  = Math.max(0, Math.min(p.max, (parseInt(inp.value) || 0) + delta));
  inp.value = nv;
}

function spApply(){
  const inp    = document.getElementById('sp-qtyinput');
  const p      = STOCK_DATA[spCode];
  const newQty = Math.max(0, parseInt(inp.value) || 0);
  const diff   = newQty - p.qty;
  if(diff === 0){ toast('ë³€ê²½ëœ ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  p.history.unshift({ t:'adj', q:Math.abs(diff), d:new Date().toISOString().slice(0,10), m:'ìˆ˜ë™ ì¡°ì •' });
  p.qty = newQty;
  spRenderGauge(p);
  spRenderHist(p.history);
  spUpdateListItem(spCode, p);
  toast('âœ“ ' + p.name + ' ì¬ê³  â†’ ' + newQty + 'ê°œë¡œ ì¡°ì •');
}

function spUpdateListItem(code, p){
  const qi = document.getElementById('sqi-' + code);
  /* ì•„ì´í…œì´ DOMì— ì—†ìœ¼ë©´ ì „ì²´ ë Œë” */
  if(!qi){ renderStockList(); return; }
  const qb = document.getElementById('sqb-' + code);
  const qr = document.getElementById('sqr-' + code);
  const low  = p.qty < p.safe * 0.5;
  const warn = p.qty < p.safe;
  const pct  = Math.min(100, Math.round(p.qty / p.max * 100));
  qi.textContent = p.qty + 'ê°œ';
  qi.style.color = low ? 'var(--red)' : warn ? 'var(--orange)' : 'var(--green)';
  if(qb){ qb.textContent = low ? 'ë¶€ì¡±' : warn ? 'ì£¼ì˜' : 'ì •ìƒ'; qb.className = 'badge ' + (low?'red':warn?'orange':'green'); }
  if(qr){ qr.style.width = pct + '%'; }
}

function spOpenIn(){
  const _code = spCode;
  if(!STOCK_DATA[_code]) return;
  closeStockPanel();
  setTimeout(function(){
    openSheet('stock-in');
    const sel=document.getElementById('si-product');
    if(sel && STOCK_DATA[_code]){ sel.value=_code; siUpdatePreview(); }
  }, 360);
}
function spOpenOut(){
  const _code = spCode;
  if(!STOCK_DATA[_code]) return;
  closeStockPanel();
  setTimeout(function(){
    openSheet('stock-out');
    const sel=document.getElementById('so-product');
    if(sel && STOCK_DATA[_code]){ sel.value=_code; soUpdatePreview(); }
  }, 360);
}

function closeStockPanel(){
  document.getElementById('sp-overlay').classList.remove('show');
  document.getElementById('sp-panel').classList.remove('open');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ’¾ ì…ê³  ì²˜ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function siUpdatePreview(){
  const code=document.getElementById('si-product')?.value;
  const p=STOCK_DATA[code]; if(!p) return;
  const qty=parseInt(document.getElementById('si-qty')?.value)||0;
  const curEl=document.getElementById('si-cur-qty');
  if(curEl) curEl.textContent=p.qty+'ê°œ';
  const aEl=document.getElementById('si-after');
  const aqEl=document.getElementById('si-after-qty');
  if(aEl && aqEl){
    if(qty>0){ aEl.style.display='flex'; aqEl.textContent=(p.qty+qty)+'ê°œ (+'+qty+')'; }
    else { aEl.style.display='none'; }
  }
}
function siInit(){
  const today=new Date().toISOString().split('T')[0];
  const d=document.getElementById('si-date'); if(d) d.value=today;
  const q=document.getElementById('si-qty');  if(q) q.value='';
  const m=document.getElementById('si-memo'); if(m) m.value='';
  const e=document.getElementById('si-err');  if(e) e.style.display='none';
  siUpdatePreview();
}
async function submitStockIn(){
  const code=document.getElementById('si-product').value;
  const qty =parseInt(document.getElementById('si-qty').value)||0;
  const date=document.getElementById('si-date').value;
  const memo=document.getElementById('si-memo').value.trim()||'ì…ê³ ';
  const errEl=document.getElementById('si-err');
  const p=STOCK_DATA[code];
  if(!p)    { errEl.textContent='âŒ ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.'; errEl.style.display='block'; return; }
  if(qty<=0){ errEl.textContent='âŒ ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; errEl.style.display='block'; return; }
  if(!date) { errEl.textContent='âŒ ì…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”.'; errEl.style.display='block'; return; }
  errEl.style.display='none';

  /* DB: ì¬ê³  ì—…ë°ì´íŠ¸ + ì´ë ¥ ì‚½ì… */
  const newQty = p.qty + qty;
  const [{ error:uErr }, { error:hErr }] = await Promise.all([
    supa.from('products').update({ qty: newQty }).eq('code', code),
    supa.from('stock_history').insert({ product_code:code, type:'in', qty, date, memo })
  ]);
  if(uErr){ dbErr('ì…ê³  ì¬ê³  ì—…ë°ì´íŠ¸', uErr); return; }
  if(hErr){ dbErr('ì…ê³  ì´ë ¥ ì €ì¥', hErr); return; }

  // ë©”ëª¨ë¦¬ ë°˜ì˜
  p.qty = newQty;
  p.history.unshift({t:'in',q:qty,d:date,m:memo});
  if(p.monthly?.inArr) p.monthly.inArr[p.monthly.inArr.length-1]+=qty;
  spUpdateListItem(code,p);
  refreshStockKPI();
  if(document.getElementById('sp-panel')?.classList.contains('open') && spCode===code){
    spRenderGauge(p); spRenderHist(p.history);
    const qi=document.getElementById('sp-qtyinput'); if(qi) qi.value=p.qty;
  }
  addActivityItem('ğŸ“¥','ai-in','<strong>'+p.name+'</strong> '+qty+'ê°œ ì…ê³  Â· '+memo,'ë°©ê¸ˆ ì „');
  closeSheet('stock-in');
  toast('ğŸ“¥ '+p.name+' '+qty+'ê°œ ì…ê³ ! (í˜„ì¬ '+p.qty+'ê°œ)');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ’¾ ì¶œê³  ì²˜ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function soUpdatePreview(){
  const code=document.getElementById('so-product')?.value;
  const p=STOCK_DATA[code]; if(!p) return;
  const qty=parseInt(document.getElementById('so-qty')?.value)||0;
  const curEl=document.getElementById('so-cur-qty');
  if(curEl) curEl.textContent=p.qty+'ê°œ';
  const aEl=document.getElementById('so-after');
  const aqEl=document.getElementById('so-after-qty');
  if(aEl && aqEl){
    if(qty>0){
      aEl.style.display='flex';
      const remain=p.qty-qty;
      aqEl.textContent=remain+'ê°œ (-'+qty+')';
      aqEl.style.color=remain<p.safe?'var(--red)':'var(--p2)';
    } else { aEl.style.display='none'; }
  }
}
function soInit(){
  const today=new Date().toISOString().split('T')[0];
  const d=document.getElementById('so-date'); if(d) d.value=today;
  const q=document.getElementById('so-qty');  if(q) q.value='';
  const m=document.getElementById('so-memo'); if(m) m.value='';
  const e=document.getElementById('so-err');  if(e) e.style.display='none';
  soUpdatePreview();
}
async function submitStockOut(){
  const code=document.getElementById('so-product').value;
  const qty =parseInt(document.getElementById('so-qty').value)||0;
  const date=document.getElementById('so-date').value;
  const memo=document.getElementById('so-memo').value.trim()||'ì¶œê³ ';
  const errEl=document.getElementById('so-err');
  const p=STOCK_DATA[code];
  if(!p)      { errEl.textContent='âŒ ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.'; errEl.style.display='block'; return; }
  if(qty<=0)  { errEl.textContent='âŒ ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; errEl.style.display='block'; return; }
  if(qty>p.qty){ errEl.textContent='âŒ í˜„ì¬ ì¬ê³ ('+p.qty+'ê°œ)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.'; errEl.style.display='block'; return; }
  if(!date)   { errEl.textContent='âŒ ì¶œê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”.'; errEl.style.display='block'; return; }
  errEl.style.display='none';

  /* DB: ì¬ê³  ì—…ë°ì´íŠ¸ + ì´ë ¥ ì‚½ì… */
  const newQty2 = p.qty - qty;
  const [{ error:uErr2 }, { error:hErr2 }] = await Promise.all([
    supa.from('products').update({ qty: newQty2 }).eq('code', code),
    supa.from('stock_history').insert({ product_code:code, type:'out', qty, date, memo })
  ]);
  if(uErr2){ dbErr('ì¶œê³  ì¬ê³  ì—…ë°ì´íŠ¸', uErr2); return; }
  if(hErr2){ dbErr('ì¶œê³  ì´ë ¥ ì €ì¥', hErr2); return; }

  // ë©”ëª¨ë¦¬ ë°˜ì˜
  p.qty = newQty2;
  p.history.unshift({t:'out',q:qty,d:date,m:memo});
  if(p.monthly?.outArr) p.monthly.outArr[p.monthly.outArr.length-1]+=qty;
  spUpdateListItem(code,p);
  refreshStockKPI();
  if(document.getElementById('sp-panel')?.classList.contains('open') && spCode===code){
    spRenderGauge(p); spRenderHist(p.history);
    const qi=document.getElementById('sp-qtyinput'); if(qi) qi.value=p.qty;
  }
  addActivityItem('ğŸ“¤','ai-out','<strong>'+p.name+'</strong> '+qty+'ê°œ ì¶œê³  Â· '+memo,'ë°©ê¸ˆ ì „');
  closeSheet('stock-out');
  if(p.qty<p.safe){
    setTimeout(()=>toast('âš ï¸ '+p.name+' ì¬ê³  ë¶€ì¡±! ('+p.qty+'ê°œ) ì…ê³ ê°€ í•„ìš”í•©ë‹ˆë‹¤'),400);
  } else {
    toast('ğŸ“¤ '+p.name+' '+qty+'ê°œ ì¶œê³ ! (í˜„ì¬ '+p.qty+'ê°œ)');
  }
}

/* ì‹œíŠ¸ ì—´ë¦´ ë•Œ ì´ˆê¸°í™” */
/* openSheet ì´ˆê¸°í™”: ì•„ë˜ í†µí•© ë²„ì „ ì‚¬ìš© */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“Š í™ˆ ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDashboardChart(){
  const wrap=document.getElementById('dashboard-chart-wrap');
  if(!wrap) return;
  const members=Object.values(ALL_MEMBERS).filter(m=>m.role!=='admin');
  const active =members.filter(m=>m.status==='active').length;
  const warn   =members.filter(m=>m.status==='warn').length;
  const expired=members.filter(m=>m.status==='expired').length;
  const total  =members.length||1;
  const aP=Math.round(active/total*100), wP=Math.round(warn/total*100), eP=Math.round(expired/total*100);
  wrap.innerHTML=
    '<div style="font-family:\'Nanum Myeongjo\',serif;font-size:.85rem;font-weight:800;color:var(--pm);margin-bottom:10px;">ğŸ“Š êµ¬ë… í˜„í™© ë¶„í¬</div>'+
    '<div style="display:flex;height:12px;border-radius:6px;overflow:hidden;gap:2px;margin-bottom:10px;">'+
      '<div style="flex:'+active+';background:linear-gradient(90deg,#43A047,#81C784);min-width:'+(active?'4px':'0')+';" title="í™œì„± '+active+'ëª…"></div>'+
      '<div style="flex:'+warn  +';background:linear-gradient(90deg,#FB8C00,#FFCC02);min-width:'+(warn?'4px':'0')+';" title="ì„ë°• '+warn  +'ëª…"></div>'+
      '<div style="flex:'+expired+';background:linear-gradient(90deg,#E53935,#EF9A9A);min-width:'+(expired?'4px':'0')+';" title="ë§Œë£Œ '+expired+'ëª…"></div>'+
    '</div>'+
    '<div style="display:flex;gap:12px;flex-wrap:wrap;">'+
      '<div style="display:flex;align-items:center;gap:5px;font-size:.72rem;"><div style="width:10px;height:10px;border-radius:3px;background:#43A047;"></div><span style="color:var(--text2);">í™œì„± <strong>'+active+'ëª…</strong> ('+aP+'%)</span></div>'+
      '<div style="display:flex;align-items:center;gap:5px;font-size:.72rem;"><div style="width:10px;height:10px;border-radius:3px;background:#FB8C00;"></div><span style="color:var(--text2);">ì„ë°• <strong>'+warn  +'ëª…</strong> ('+wP+'%)</span></div>'+
      '<div style="display:flex;align-items:center;gap:5px;font-size:.72rem;"><div style="width:10px;height:10px;border-radius:3px;background:#E53935;"></div><span style="color:var(--text2);">ë§Œë£Œ <strong>'+expired+'ëª…</strong> ('+eP+'%)</span></div>'+
    '</div>';
}

function renderStockSummaryChart(){
  const wrap=document.getElementById('stock-summary-chart');
  if(!wrap||typeof STOCK_DATA==='undefined') return;
  const labels=['8ì›”','9ì›”','10ì›”','11ì›”','12ì›”','1ì›”'];
  const inT =labels.map((_,i)=>Object.values(STOCK_DATA).reduce((s,p)=>s+(p.monthly?.inArr?.[i]||0),0));
  const outT=labels.map((_,i)=>Object.values(STOCK_DATA).reduce((s,p)=>s+(p.monthly?.outArr?.[i]||0),0));
  const maxV=Math.max(...inT,...outT,1);
  wrap.innerHTML=
    '<div style="font-family:\'Nanum Myeongjo\',serif;font-size:.85rem;font-weight:800;color:var(--pm);margin-bottom:10px;">ğŸ“ˆ ì „ì²´ ì…ì¶œê³  ì¶”ì´ (6ê°œì›”)</div>'+
    '<div style="display:flex;align-items:flex-end;gap:5px;height:70px;margin-bottom:6px;">'+
    labels.map((_,i)=>
      '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;height:100%;justify-content:flex-end;">'+
        '<div style="display:flex;gap:2px;align-items:flex-end;width:100%;">'+
          '<div style="flex:1;border-radius:3px 3px 0 0;background:linear-gradient(180deg,var(--gm),var(--gd));height:'+Math.round(inT[i]/maxV*60)+'px;min-height:3px;"></div>'+
          '<div style="flex:1;border-radius:3px 3px 0 0;background:linear-gradient(180deg,var(--p3),var(--p2));height:'+Math.round(outT[i]/maxV*60)+'px;min-height:3px;"></div>'+
        '</div>'+
        '<div style="font-size:.58rem;color:var(--text3);">'+labels[i]+'</div>'+
      '</div>').join('')+
    '</div>'+
    '<div style="display:flex;gap:12px;">'+
      '<div style="display:flex;align-items:center;gap:4px;font-size:.65rem;color:var(--text3);"><div style="width:10px;height:10px;border-radius:3px;background:var(--gm);"></div>ì…ê³ </div>'+
      '<div style="display:flex;align-items:center;gap:4px;font-size:.65rem;color:var(--text3);"><div style="width:10px;height:10px;border-radius:3px;background:var(--p3);"></div>ì¶œê³ </div>'+
    '</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ• ìµœê·¼ í™œë™ ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addActivityItem(icon,cls,main,time){
  const wrap=document.getElementById('activity-list');
  if(!wrap) return;
  const div=document.createElement('div');
  div.className='activity-item';
  div.style.animation='fadeUp .35s ease';
  div.innerHTML='<div class="act-icon '+cls+'">'+icon+'</div>'+
    '<div class="act-content"><div class="act-main">'+main+'</div>'+
    '<div class="act-time">'+time+'</div></div>';
  wrap.insertBefore(div,wrap.firstChild);
  while(wrap.children.length>6) wrap.removeChild(wrap.lastChild);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± ì¹´ì¹´ì˜¤í†¡ / ë„¤ì´í‹°ë¸Œ ê³µìœ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shareKakao(){
  const name=(document.getElementById('lr-name')?.textContent||'').replace(' ë‹˜ ë“±ë¡ ì™„ë£Œ!','').replace(' ë‹˜ì˜ ì „ìš© ë§í¬','');
  const link=getLinkValue();
  if(!link){ toast('ë§í¬ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”'); return; }
  /* Kakao SDK ì—°ë™ ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œ:
  if(window.Kakao?.isInitialized()){
    Kakao.Link.sendDefault({
      objectType:'feed',
      content:{
        title:'[ë‚´ëª¸ì• ë§ê²Œ] '+name+' ë‹˜ ì „ìš© í˜ì´ì§€',
        description:'ë‚˜ì˜ ì¶”ì²œ íŠ¸ë¦¬ì™€ êµ¬ë… í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.',
        link:{mobileWebUrl:link,webUrl:link}
      },
      buttons:[{title:'íŠ¸ë¦¬ ë³´ê¸°',link:{mobileWebUrl:link,webUrl:link}}]
    });
    return;
  } */
  const msg='[ë‚´ëª¸ì• ë§ê²Œ] '+name+' ë‹˜ ì „ìš© ë§í¬ì…ë‹ˆë‹¤.\n'+link+'\n\n(ë³¸ì¸ ì „í™”ë²ˆí˜¸ë¡œ ì¸ì¦ í›„ ì´ìš©)';
  if(navigator.share){
    navigator.share({title:'ë‚´ëª¸ì• ë§ê²Œ íšŒì› í˜ì´ì§€',text:msg,url:link}).catch(()=>{});
  } else {
    copyText(msg, 'ğŸ’¬ ë³µì‚¬ ì™„ë£Œ â€” ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!');
  }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“… ì›”ë³„ êµ¬ë… í˜„í™© ì—”ì§„
   - ë§¤ì›” 1ì¼ ìë™ ì •ì‚° & ì´ˆê¸°í™”
   - ì›”ë³„ íˆìŠ¤í† ë¦¬ ë³´ê´€ (ìµœê·¼ 6ê°œì›”)
   - ê´€ë¦¬ì ERP + íšŒì› ê°œì¸ í˜ì´ì§€ ê³µìœ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ ì›”ë³„ íˆìŠ¤í† ë¦¬ ì´ˆê¸° ë°ì´í„° (ë°ëª¨) â”€â”€ */
const MONTH_HISTORY = []

/* â”€â”€ ì˜¤ëŠ˜ ë‚ ì§œ í—¬í¼ â”€â”€ */
function todayStr(){ return new Date().toISOString().slice(0,10); }
function thisYM(){
  const d=new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
}
function daysInMonth(ym){
  const [y,m]=ym.split('-').map(Number);
  return new Date(y,m,0).getDate();
}
function monthLabel(ym){
  const [y,m]=ym.split('-');
  return m+'ì›”';
}
function nextResetDate(){
  const d=new Date(); d.setDate(1);
  d.setMonth(d.getMonth()+1);
  return d.toISOString().slice(0,10);
}

/* â”€â”€ ì‹¤ì‹œê°„ ë‹¹ì›” ì§‘ê³„ â”€â”€ */
function calcThisMonth(){
  const members = Object.values(ALL_MEMBERS).filter(m=>m.role!=='admin');
  const active  = members.filter(m=>m.status==='active').length;
  const warn    = members.filter(m=>m.status==='warn').length;
  const expired = members.filter(m=>m.status==='expired').length;
  const total   = members.length;
  // ì´ì „ë‹¬ ëŒ€ë¹„
  const prev = MONTH_HISTORY[MONTH_HISTORY.length-2]; // ì§ì „ ì™„ë£Œì›”
  const diff = prev ? active - prev.active : 0;
  return { ym:thisYM(), active, warn, expired, total, diff };
}

/* â”€â”€ ë‹¹ì›” íˆìŠ¤í† ë¦¬ í•­ëª© ê°±ì‹  â”€â”€ */
function syncMonthHistory(){
  const cur = calcThisMonth();
  const last = MONTH_HISTORY[MONTH_HISTORY.length-1];
  if(last && last.ym === cur.ym){
    Object.assign(last, cur);
  } else {
    MONTH_HISTORY.push(cur);
    if(MONTH_HISTORY.length > 12) MONTH_HISTORY.shift();
  }
  return cur;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ERP ë©”ì¸ ì¹´ë“œ ë Œë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSubStatCard(){
  const wrap = document.getElementById('sub-stat-wrap');
  if(!wrap) return;
  const cur  = syncMonthHistory();
  const total = cur.total || 1;
  const aPct  = Math.round(cur.active  / total * 100);
  const wPct  = Math.round(cur.warn    / total * 100);
  const ePct  = Math.round(cur.expired / total * 100);
  const diffTxt = cur.diff === 0 ? 'ì „ì›”ê³¼ ë™ì¼'
                : cur.diff > 0  ? '<span class="ssc-up">â–² ' + cur.diff + 'ëª… ì¦ê°€</span>'
                :                  '<span class="ssc-down">â–¼ ' + Math.abs(cur.diff) + 'ëª… ê°ì†Œ</span>';
  const resetD  = nextResetDate();
  const today   = todayStr();
  const dLeft   = Math.ceil((new Date(resetD)-new Date(today))/86400000);

  wrap.style.display = 'block';
  wrap.innerHTML = `
    <div class="sub-stat-card">
      <div class="ssc-top">
        <div class="ssc-month-badge">
          <span class="live-dot"></span>
          ${new Date().getMonth()+1}ì›” êµ¬ë… í˜„í™©
        </div>
        <div class="ssc-reset-info">
          ë‹¤ìŒ ì •ì‚°ê¹Œì§€<br><strong style="color:var(--gb);">D-${dLeft}</strong> (${resetD})
        </div>
      </div>

      <!-- ë©”ì¸ ìˆ«ì -->
      <div class="ssc-main-row">
        <div>
          <div style="font-size:.68rem;color:rgba(255,255,255,0.55);margin-bottom:4px;">ì´ë‹¬ í™œì„± êµ¬ë…ì</div>
          <div style="display:flex;align-items:flex-end;gap:6px;">
            <div class="ssc-big" id="ssc-active-num">${cur.active}</div>
            <div class="ssc-big-unit">ëª…</div>
          </div>
        </div>
        <div class="ssc-vs">
          ì „ì²´ íšŒì› <strong>${cur.total}ëª…</strong><br>
          ì „ì›” ëŒ€ë¹„ ${diffTxt}
        </div>
      </div>

      <!-- ì„¸ë¶€ í†µê³„ -->
      <div class="ssc-grid">
        <div class="ssc-item">
          <div class="ssc-item-num" style="color:#81C784;">${cur.active}</div>
          <div class="ssc-item-lbl">âœ… í™œì„±</div>
        </div>
        <div class="ssc-item">
          <div class="ssc-item-num" style="color:#FFCC80;">${cur.warn}</div>
          <div class="ssc-item-lbl">âš ï¸ ë§Œë£Œ ì„ë°•</div>
        </div>
        <div class="ssc-item">
          <div class="ssc-item-num" style="color:#EF9A9A;">${cur.expired}</div>
          <div class="ssc-item-lbl">âŒ ë§Œë£Œ</div>
        </div>
      </div>

      <!-- ì§„í–‰ ë°” -->
      <div class="ssc-bar-row">
        <span class="ssc-bar-lbl">í™œì„±</span>
        <div class="ssc-bar-track"><div class="ssc-bar-fill ssb-active" style="width:${aPct}%"></div></div>
        <span class="ssc-bar-count">${cur.active}</span>
      </div>
      <div class="ssc-bar-row">
        <span class="ssc-bar-lbl">ì„ë°•</span>
        <div class="ssc-bar-track"><div class="ssc-bar-fill ssb-warn" style="width:${wPct}%"></div></div>
        <span class="ssc-bar-count">${cur.warn}</span>
      </div>
      <div class="ssc-bar-row" style="margin-bottom:0;">
        <span class="ssc-bar-lbl">ë§Œë£Œ</span>
        <div class="ssc-bar-track"><div class="ssc-bar-fill ssb-exp" style="width:${ePct}%"></div></div>
        <span class="ssc-bar-count">${cur.expired}</span>
      </div>
    </div>`;

  // ì›”ë³„ íˆìŠ¤í† ë¦¬ ë°” ì°¨íŠ¸
  renderMonthHistChart('month-hist-wrap-erp');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì›”ë³„ íˆìŠ¤í† ë¦¬ ë°” ì°¨íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMonthHistChart(wrapId){
  const wrap = document.getElementById(wrapId);
  if(!wrap) return;
  wrap.style.display = 'block';
  const hist   = MONTH_HISTORY.slice(-6);
  const maxVal = Math.max(...hist.map(h=>h.active), 1);
  const curYM  = thisYM();

  let html = '<div class="ssc-history-ttl">ğŸ“… ì›”ë³„ í™œì„± êµ¬ë…ì <span style="font-size:.68rem;font-weight:500;color:var(--text3);">ìµœê·¼ 6ê°œì›”</span></div>'
           + '<div class="month-hist-wrap">';
  hist.forEach(h => {
    const barH  = Math.round(h.active / maxVal * 48);
    const isCur = h.ym === curYM;
    html += `<div class="mh-col${isCur?' current':''}">
      <div class="mh-bar-wrap">
        <div class="mh-bar" style="height:${barH}px;"></div>
      </div>
      <div class="mh-num">${h.active}</div>
      <div class="mh-lbl">${monthLabel(h.ym)}</div>
    </div>`;
  });
  html += '</div>';
  wrap.innerHTML = html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íšŒì› ê°œì¸ í˜ì´ì§€ìš© êµ¬ë… í˜„í™© ì¹´ë“œ HTML ìƒì„±
   (member_auth.html ì—ì„œë„ ë™ì¼ ë°ì´í„° ì‚¬ìš©)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildMemberSubStatHTML(myName){
  const cur   = syncMonthHistory();
  const total = cur.total || 1;
  const aPct  = Math.round(cur.active  / total * 100);
  const resetD= nextResetDate();
  const dLeft = Math.ceil((new Date(resetD)-new Date(todayStr()))/86400000);
  const hist  = MONTH_HISTORY.slice(-6);
  const maxV  = Math.max(...hist.map(h=>h.active), 1);
  const curYM = thisYM();

  // íˆìŠ¤í† ë¦¬ ë°” HTML
  let histHtml = hist.map(h => {
    const bH    = Math.round(h.active / maxV * 40);
    const isCur = h.ym === curYM;
    return `<div style="flex-shrink:0;width:46px;background:${isCur?'var(--p5)':'var(--bg)'};border-radius:10px;border:1px solid ${isCur?'var(--p3)':'var(--border)'};padding:7px 4px;text-align:center;">
      <div style="height:40px;display:flex;align-items:flex-end;justify-content:center;margin-bottom:3px;">
        <div style="width:18px;border-radius:3px 3px 0 0;background:${isCur?'linear-gradient(180deg,var(--gm),var(--gd))':'linear-gradient(180deg,var(--p3),var(--p2))'};height:${bH}px;min-height:3px;"></div>
      </div>
      <div style="font-family:'Nanum Myeongjo',serif;font-size:.72rem;font-weight:800;color:${isCur?'var(--gd)':'var(--pm)'};">${h.active}</div>
      <div style="font-size:.56rem;color:var(--text3);margin-top:1px;">${monthLabel(h.ym)}</div>
    </div>`;
  }).join('');

  return `
    <div class="sec-title" style="padding:18px 14px 10px;">ğŸ¢ íšŒì‚¬ ì „ì²´ êµ¬ë… í˜„í™©</div>
    <div style="margin:0 14px 14px;background:linear-gradient(135deg,var(--pd),var(--pm));border-radius:18px;padding:18px;box-shadow:0 6px 24px rgba(58,13,114,0.22);position:relative;overflow:hidden;">
      <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:radial-gradient(circle,rgba(212,168,32,0.15),transparent 70%);pointer-events:none;"></div>

      <!-- í—¤ë” -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div style="background:rgba(212,168,32,0.18);border:1px solid rgba(212,168,32,0.35);border-radius:20px;padding:5px 12px;font-size:.72rem;font-weight:800;color:var(--gb);display:flex;align-items:center;gap:5px;">
          <span class="live-dot"></span>${new Date().getMonth()+1}ì›” êµ¬ë… í˜„í™©
        </div>
        <div style="font-size:.62rem;color:rgba(255,255,255,0.45);text-align:right;line-height:1.6;">
          ë‹¤ìŒ ì •ì‚°<br><strong style="color:var(--gb);">D-${dLeft}</strong>
        </div>
      </div>

      <!-- ë©”ì¸ ìˆ«ì -->
      <div style="margin-bottom:14px;">
        <div style="font-size:.68rem;color:rgba(255,255,255,0.55);margin-bottom:4px;">ì´ë‹¬ í™œì„± êµ¬ë…ì (ì „ì²´)</div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <div style="font-family:'Nanum Myeongjo',serif;font-size:3rem;font-weight:800;color:white;line-height:1;">${cur.active}</div>
          <div style="font-size:1rem;color:rgba(255,255,255,0.7);margin-bottom:5px;">ëª…</div>
          <div style="font-size:.75rem;color:rgba(255,255,255,0.6);margin-bottom:5px;line-height:1.6;">
            ì „ì²´ ${cur.total}ëª… ì¤‘<br><span style="color:#81C784;font-weight:700;">${aPct}% í™œì„±</span>
          </div>
        </div>
      </div>

      <!-- 3ì—´ ì„¸ë¶€ -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">
        <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:10px 8px;text-align:center;">
          <div style="font-family:'Nanum Myeongjo',serif;font-size:1.3rem;font-weight:800;color:#81C784;">${cur.active}</div>
          <div style="font-size:.62rem;color:rgba(255,255,255,0.6);margin-top:2px;">âœ… í™œì„±</div>
        </div>
        <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:10px 8px;text-align:center;">
          <div style="font-family:'Nanum Myeongjo',serif;font-size:1.3rem;font-weight:800;color:#FFCC80;">${cur.warn}</div>
          <div style="font-size:.62rem;color:rgba(255,255,255,0.6);margin-top:2px;">âš ï¸ ì„ë°•</div>
        </div>
        <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:10px 8px;text-align:center;">
          <div style="font-family:'Nanum Myeongjo',serif;font-size:1.3rem;font-weight:800;color:#EF9A9A;">${cur.expired}</div>
          <div style="font-size:.62rem;color:rgba(255,255,255,0.6);margin-top:2px;">âŒ ë§Œë£Œ</div>
        </div>
      </div>

      <!-- ì›”ë³„ íˆìŠ¤í† ë¦¬ -->
      <div style="font-family:'Nanum Myeongjo',serif;font-size:.78rem;font-weight:800;color:rgba(255,255,255,0.7);margin-bottom:8px;">
        ğŸ“… ì›”ë³„ í™œì„± êµ¬ë…ì ì¶”ì´
      </div>
      <div style="display:flex;gap:5px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;">
        ${histHtml}
      </div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ERP: initApp ì´í›„ ì¹´ë“œ ë Œë” íŠ¸ë¦¬ê±°
   â†’ renderKPI ëì—ì„œ í˜¸ì¶œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSubStatIfAdmin(){
  if(!CURRENT_USER) return;
  renderSubStatCard();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íŠ¸ë¦¬ íŒ¨ë„ ë‚´ êµ¬ë… í˜„í™© ì‚½ì…
   openTreePanel í˜¸ì¶œ ì‹œ í•˜ìœ„ì— ì¹´ë“œ ì¶”ê°€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function injectSubStatIntoPanel(){
  // sub-members-wrap ì•„ë˜ì— ì¹´ë“œ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ê°±ì‹ )
  let el = document.getElementById('panel-sub-stat');
  if(!el){
    el = document.createElement('div');
    el.id = 'panel-sub-stat';
    const wrap = document.getElementById('sub-members-wrap');
    if(wrap) wrap.parentNode.insertBefore(el, wrap.nextSibling);
  }
  const isAdmin = CURRENT_USER?.role === 'admin';
  el.innerHTML = buildMemberSubStatHTML('');
}

/* íšŒì› êµ¬ë… í˜„í™© ì¹´ë“œê°€ ê°±ì‹ ë˜ì–´ì•¼ í•  ë•Œë§ˆë‹¤ í˜¸ì¶œ */
function refreshSubStat(){
  syncMonthHistory();
  // ERP ì¹´ë“œ
  if(document.getElementById('sub-stat-wrap')?.style.display !== 'none'){
    renderSubStatCard();
  }
  // íŠ¸ë¦¬ íŒ¨ë„ì´ ì—´ë ¤ ìˆìœ¼ë©´ íŒ¨ë„ë„ ê°±ì‹ 
  if(document.getElementById('tree-panel')?.classList.contains('open')){
    injectSubStatIntoPanel();
  }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ ìƒí’ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ
   - STOCK_DATA ì— ë™ì  ì¶”ê°€/ì‚­ì œ
   - renderStockList()  : ì¬ê³  í˜ì´ì§€ ëª©ë¡ ì „ì²´ ë Œë”
   - syncProductSelects(): ì…ê³ /ì¶œê³  select ë™ê¸°í™”
   - openProdModal()    : ìƒí’ˆ ì¶”ê°€/ê´€ë¦¬ ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* í˜„ì¬ ëª¨ë‹¬ì´ ì–´ëŠ ì‹œíŠ¸(in/out)ì—ì„œ ì—´ë ¸ëŠ”ì§€ */
let _prodModalFrom = 'in';

/* â”€â”€ ì½”ë“œ ìë™ìƒì„± (PRD-001 í˜•ì‹) â”€â”€ */
function genProductCode(){
  const existing = Object.keys(STOCK_DATA);
  let n = existing.length + 1;
  while(STOCK_DATA['PRD-' + String(n).padStart(3,'0')]) n++;
  return 'PRD-' + String(n).padStart(3,'0');
}

/* â”€â”€ ì¬ê³  ëª©ë¡ ì „ì²´ ë Œë” â”€â”€ */
function renderStockList(){
  const wrap = document.getElementById('stock-list-wrap');
  if(!wrap) return;
  const codes = Object.keys(STOCK_DATA);
  if(codes.length === 0){
    wrap.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text3);font-size:.82rem;">ğŸ“¦ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤<br><span style="font-size:.72rem;">ì…ê³  ì‹œíŠ¸ì—ì„œ â• ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”</span></div>';
    return;
  }
  wrap.innerHTML = codes.map(code => {
    const p = STOCK_DATA[code];
    const low  = p.qty < p.safe * 0.5;
    const warn = p.qty < p.safe;
    const pct  = Math.min(100, Math.round(p.qty / p.max * 100));
    const clr  = low ? 'var(--red)' : warn ? 'var(--orange)' : 'var(--green)';
    const barCls = low ? 'bar-d' : warn ? 'bar-w' : 'bar-o';
    const badgeCls = low ? 'red' : warn ? 'orange' : 'green';
    const badgeTxt = low ? 'ë¶€ì¡±' : warn ? 'ì£¼ì˜' : 'ì •ìƒ';
    return `<div class="stock-full-item" onclick="openStockPanel('${code}')">
      <div class="sfi-row">
        <div>
          <div class="sfi-name">${p.name}</div>
          <div class="sfi-code">${code} &nbsp;â†’ íƒ­í•˜ë©´ ìƒì„¸ë³´ê¸°</div>
        </div>
        <div>
          <div class="sfi-qty" id="sqi-${code}" style="color:${clr};font-weight:700;">${p.qty}ê°œ</div>
          <span class="badge ${badgeCls}" id="sqb-${code}">${badgeTxt}</span>
        </div>
      </div>
      <div class="stock-bar-bg">
        <div class="stock-bar ${barCls}" id="sqr-${code}" style="width:${pct}%"></div>
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€ ì…ê³ /ì¶œê³  select ë™ê¸°í™” â”€â”€ */
function syncProductSelects(selectCode){
  ['si-product','so-product','pm-product'].forEach(id => {
    const sel = document.getElementById(id);
    if(!sel) return;
    const isPm = id === 'pm-product';
    const curVal = sel.value;
    sel.innerHTML = (isPm ? '<option value="">â€” ìƒí’ˆ ì„ íƒ â€”</option>' : '');
    Object.keys(STOCK_DATA).forEach(code => {
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = STOCK_DATA[code].name;
      sel.appendChild(opt);
    });
    /* ë°©ê¸ˆ ì¶”ê°€/ì„ íƒëœ ìƒí’ˆìœ¼ë¡œ ìë™ ì„ íƒ */
    if(selectCode && STOCK_DATA[selectCode]){
      sel.value = selectCode;
    } else if(STOCK_DATA[curVal]){
      sel.value = curVal;
    }
  });
  siUpdatePreview();
  soUpdatePreview();
}

/* â”€â”€ ëª¨ë‹¬ ì—´ê¸° â”€â”€ */
function openProdModal(from){
  _prodModalFrom = from || 'in';
  switchProdTab('select');
  syncProductSelects(null);
  /* pm-productë¥¼ í˜„ì¬ ì„ íƒëœ ìƒí’ˆìœ¼ë¡œ ë§ì¶¤ */
  const curSel = document.getElementById(_prodModalFrom==='in' ? 'si-product' : 'so-product');
  const pmSel  = document.getElementById('pm-product');
  if(curSel && pmSel && STOCK_DATA[curSel.value]) pmSel.value = curSel.value;
  pmSelectProduct();
  document.getElementById('prod-modal-overlay').classList.add('open');
}

/* â”€â”€ ëª¨ë‹¬ ë‹«ê¸° â”€â”€ */
function closeProdModal(){
  document.getElementById('prod-modal-overlay').classList.remove('open');
}

/* â”€â”€ íƒ­ ì „í™˜ â”€â”€ */
function switchProdTab(tab){
  document.getElementById('ptab-select').classList.toggle('active', tab==='select');
  document.getElementById('ptab-new').classList.toggle('active',    tab==='new');
  document.getElementById('ppanel-select').style.display = tab==='select' ? '' : 'none';
  document.getElementById('ppanel-new').style.display    = tab==='new'    ? '' : 'none';
  /* ì‹ ê·œ íƒ­: ì…ë ¥ ì´ˆê¸°í™” */
  if(tab==='new'){
    const nn=document.getElementById('np-name'); if(nn) nn.value='';
    const ns=document.getElementById('np-safe'); if(ns) ns.value='20';
    const nm=document.getElementById('np-max');  if(nm) nm.value='200';
    const ne=document.getElementById('np-err');  if(ne) ne.style.display='none';
    setTimeout(()=>{ const el=document.getElementById('np-name'); if(el) el.focus(); }, 80);
  }
}

/* â”€â”€ ê¸°ì¡´ ìƒí’ˆ ì„ íƒ ë¯¸ë¦¬ë³´ê¸° â”€â”€ */
function pmSelectProduct(){
  const code = document.getElementById('pm-product')?.value;
  const prev = document.getElementById('pm-preview');
  if(!code || !STOCK_DATA[code]){ if(prev) prev.style.display='none'; return; }
  const p = STOCK_DATA[code];
  document.getElementById('pm-pname').textContent = p.name;
  document.getElementById('pm-pcode').textContent = code;
  document.getElementById('pm-qty').textContent   = p.qty + 'ê°œ';
  document.getElementById('pm-safe').textContent  = p.safe + 'ê°œ';
  document.getElementById('pm-max').textContent   = p.max + 'ê°œ';
  if(prev) prev.style.display = '';
}

/* â”€â”€ ê¸°ì¡´ ìƒí’ˆìœ¼ë¡œ ì…ê³  ì§„í–‰ â”€â”€ */
function pmApplySelect(){
  const code = document.getElementById('pm-product')?.value;
  if(!code || !STOCK_DATA[code]){
    toast('âŒ ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return;
  }
  const targetSel = document.getElementById(_prodModalFrom==='in' ? 'si-product' : 'so-product');
  if(targetSel) targetSel.value = code;
  siUpdatePreview(); soUpdatePreview();
  closeProdModal();
}

/* â”€â”€ ìƒí’ˆ ì‚­ì œ â”€â”€ */
async function pmDeleteProduct(){
  const code = document.getElementById('pm-product')?.value;
  if(!code || !STOCK_DATA[code]){ toast('âŒ ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  const name = STOCK_DATA[code].name;
  if(!confirm('âš ï¸ [' + name + '] ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì¬ê³  ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

  const { error: delErr } = await supa.from('products').delete().eq('code', code);
  if(delErr){ dbErr('ìƒí’ˆ ì‚­ì œ', delErr); return; }

  delete STOCK_DATA[code];
  renderStockList();
  syncProductSelects(null);
  refreshStockKPI();
  closeProdModal();
  toast('ğŸ—‘ï¸ ' + name + ' ì‚­ì œ ì™„ë£Œ');
}

/* â”€â”€ ì‹ ê·œ ìƒí’ˆ ë“±ë¡ â”€â”€ */
async function submitNewProduct(){
  const nameEl = document.getElementById('np-name');
  const safeEl = document.getElementById('np-safe');
  const maxEl  = document.getElementById('np-max');
  const errEl  = document.getElementById('np-err');

  const name = nameEl?.value.trim() || '';
  const safe = parseInt(safeEl?.value) || 20;
  const max  = parseInt(maxEl?.value)  || 200;

  /* ìœ íš¨ì„± ê²€ì‚¬ */
  if(!name){
    errEl.textContent='âŒ ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'; errEl.style.display='block';
    nameEl?.focus(); return;
  }
  if(name.length < 2){
    errEl.textContent='âŒ ìƒí’ˆëª…ì€ 2ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.'; errEl.style.display='block';
    nameEl?.focus(); return;
  }
  /* ì¤‘ë³µ ì´ë¦„ í™•ì¸ */
  const dupName = Object.values(STOCK_DATA).find(p => p.name === name);
  if(dupName){
    errEl.textContent='âŒ ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤.'; errEl.style.display='block';
    nameEl?.focus(); return;
  }
  if(safe < 1){
    errEl.textContent='âŒ ì•ˆì „ì¬ê³ ëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; errEl.style.display='block'; return;
  }
  if(max < safe){
    errEl.textContent='âŒ ìµœëŒ€ì¬ê³ ëŠ” ì•ˆì „ì¬ê³ ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.'; errEl.style.display='block'; return;
  }
  errEl.style.display='none';

  const code = genProductCode();
  const monthLabels = ['8ì›”','9ì›”','10ì›”','11ì›”','12ì›”','1ì›”'];

  /* DB INSERT */
  const { error: prodErr } = await supa.from('products').insert({ code, name, qty:0, safe, max });
  if(prodErr){ dbErr('ìƒí’ˆ ë“±ë¡', prodErr); return; }

  /* ë©”ëª¨ë¦¬ ë°˜ì˜ */
  STOCK_DATA[code] = {
    name, code, qty:0, safe, max,
    monthly:{ labels:monthLabels, inArr:[0,0,0,0,0,0], outArr:[0,0,0,0,0,0] },
    history:[]
  };

  renderStockList();
  syncProductSelects(code);
  refreshStockKPI();
  closeProdModal();

  const targetSel = document.getElementById(_prodModalFrom==='in' ? 'si-product' : 'so-product');
  if(targetSel){ targetSel.value = code; }
  siUpdatePreview(); soUpdatePreview();
  toast('âœ… [' + name + '] ë“±ë¡ ì™„ë£Œ! ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì…ê³ í•˜ì„¸ìš” ğŸ“¥');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âš™ï¸  ê´€ë¦¬ì ê³„ì • ì„¤ì • ì‹œìŠ¤í…œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* ìœ ì € ë©”ë‰´ ì—´ê¸°/ë‹«ê¸° */
function openUserMenu(e){
  e && e.stopPropagation();
  const menu = document.getElementById('user-menu');
  if(!menu) return;
  const isOpen = menu.classList.contains('open');
  menu.classList.toggle('open', !isOpen);
  if(!isOpen && CURRENT_USER){
    const el_n = document.getElementById('umenu-name');
    const el_i = document.getElementById('umenu-id');
    if(el_n) el_n.textContent = CURRENT_USER.name;
    if(el_i) el_i.textContent = CURRENT_USER.id;
    /* ê´€ë¦¬ìë§Œ ê³„ì • ì„¤ì • í‘œì‹œ */
    const si = document.getElementById('umenu-setting');
    if(si) si.style.display = CURRENT_USER.role==='admin' ? '' : 'none';
  }
}
/* ë°”ê¹¥ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° */
document.addEventListener('click', function(e){
  const menu = document.getElementById('user-menu');
  if(menu && !menu.contains(e.target)){
    const chip = document.querySelector('.user-chip');
    if(!chip || !chip.contains(e.target)) menu.classList.remove('open');
  }
});

/* ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì²´í¬ */
function checkPwStrength(inputEl, barId, txtId){
  const pw  = inputEl.value;
  const bar = document.getElementById(barId);
  const txt = document.getElementById(txtId);
  if(!bar || !txt) return;
  if(!pw){ bar.className='pw-strength-bar'; bar.style.display='none'; txt.style.display='none'; return; }
  let score = 0;
  if(pw.length >= 6)  score++;
  if(pw.length >= 10) score++;
  if(/[A-Z]/.test(pw) || /[0-9]/.test(pw)) score++;
  if(/[^a-zA-Z0-9]/.test(pw)) score++;
  txt.style.display = 'block';
  if(score <= 1){
    bar.className='pw-strength-bar weak';
    txt.textContent='ê°•ë„: ì•½í•¨ â€” ë” ê¸¸ê±°ë‚˜ ìˆ«ì/íŠ¹ìˆ˜ë¬¸ìë¥¼ ì¶”ê°€í•˜ì„¸ìš”';
    txt.style.color='var(--red)';
  } else if(score <= 2){
    bar.className='pw-strength-bar medium';
    txt.textContent='ê°•ë„: ë³´í†µ';
    txt.style.color='var(--orange)';
  } else {
    bar.className='pw-strength-bar strong';
    txt.textContent='ê°•ë„: ê°•í•¨ ğŸ‘';
    txt.style.color='var(--green)';
  }
}

/* ê´€ë¦¬ì ì„¤ì • ì‹œíŠ¸ ì—´ê¸° */
function openAdminSetting(){
  const menu = document.getElementById('user-menu');
  if(menu) menu.classList.remove('open');
  const u = CURRENT_USER;
  if(!u || u.role !== 'admin'){ toast('âŒ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤'); return; }

  /* í˜„ì¬ ì •ë³´ í‘œì‹œ */
  document.getElementById('cur-aid').textContent      = u.id;
  document.getElementById('cur-aname').textContent    = u.name;
  document.getElementById('cur-acontact').textContent = u.contact || 'ë¯¸ì„¤ì •';

  /* ì…ë ¥ í•„ë“œ ì´ˆê¸°ê°’ */
  document.getElementById('new-aid').value      = u.id;
  document.getElementById('new-aname').value    = u.name;
  document.getElementById('new-acontact').value = u.contact || '';
  ['cur-apw','new-apw','new-apw2'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const bar=document.getElementById('pw-sbar'); if(bar){ bar.className='pw-strength-bar'; bar.style.display='none'; }
  const txt=document.getElementById('pw-stxt'); if(txt){ txt.style.display='none'; }
  const err=document.getElementById('as-err'); if(err) err.style.display='none';
  const ok =document.getElementById('as-ok');  if(ok)  ok.style.display='none';

  openSheet('admin-setting');
}

/* ê´€ë¦¬ì ì„¤ì • ì €ì¥ */
async function saveAdminSetting(){
  const errEl = document.getElementById('as-err');
  const okEl  = document.getElementById('as-ok');
  function showErr(msg){ errEl.textContent=msg; errEl.style.display='block'; okEl.style.display='none'; }
  function showOk(msg) { okEl.textContent=msg;  okEl.style.display='block'; errEl.style.display='none'; }

  const newId      = (document.getElementById('new-aid')?.value||'').trim();
  const newName    = (document.getElementById('new-aname')?.value||'').trim();
  const newContact = (document.getElementById('new-acontact')?.value||'').trim();
  const curPw      = document.getElementById('cur-apw')?.value  || '';
  const newPw      = document.getElementById('new-apw')?.value  || '';
  const newPw2     = document.getElementById('new-apw2')?.value || '';
  const u = CURRENT_USER;

  /* â”€â”€ ìœ íš¨ì„± ê²€ì‚¬ â”€â”€ */
  if(!newId || newId.length < 4){
    showErr('âŒ ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return;
  }
  if(/[^a-zA-Z0-9_]/.test(newId)){
    showErr('âŒ ì•„ì´ë””ëŠ” ì˜ë¬¸, ìˆ«ì, _ ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return;
  }
  /* ë‹¤ë¥¸ íšŒì›ê³¼ ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ */
  if(newId !== u.id && ALL_MEMBERS[newId]){
    showErr('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'); return;
  }
  if(!newName){
    showErr('âŒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return;
  }

  /* â”€â”€ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ â”€â”€ */
  if(newPw || curPw || newPw2){
    if(curPw !== u.pw){
      showErr('âŒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return;
    }
    if(newPw.length < 6){
      showErr('âŒ ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return;
    }
    if(newPw !== newPw2){
      showErr('âŒ ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return;
    }
    u.pw = newPw;
  }

  /* â”€â”€ DB UPDATE â”€â”€ */
  const oldId = u.id;
  const updateData = { name:newName, contact:newContact };
  if(newPw && curPw && newPw===newPw2) updateData.pw = newPw;

  if(newId !== oldId){
    /* ì•„ì´ë”” ë³€ê²½: ìƒˆ í–‰ ì‚½ì… í›„ ê¸°ì¡´ í–‰ ì‚­ì œ */
    const { error: insErr } = await supa.from('members').insert({
      id:          newId,
      pw:          updateData.pw || u.pw,
      name:        newName,
      role:        u.role || 'admin',
      contact:     newContact || '',
      referrer_id: u.referrerId || null,
      start_date:  u.startDate  || null,
      end_date:    u.endDate    || null,
      status:      u.status     || 'active',
      depth:       u.depth      || 0,
      depth_label: u.depthLabel || '',
      avatar:      u.avatar     || 'av-purple'
    });
    if(insErr){ dbErr('ê³„ì • ID ë³€ê²½', insErr); return; }
    await supa.from('members').delete().eq('id', oldId);
    ALL_MEMBERS[newId] = u;
    delete ALL_MEMBERS[oldId];
  } else {
    const { error: updErr } = await supa.from('members').update(updateData).eq('id', oldId);
    if(updErr){ dbErr('ê³„ì • ì •ë³´ ìˆ˜ì •', updErr); return; }
  }

  /* â”€â”€ ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸ â”€â”€ */
  u.id      = newId;
  u.name    = newName;
  u.initial = newName[0];
  u.contact = newContact;
  CURRENT_USER = u;

  /* â”€â”€ í—¤ë” UI ê°±ì‹  â”€â”€ */
  const ucAvatar  = document.getElementById('uc-avatar');
  const ucName    = document.getElementById('uc-name');
  const ucRole    = document.getElementById('uc-role');
  if(ucAvatar) ucAvatar.textContent = newName[0];
  if(ucName)   ucName.textContent   = newName;
  if(ucRole)   ucRole.textContent   = t('rolAdmin');

  /* â”€â”€ ì‹œíŠ¸ ë‚´ í˜„ì¬ ì •ë³´ ê°±ì‹  â”€â”€ */
  document.getElementById('cur-aid').textContent      = newId;
  document.getElementById('cur-aname').textContent    = newName;
  document.getElementById('cur-acontact').textContent = newContact || 'ë¯¸ì„¤ì •';

  showOk('âœ… ì €ì¥ ì™„ë£Œ! ìƒˆ ì•„ì´ë””: ' + newId);
  toast('âœ… ê³„ì • ì •ë³´ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤');
  setTimeout(()=> closeSheet('admin-setting'), 1400);
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ í™œë™ê¸°ë¡ + â­ ë§Œì¡±ë„ í‰ê°€ + ğŸ“Š ê´€ë¦¬ì ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ
   ë°ì´í„° êµ¬ì¡°:
   ALL_MEMBERS[id].activities = {
     online:  [{date,time,place,attend,memo,ts},...],
     visit:   [...],
     seminar: [...]
   }
   ALL_MEMBERS[id].ratings = [{level,reason,date,ts},...] (ìµœì‹ ìˆœ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* í˜„ì¬ í™œë™ ì…ë ¥ ì¤‘ì¸ ìœ í˜• */
let _curActType = 'online';
let _curAttend  = 'attend';

/* â”€â”€ í™œë™ ìœ í˜• ë©”íƒ€ â”€â”€ */
const ACT_META = {
  online:  { label:'í™”ìƒ êµìœ¡',   icon:'ğŸ¥' },
  visit:   { label:'ì„¼í„° ë°©ë¬¸',   icon:'ğŸ¢' },
  seminar: { label:'ì˜¤í”ˆ ì„¸ë¯¸ë‚˜', icon:'ğŸ¤' },
};

/* â”€â”€ íšŒì› ë°ì´í„°ì— activities/ratings ì´ˆê¸°í™” â”€â”€ */
function ensureMemberData(id){
  const m = ALL_MEMBERS[id];
  if(!m) return null;
  if(!m.activities) m.activities = { online:[], visit:[], seminar:[] };
  if(!m.ratings)    m.ratings    = [];
  return m;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ í™œë™ í˜ì´ì§€ ë Œë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderActivityPage(){
  const isAdmin = CURRENT_USER?.role === 'admin';
  document.getElementById('act-member-view').style.display = isAdmin ? 'none' : '';
  document.getElementById('act-admin-view').style.display  = isAdmin ? '' : 'none';

  if(isAdmin){
    renderAdminReport();
  } else {
    const m = ensureMemberData(CURRENT_USER?.id);
    if(!m) return;
    renderActList('online',  m.activities.online);
    renderActList('visit',   m.activities.visit);
    renderActList('seminar', m.activities.seminar);
  }
}

/* â”€â”€ í™œë™ ëª©ë¡ ë Œë” (íšŒì›ìš©) â”€â”€ */
function renderActList(type, arr){
  const wrap = document.getElementById('list-' + type);
  const cnt  = document.getElementById('cnt-' + type);
  if(!wrap) return;
  if(cnt) cnt.textContent = arr.length + 'ê±´';
  if(!arr.length){
    wrap.innerHTML = '<div class="act-empty-box">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”</div>';
    return;
  }
  wrap.innerHTML = [...arr].reverse().map((r,ri) => {
    const realIdx = arr.length - 1 - ri;
    const attendTag = r.attend==='attend'
      ? '<span class="act-tag act-tag-attend">âœ… ì°¸ì„</span>'
      : '<span class="act-tag act-tag-absent">âŒ ë¶ˆì°¸</span>';
    return `<div class="act-item">
      <button class="act-del-btn" onclick="deleteActRecord('${type}',${realIdx})">âœ•</button>
      <div class="act-item-meta">
        ${attendTag}
        <span class="act-tag act-tag-date">ğŸ“… ${r.date}${r.time?' '+r.time:''}</span>
        ${r.place?`<span class="act-tag act-tag-place">ğŸ“ ${r.place}</span>`:''}
      </div>
      ${r.memo?`<div class="act-item-memo">${r.memo}</div>`:''}
    </div>`;
  }).join('');
}

/* â”€â”€ í™œë™ ì…ë ¥ ì‹œíŠ¸ ì—´ê¸° â”€â”€ */
function openActSheet(type){
  _curActType = type;
  _curAttend  = 'attend';
  const meta  = ACT_META[type];
  document.getElementById('act-sheet-title').textContent = meta.icon + ' ' + meta.label + ' ê¸°ë¡ ì¶”ê°€';

  /* ë²„íŠ¼ ì´ˆê¸°í™” */
  setAttend('attend');

  /* ë‚ ì§œ ê¸°ë³¸ê°’ */
  const today = new Date().toISOString().split('T')[0];
  const dEl = document.getElementById('act-date'); if(dEl) dEl.value = today;
  const tEl = document.getElementById('act-time'); if(tEl) tEl.value = '';
  const pEl = document.getElementById('act-place'); if(pEl) pEl.value = '';
  const mEl = document.getElementById('act-memo'); if(mEl) mEl.value = '';
  const eEl = document.getElementById('act-err'); if(eEl) eEl.style.display='none';
  openSheet('act-input');
}

/* â”€â”€ ì°¸ì„/ë¶ˆì°¸ ì„ íƒ â”€â”€ */
function setAttend(val){
  _curAttend = val;
  const bA = document.getElementById('abtn-attend');
  const bB = document.getElementById('abtn-absent');
  if(bA){ bA.style.borderColor = val==='attend'?'var(--green)':'var(--border)';
          bA.style.background  = val==='attend'?'rgba(46,125,50,.08)':'var(--card)';
          bA.style.color       = val==='attend'?'var(--green)':'var(--text)'; }
  if(bB){ bB.style.borderColor = val==='absent'?'var(--red)':'var(--border)';
          bB.style.background  = val==='absent'?'rgba(211,47,47,.06)':'var(--card)';
          bB.style.color       = val==='absent'?'var(--red)':'var(--text)'; }
}

/* â”€â”€ í™œë™ ê¸°ë¡ ì €ì¥ â”€â”€ */
async function submitActRecord(){
  const date  = document.getElementById('act-date')?.value  || '';
  const time  = document.getElementById('act-time')?.value  || '';
  const place = document.getElementById('act-place')?.value.trim() || '';
  const memo  = document.getElementById('act-memo')?.value.trim()  || '';
  const errEl = document.getElementById('act-err');

  if(!date){ errEl.textContent='âŒ ì¼ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.'; errEl.style.display='block'; return; }
  errEl.style.display='none';

  const m = ensureMemberData(CURRENT_USER?.id);
  if(!m) return;

  /* DB INSERT */
  const { data: actData, error: actErr } = await supa.from('activities').insert({
    member_id: CURRENT_USER.id,
    type:      _curActType,
    attend:    _curAttend,
    date, time, place, memo
  }).select().single();
  if(actErr){ dbErr('í™œë™ ê¸°ë¡ ì €ì¥', actErr); return; }

  m.activities[_curActType].push({
    id: actData?.id, date, time, place, attend:_curAttend, memo
  });

  closeSheet('act-input');
  renderActList(_curActType, m.activities[_curActType]);
  toast(ACT_META[_curActType].icon + ' ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

/* â”€â”€ í™œë™ ê¸°ë¡ ì‚­ì œ â”€â”€ */
async function deleteActRecord(type, idx){
  const m = ensureMemberData(CURRENT_USER?.id);
  if(!m) return;
  const record = m.activities[type][idx];
  if(record?.id){
    const { error } = await supa.from('activities').delete().eq('id', record.id);
    if(error){ dbErr('í™œë™ ì‚­ì œ', error); return; }
  }
  m.activities[type].splice(idx, 1);
  renderActList(type, m.activities[type]);
  toast('ğŸ—‘ï¸ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â­ ë§Œì¡±ë„ í‰ê°€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _curRating = '';

function selectRating(val){
  _curRating = val;
  ['great','good','bad'].forEach(r => {
    const el = document.getElementById('ropt-'+r);
    if(!el) return;
    el.className = 'rating-opt' + (r===val ? ' sel-'+r : '');
  });
}

async function submitRating(){
  const errEl  = document.getElementById('rating-err');
  const reason = document.getElementById('rating-reason')?.value.trim() || '';

  if(!_curRating){
    errEl.textContent='âŒ ë§Œì¡±ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'; errEl.style.display='block'; return;
  }
  errEl.style.display='none';

  const m = ensureMemberData(CURRENT_USER?.id);
  if(!m) return;

  const today = new Date().toISOString().split('T')[0];

  /* DB INSERT */
  const { data: rData, error: rErr } = await supa.from('ratings').insert({
    member_id: CURRENT_USER.id,
    level:     _curRating,
    reason,
    date:      today
  }).select().single();
  if(rErr){ dbErr('í‰ê°€ ì €ì¥', rErr); return; }

  m.ratings.unshift({ id:rData?.id, level:_curRating, reason, date:today });

  _curRating = '';
  ['great','good','bad'].forEach(r => {
    const el = document.getElementById('ropt-'+r);
    if(el) el.className = 'rating-opt';
  });
  const rEl = document.getElementById('rating-reason');
  if(rEl) rEl.value = '';

  renderMyRatingHist(m.ratings);
  toast('â­ í‰ê°€í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!');
}

function renderMyRatingHist(arr){
  const wrap = document.getElementById('my-rating-hist');
  if(!wrap) return;
  if(!arr.length){
    wrap.innerHTML='<div class="act-empty-box">ì•„ì§ í‰ê°€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return;
  }
  const labelMap = { great:'ğŸ˜„ ë§¤ìš° ë§Œì¡±', good:'ğŸ™‚ ë§Œì¡±', bad:'ğŸ˜ ë¶ˆë§Œì¡±' };
  wrap.innerHTML = arr.map(r => `
    <div class="rating-hist-item">
      <div class="rating-hist-top">
        <span class="r-badge rb-${r.level}">${labelMap[r.level]}</span>
        <span class="r-date">ğŸ“… ${r.date}</span>
      </div>
      ${r.reason?`<div class="r-reason">"${r.reason}"</div>`:''}
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“Š ê´€ë¦¬ì ë¦¬í¬íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAdminReport(){
  const members = Object.values(ALL_MEMBERS).filter(m => m.role !== 'admin');

  /* ì „ì²´ í†µê³„ ê³„ì‚° */
  let totalAct=0, ratedCnt=0, greatCnt=0, goodCnt=0, badCnt=0;
  const badComments = [];

  members.forEach(m => {
    ensureMemberData(m.id);
    const acts = m.activities;
    totalAct += (acts.online?.length||0) + (acts.visit?.length||0) + (acts.seminar?.length||0);
    if(m.ratings?.length){
      m.ratings.forEach(r => {
        ratedCnt++;
        if(r.level==='great') greatCnt++;
        else if(r.level==='good') goodCnt++;
        else if(r.level==='bad'){
          badCnt++;
          if(r.reason) badComments.push({ name:m.name, reason:r.reason, date:r.date });
        }
      });
    }
  });

  /* ìˆ˜ì¹˜ í‘œì‹œ */
  document.getElementById('rpt-total-act').textContent  = totalAct;
  document.getElementById('rpt-rated-cnt').textContent  = ratedCnt;
  const satPct = ratedCnt ? Math.round((greatCnt+goodCnt)/ratedCnt*100) : 0;
  document.getElementById('rpt-satisfy-pct').textContent = ratedCnt ? satPct+'%' : 'â€”';

  /* ë§Œì¡±ë„ ë°” */
  const total = ratedCnt || 1;
  document.getElementById('rbar-great').style.width = Math.round(greatCnt/total*100)+'%';
  document.getElementById('rbar-good').style.width  = Math.round(goodCnt/total*100)+'%';
  document.getElementById('rbar-bad').style.width   = Math.round(badCnt/total*100)+'%';
  document.getElementById('rpct-great').textContent = greatCnt+'ê±´';
  document.getElementById('rpct-good').textContent  = goodCnt+'ê±´';
  document.getElementById('rpct-bad').textContent   = badCnt+'ê±´';

  /* ë¶ˆë§Œì¡± ì˜ê²¬ */
  const badWrap = document.getElementById('rpt-bad-comments');
  if(badWrap){
    if(!badComments.length){
      badWrap.innerHTML='<div class="act-empty-box">ë¶ˆë§Œì¡± ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‘</div>';
    } else {
      badWrap.innerHTML = badComments.map(c=>`
        <div class="rating-hist-item">
          <div class="rating-hist-top">
            <span class="r-badge rb-bad">ğŸ˜ ${c.name}</span>
            <span class="r-date">ğŸ“… ${c.date}</span>
          </div>
          <div class="r-reason">"${c.reason}"</div>
        </div>`).join('');
    }
  }

  /* íšŒì›ë³„ í˜„í™© */
  const listWrap = document.getElementById('rpt-member-list');
  if(listWrap){
    if(!members.length){
      listWrap.innerHTML='<div class="act-empty-box">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      const labelMap = { great:'ğŸ˜„ ë§¤ìš°ë§Œì¡±', good:'ğŸ™‚ ë§Œì¡±', bad:'ğŸ˜ ë¶ˆë§Œì¡±' };
      listWrap.innerHTML = members.map(m => {
        ensureMemberData(m.id);
        const onCnt  = m.activities.online?.length  || 0;
        const viCnt  = m.activities.visit?.length   || 0;
        const seCnt  = m.activities.seminar?.length || 0;
        const total  = onCnt + viCnt + seCnt;
        const lastR  = m.ratings?.[0];
        const ratingHtml = lastR
          ? `<span class="r-badge rb-${lastR.level}" style="font-size:.62rem;">${labelMap[lastR.level]}</span>`
          : '<span style="font-size:.68rem;color:var(--text3);">ë¯¸í‰ê°€</span>';
        return `<div class="rpt-member-item" onclick="openRptDetail('${m.id}')">
          <div class="rpt-mi-top">
            <span class="rpt-mi-name">${m.name}</span>
            <div class="rpt-mi-acts">
              ${onCnt?`<span class="rpt-mi-act-tag">ğŸ¥${onCnt}</span>`:''}
              ${viCnt?`<span class="rpt-mi-act-tag">ğŸ¢${viCnt}</span>`:''}
              ${seCnt?`<span class="rpt-mi-act-tag">ğŸ¤${seCnt}</span>`:''}
              ${!total?'<span style="font-size:.68rem;color:var(--text3);">í™œë™ì—†ìŒ</span>':''}
            </div>
          </div>
          <div class="rpt-mi-sub">
            ${m.contact||''} Â· êµ¬ë… ${m.endDate||''}
          </div>
          <div class="rpt-mi-rating">ìµœê·¼ í‰ê°€: ${ratingHtml}</div>
        </div>`;
      }).join('');
    }
  }
}

/* â”€â”€ ê´€ë¦¬ì: íšŒì› í™œë™ ìƒì„¸ íŒ¨ë„ â”€â”€ */
function openRptDetail(memberId){
  const m = ensureMemberData(memberId);
  if(!m) return;
  document.getElementById('rpt-detail-name').textContent = m.name + ' ë‹˜ì˜ í™œë™ ìƒì„¸';

  const labelMap = { great:'ğŸ˜„ ë§¤ìš° ë§Œì¡±', good:'ğŸ™‚ ë§Œì¡±', bad:'ğŸ˜ ë¶ˆë§Œì¡±' };
  let body = '';

  /* í™œë™ ê¸°ë¡ */
  Object.entries(ACT_META).forEach(([type, meta]) => {
    const arr = m.activities[type] || [];
    body += `<div style="margin-bottom:16px;">
      <div style="font-size:.82rem;font-weight:800;color:var(--pm);margin-bottom:8px;">
        ${meta.icon} ${meta.label} <span style="font-size:.68rem;color:var(--text3);">${arr.length}ê±´</span>
      </div>`;
    if(!arr.length){
      body += '<div class="act-empty-box" style="padding:10px;">ê¸°ë¡ ì—†ìŒ</div>';
    } else {
      body += [...arr].reverse().map(r => {
        const attendTag = r.attend==='attend'
          ? '<span class="act-tag act-tag-attend">âœ… ì°¸ì„</span>'
          : '<span class="act-tag act-tag-absent">âŒ ë¶ˆì°¸</span>';
        return `<div class="act-item" style="margin-bottom:6px;">
          <div class="act-item-meta">
            ${attendTag}
            <span class="act-tag act-tag-date">ğŸ“… ${r.date}${r.time?' '+r.time:''}</span>
            ${r.place?`<span class="act-tag act-tag-place">ğŸ“ ${r.place}</span>`:''}
          </div>
          ${r.memo?`<div class="act-item-memo">${r.memo}</div>`:''}
        </div>`;
      }).join('');
    }
    body += '</div>';
  });

  /* í‰ê°€ ì´ë ¥ */
  body += `<div style="margin-top:4px;">
    <div style="font-size:.82rem;font-weight:800;color:var(--pm);margin-bottom:8px;">
      â­ í‰ê°€ ì´ë ¥ <span style="font-size:.68rem;color:var(--text3);">${m.ratings.length}ê±´</span>
    </div>`;
  if(!m.ratings.length){
    body += '<div class="act-empty-box" style="padding:10px;">í‰ê°€ ì—†ìŒ</div>';
  } else {
    body += m.ratings.map(r => `
      <div class="rating-hist-item">
        <div class="rating-hist-top">
          <span class="r-badge rb-${r.level}">${labelMap[r.level]}</span>
          <span class="r-date">ğŸ“… ${r.date}</span>
        </div>
        ${r.reason?`<div class="r-reason">"${r.reason}"</div>`:''}
      </div>`).join('');
  }
  body += '</div>';

  document.getElementById('rpt-detail-body').innerHTML = body;
  document.getElementById('rpt-detail-overlay').classList.add('open');
}

function closeRptDetail(){
  document.getElementById('rpt-detail-overlay').classList.remove('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   showTab ì—°ë™ â€” íƒ­ ì „í™˜ ì‹œ ë Œë” í˜¸ì¶œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì¬ê³  ìƒì„¸ íŒ¨ë„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sp-overlay" id="sp-overlay" onclick="closeStockPanel()"></div>
<div class="sp-panel" id="sp-panel">

  <!-- í—¤ë” -->
  <div class="sp-head">
    <div class="sp-head-row">
      <div class="sp-back-btn" onclick="closeStockPanel()">â† ë’¤ë¡œ</div>
      <div style="flex:1;min-width:0;">
        <div class="sp-head-name" id="sp-pname">ìƒí’ˆëª…</div>
        <div class="sp-head-code" id="sp-pcode">ì½”ë“œ</div>
      </div>
    </div>
    <div class="sp-gauge">
      <div class="sp-gauge-top">
        <div>
          <div style="font-size:.66rem;color:rgba(255,255,255,0.5);margin-bottom:3px;">í˜„ì¬ ì¬ê³ </div>
          <div class="sp-big-num" id="sp-bignum" style="color:white;">â€”</div>
        </div>
        <div class="sp-gauge-right">
          <div class="sp-safe-txt" id="sp-safetxt">ì•ˆì „ì¬ê³ : â€”ê°œ</div>
          <div id="sp-badge"></div>
        </div>
      </div>
      <div class="sp-bar-track"><div class="sp-bar-fill" id="sp-fill" style="width:0%;"></div></div>
      <div class="sp-gauge-foot">
        <span id="sp-statustxt">â€”</span>
        <span id="sp-maxtxt">ìµœëŒ€ â€”ê°œ</span>
      </div>
    </div>
  </div>

  <!-- ì…ê³ /ì¶œê³  ë²„íŠ¼ -->
  <div class="sp-acts">
    <button class="sp-act sp-act-in" onclick="spOpenIn()">
      <span class="sp-act-em">ğŸ“¥</span>ì…ê³  ë“±ë¡
    </button>
    <button class="sp-act sp-act-out" onclick="spOpenOut()">
      <span class="sp-act-em">ğŸ“¤</span>ì¶œê³  ë“±ë¡
    </button>
  </div>

  <!-- ìˆ˜ëŸ‰ ì§ì ‘ ì¡°ì • -->
  <div class="sp-sec">
    <div class="sp-sec-ttl">ğŸ”§ ìˆ˜ëŸ‰ ì§ì ‘ ì¡°ì •</div>
    <div class="qty-row">
      <button class="qty-pm m" onclick="spAdjust(-1)">âˆ’</button>
      <input  class="qty-num" id="sp-qtyinput" type="number" value="0" min="0">
      <button class="qty-pm p" onclick="spAdjust(+1)">ï¼‹</button>
      <button class="qty-apply" onclick="spApply()">ì ìš©</button>
    </div>
  </div>

  <!-- ì›”ë³„ ì°¨íŠ¸ -->
  <div class="sp-sec">
    <div class="sp-sec-ttl">ğŸ“Š ìµœê·¼ 6ê°œì›” ì…ì¶œê³ </div>
    <div class="sp-chart">
      <div class="chart-bars" id="sp-chartbars"></div>
      <div class="chart-legend">
        <div class="cl-item"><div class="cl-dot" style="background:var(--gm);"></div>ì…ê³ </div>
        <div class="cl-item"><div class="cl-dot" style="background:var(--p3);"></div>ì¶œê³ </div>
      </div>
    </div>
  </div>

  <!-- ì…ì¶œê³  ì´ë ¥ -->
  <div class="sp-sec">
    <div class="sp-sec-ttl">ğŸ“‹ ì…ì¶œê³  ì´ë ¥</div>
    <div class="hist-list" id="sp-histlist"></div>
  </div>

  <div style="height:20px;"></div>
</div>


<!-- â•â•â•â• ì‹ ê·œ ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬ â•â•â•â• -->
<div class="prod-modal-overlay" id="prod-modal-overlay" onclick="if(event.target===this)closeProdModal()">
  <div class="prod-modal">
    <div class="prod-modal-title">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</div>

    <!-- íƒ­: ê¸°ì¡´/ì‹ ê·œ -->
    <div class="prod-tabs">
      <button class="prod-tab active" id="ptab-select" onclick="switchProdTab('select')">ê¸°ì¡´ ìƒí’ˆ ì„ íƒ</button>
      <button class="prod-tab"        id="ptab-new"    onclick="switchProdTab('new')">â• ì‹ ê·œ ìƒí’ˆ ì¶”ê°€</button>
    </div>

    <!-- ê¸°ì¡´ ìƒí’ˆ ì„ íƒ íŒ¨ë„ -->
    <div id="ppanel-select">
      <label class="form-label">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</label>
      <select class="form-select" id="pm-product" onchange="pmSelectProduct()">
        <option value="">â€” ìƒí’ˆ ì„ íƒ â€”</option>
      </select>
      <div id="pm-preview" style="display:none;
        background:var(--p5);border:1px solid var(--border);border-radius:10px;
        padding:12px 14px;margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:.8rem;font-weight:700;color:var(--pm);" id="pm-pname">â€”</span>
          <span style="font-size:.72rem;color:var(--text3);" id="pm-pcode">â€”</span>
        </div>
        <div style="display:flex;gap:16px;">
          <div style="text-align:center;">
            <div style="font-size:.62rem;color:var(--text3);">í˜„ì¬ì¬ê³ </div>
            <div style="font-size:1rem;font-weight:800;color:var(--pm);" id="pm-qty">â€”</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:.62rem;color:var(--text3);">ì•ˆì „ì¬ê³ </div>
            <div style="font-size:1rem;font-weight:800;color:var(--orange);" id="pm-safe">â€”</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:.62rem;color:var(--text3);">ìµœëŒ€ì¬ê³ </div>
            <div style="font-size:1rem;font-weight:800;color:var(--text2);" id="pm-max">â€”</div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn-full" style="flex:1;" onclick="pmApplySelect()">âœ… ì´ ìƒí’ˆìœ¼ë¡œ ì…ê³ </button>
        <button class="btn-full" style="flex:1;background:var(--red);" onclick="pmDeleteProduct()">ğŸ—‘ï¸ ì‚­ì œ</button>
      </div>
    </div>

    <!-- ì‹ ê·œ ìƒí’ˆ ì¶”ê°€ íŒ¨ë„ -->
    <div id="ppanel-new" style="display:none;">
      <div class="prod-hint">
        ğŸ’¡ ìƒí’ˆëª…ì€ í•„ìˆ˜, ì•ˆì „ì¬ê³ /ìµœëŒ€ì¬ê³ ëŠ” ê¸°ë³¸ê°’(20/200)ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
      </div>
      <label class="form-label">ìƒí’ˆëª… *</label>
      <input class="form-input" type="text" id="np-name" placeholder="ì˜ˆ) í”„ë¦¬ë¯¸ì—„ ì˜¤ë©”ê°€3" maxlength="30">
      <div class="form-row" style="margin-top:0;">
        <div>
          <label class="form-label">ì•ˆì „ì¬ê³  (ë¶€ì¡± ê¸°ì¤€)</label>
          <input class="form-input" type="number" id="np-safe" placeholder="20" min="1" value="20">
        </div>
        <div>
          <label class="form-label">ìµœëŒ€ì¬ê³  (100% ê¸°ì¤€)</label>
          <input class="form-input" type="number" id="np-max" placeholder="200" min="1" value="200">
        </div>
      </div>
      <div id="np-err" style="font-size:.75rem;color:var(--red);margin:-4px 0 10px;display:none;"></div>
      <button class="btn-full btn-gold" onclick="submitNewProduct()">ğŸ“¦ ìƒí’ˆ ë“±ë¡ í›„ ì…ê³  ì§„í–‰</button>
    </div>

    <div style="margin-top:10px;">
      <button class="btn-full" style="background:transparent;color:var(--text3);border:1px solid var(--border);" onclick="closeProdModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

</body>
</html>
